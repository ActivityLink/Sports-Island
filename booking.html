<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>預約報名 - 運動島</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .main-container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 140px; }
        .content-card { background: white; border-radius: 32px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.04); padding: 28px; margin-bottom: 20px; border: 1px solid #f1f5f9; }
        .selection-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 20px; border-radius: 20px; border: 2px solid transparent; cursor: pointer; transition: 0.3s; }
        .selection-item.active { border-color: #1877f2; background: #eef2ff; }
        .btn-blue { background: #1877f2; color: white; padding: 18px 40px; border-radius: 20px; font-weight: 900; width: 100%; text-align: center; font-size: 18px; box-shadow: 0 10px 20px -5px rgba(24,119,242,0.3); }
        .sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-top: 1px solid #f1f5f9; padding: 20px; z-index: 100; }
    </style>
</head>
<body>

    <div id="view-loading" class="fixed inset-0 bg-white z-[2000] flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-[#1877f2] border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-black text-slate-400 text-xs tracking-widest uppercase italic">運動島智能排課中...</p>
    </div>

    <div class="main-container">
        <div id="view-member" class="hidden">
            <h2 class="text-3xl font-black mb-10 italic tracking-tight">選擇預約學員</h2>
            <div id="member-list" class="space-y-4"></div>
        </div>

        <div id="view-details" class="hidden">
            <div class="content-card">
                <h2 id="event-name" class="text-2xl font-black text-slate-800 italic leading-tight">載入中...</h2>
                <span id="event-type-badge" class="inline-block mt-2 text-[10px] font-black bg-[#1877f2] text-white px-3 py-1 rounded-full uppercase tracking-tighter">SPEC</span>
                <div id="dynamic-booking-ui" class="mt-10 min-h-[200px]"></div>
            </div>
            <button onclick="switchView('member')" class="w-full text-slate-400 font-bold text-xs uppercase mt-4">⬅ 返回重新選擇學員</button>
        </div>

        <div id="view-checkout" class="hidden text-center">
            <div class="content-card">
                <h2 class="text-2xl font-black mb-8 italic text-slate-800">最後確認</h2>
                <div class="bg-blue-50 p-8 rounded-3xl text-center mb-8 border border-blue-100">
                    <p class="text-xs font-black text-[#1877f2] mb-2 uppercase tracking-widest">應付學費總額</p>
                    <p id="final-amount" class="text-4xl font-black text-[#1877f2] italic">NT$ 0</p>
                </div>
                <input type="text" id="bank-5" class="w-full border-2 border-slate-100 p-5 rounded-2xl mb-8 text-center font-black text-2xl" maxlength="5" placeholder="匯款帳號後五碼">
                <button onclick="submitBooking()" id="btn-submit" class="btn-blue">確認並送出預約 ➜</button>
            </div>
        </div>
    </div>

    <div id="footer-bar" class="sticky-footer flex items-center justify-between hidden">
        <div><p class="text-[10px] font-black text-slate-400">目前金額</p><p id="footer-price" class="text-xl font-black text-[#1877f2] italic">NT$ 0</p></div>
        <button onclick="switchView('checkout')" class="bg-[#1877f2] text-white px-10 py-4 rounded-2xl font-black text-sm">下一步 ➜</button>
    </div>

    <script>
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        const eventId = new URLSearchParams(window.location.search).get('id');
        let state = { uid: null, event: null, members: [], selectedMember: null, selectedBatch: null };

        function safeNavigate(t) {
            const targetUrl = new URL(t, window.location.href).href;
            window.location.replace(targetUrl);
        }

        async function init() {
            try {
                await liff.init({ liffId: "2008786875-7COWtgtL" });
                if (!liff.isLoggedIn() && liff.isInClient()) { liff.login(); return; }
                const profile = await liff.getProfile();
                state.uid = profile.userId;

                const [evRes, memRes] = await Promise.all([
                    fetch(`${PROXY_URL}?action=getEvents`),
                    fetch(`${PROXY_URL}?action=getFamily&uid=${state.uid}`)
                ]);
                const evData = await evRes.json();
                
                // ✨ 修復核心：先確認資料存在才進行屬性讀取
                if (!evData || !evData.data) throw new Error("Activity data error");
                state.event = evData.data.find(e => String(e['活動ID']) === String(eventId));
                
                if (!state.event) {
                    alert("找不到課程資料，將返回首頁");
                    safeNavigate('index.html');
                    return;
                }

                state.members = (await memRes.json()).data || [];
                document.getElementById('event-name').innerText = state.event['活動名稱'];
                document.getElementById('event-type-badge').innerText = state.event['活動型態'];
                document.getElementById('footer-price').innerText = `NT$ ${parseInt(state.event['全日價']).toLocaleString()}`;
                
                renderMembers();
                switchView('member');
            } catch (e) {
                console.error(e);
            } finally {
                document.getElementById('view-loading').style.display='none';
            }
        }

        function renderMembers() {
            document.getElementById('member-list').innerHTML = state.members.map(m => `
                <div onclick="selectMember('${m.學員ID}')" class="selection-item">
                    <div class="flex items-center gap-4"><div class="w-12 h-12 bg-blue-50 text-[#1877f2] rounded-2xl flex items-center justify-center font-black italic shadow-inner">${(m.姓名||"?").charAt(0)}</div><p class="font-black text-xl text-slate-800">${m.姓名}</p></div>
                    <span class="text-[#1877f2] font-black italic text-xs">SELECT ➜</span>
                </div>`).join('');
        }

        function selectMember(id) {
            state.selectedMember = state.members.find(m => String(m.學員ID) === id);
            renderSpecializedUI();
            switchView('details');
        }

        function renderSpecializedUI() {
            const container = document.getElementById('dynamic-booking-ui');
            const type = state.event['活動型態'];
            if(type === '梯次型') {
                const batches = JSON.parse(state.event['梯次資料'] || "[]");
                container.innerHTML = batches.map(b => `
                    <div onclick="state.selectedBatch='${b.n}'; this.parentNode.querySelectorAll('div').forEach(d=>d.classList.remove('active')); this.classList.add('active');" class="selection-item mb-3">
                        <div class="text-left"><p class="font-black text-xl text-slate-800">${b.n}</p><p class="text-xs text-slate-400 italic">${b.s.substring(5,16).replace('T',' ')} 起</p></div>
                        <span class="bg-blue-50 text-[#1877f2] px-4 py-2 rounded-xl text-xs font-black">選取</span>
                    </div>`).join('');
            } else {
                container.innerHTML = `<div class="bg-blue-50 p-8 rounded-3xl border-2 border-blue-100 text-center"><p class="text-blue-800 font-bold">單日/常態課程報名</p><p class="text-xs text-blue-400 mt-2">${state.event['開始日期']}</p></div>`;
                state.selectedBatch = "一般預約";
            }
            document.getElementById('final-amount').innerText = `NT$ ${parseInt(state.event['全日價']).toLocaleString()}`;
        }

        function switchView(v) { 
            ['member', 'details', 'checkout'].forEach(i => document.getElementById('view-' + i).classList.toggle('hidden', i !== v));
            document.getElementById('footer-bar').classList.toggle('hidden', v !== 'details');
            window.scrollTo(0,0);
        }

        async function submitBooking() {
            const b5 = document.getElementById('bank-5').value;
            if(b5.length < 5) return alert("請輸入正確匯款後五碼");
            const btn = document.getElementById('btn-submit'); btn.disabled = true; btn.innerText = "傳送中...";
            const payload = { student: state.selectedMember, eventId: state.event['活動ID'], eventName: state.event['活動名稱'], amount: parseInt(state.event['全日價']), bankLast5: b5, selectedBatch: state.selectedBatch };
            const res = await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify({ action: 'submitRegistration', payload }) });
            if((await res.json()).status === 'success') { alert("預約成功！"); safeNavigate('index.html'); }
        }
        window.onload = init;
    </script>
</body>
</html>
