<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é ç´„å ±å - é‹å‹•å³¶</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding-bottom: 50px; }
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .card { background: white; border: 1px solid #dcdfe6; border-radius: 4px; margin-bottom: 15px; overflow: hidden; }
        .card-header { padding: 12px 15px; border-bottom: 1px solid #ebeef5; background: #fbfbfc; font-weight: 700; font-size: 15px; }
        .card-body { padding: 15px; }
        .member-item { display: flex; align-items: center; padding: 12px; border: 1px solid #eee; border-radius: 4px; margin-bottom: 8px; cursor: pointer; transition: 0.2s; }
        .member-item.active { border-color: #409eff; background: #ecf5ff; }
        .member-item.disabled { opacity: 0.5; cursor: not-allowed; background: #f5f7fa; }
        .info-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 14px; }
        .status-tag { padding: 2px 6px; border-radius: 3px; font-size: 10px; font-weight: 700; }
        .tag-red { background: #fee2e2; color: #b91c1c; }
    </style>
</head>
<body>

    <div id="view-loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
        <p class="text-gray-400 text-sm">æ ¸å°é ç´„è³‡æ ¼ä¸­...</p>
    </div>

    <div class="container">
        <!-- é ‚éƒ¨æ´»å‹•æ‘˜è¦ -->
        <div class="card">
            <div class="card-header"><span id="ev-name-disp">æ´»å‹•è¼‰å…¥ä¸­...</span></div>
            <div class="card-body">
                <div class="info-row"><span class="text-gray-400">æ´»å‹•æ—¥æœŸ</span><span id="disp-date" class="font-bold">--</span></div>
                <div class="info-row"><span class="text-gray-400">å‰©é¤˜åé¡</span><span id="disp-quota" class="font-bold text-blue-600">--</span></div>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 1: é¸æ“‡å­¸å“¡ä¸¦è‡ªå‹•å¯©æ ¸ -->
        <div id="step-1" class="card">
            <div class="card-header">1. é¸æ“‡é ç´„æˆå“¡</div>
            <div id="member-list" class="card-body">
                <!-- ç”± JS ç”¢ç”Ÿä¸¦åŸ·è¡Œè³‡æ ¼æ¯”å° -->
            </div>
        </div>

        <!-- æ­¥é©Ÿ 2: åŒ¯æ¬¾æäº¤ (å¯©æ ¸é€šéå¾Œé¡¯ç¤º) -->
        <div id="step-2" class="card hidden">
            <div class="card-header">2. æäº¤åŒ¯æ¬¾è³‡è¨Š</div>
            <div class="card-body">
                <div class="bg-blue-50 p-4 rounded mb-6 text-center">
                    <p class="text-xs text-gray-400 uppercase">æ‡‰ä»˜ç¸½é¡</p>
                    <div id="disp-final-price" class="text-3xl font-black text-blue-600">NT$ 0</div>
                </div>
                <label class="block text-sm font-bold mb-2">åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
                <input type="text" id="bank-5" maxlength="5" class="w-full border p-3 rounded text-center text-2xl font-bold tracking-widest mb-6">
                <button onclick="submitBooking()" id="btn-submit" class="w-full bg-blue-600 text-white py-4 rounded font-bold">ç¢ºèªé ç´„ âœ</button>
            </div>
        </div>
    </div>

    <script>
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/";
        const eventId = new URLSearchParams(window.location.search).get('id');
        let state = { uid: null, event: null, members: [], selected: null, basePrice: 0 };

        async function init() {
            try {
                await liff.init({ liffId: "2008786875-7COWtgtL" });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                state.uid = profile.userId;

                const [evRes, memRes] = await Promise.all([
                    fetch(`${PROXY_URL}?action=getEvents`),
                    fetch(`${PROXY_URL}?action=getFamily&uid=${state.uid}`)
                ]);
                const evData = await evRes.json();
                state.event = evData.data.find(e => String(e['æ´»å‹•ID']) === String(eventId));
                state.members = (await memRes.json()).data || [];

                renderTop();
                renderMembers();
                document.getElementById('view-loading').style.display = 'none';
            } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
        }

        function renderTop() {
            const ev = state.event;
            document.getElementById('ev-name-disp').innerText = ev['æ´»å‹•åç¨±'];
            document.getElementById('disp-date').innerText = ev['é–‹å§‹æ—¥æœŸ'].substring(0,10);
            document.getElementById('disp-quota').innerText = `${ev['å…§å®¹åª’é«”'] || 0} ä½`;
            
            // æ—©é³¥é‚è¼¯åˆ¤å®š
            const now = new Date();
            const deadline = ev['æ—©é³¥æˆªæ­¢æ—¥æœŸ'] ? new Date(ev['æ—©é³¥æˆªæ­¢æ—¥æœŸ']) : null;
            state.basePrice = (deadline && now <= deadline && ev['å…¨æ—¥æ—©é³¥åƒ¹']) ? parseInt(ev['å…¨æ—¥æ—©é³¥åƒ¹']) : parseInt(ev['å…¨æ—¥åƒ¹']);
        }

        function renderMembers() {
            const targetGrades = (state.event['åˆ†é¡'] || "").split(',');
            const levelReq = state.event['æ¨™ç±¤'] || "ç„¡";

            document.getElementById('member-list').innerHTML = state.members.map(m => {
                const gradeOk = targetGrades.length === 0 || targetGrades.includes(m.å¹´ç´š);
                // å‡è¨­ç­‰ç´šæ¬Šé‡: ç„¡=0, åˆç´š=1, ä¸­ç´š=2
                const levels = ["ç„¡", "åˆç´š", "ä¸­ç´š"];
                const levelOk = levels.indexOf(m.ç­‰ç´š || "åˆç´š") >= levels.indexOf(levelReq);
                const canBook = gradeOk && levelOk;

                return `
                    <div class="member-item ${!canBook ? 'disabled' : ''}" onclick="${canBook ? `selectMember('${m.å­¸å“¡ID}')` : ''}" id="m-${m.å­¸å“¡ID}">
                        <div class="flex-1">
                            <p class="font-bold text-sm">${m.å§“å} <span class="text-[10px] font-normal text-gray-400">(${m.å¹´ç´š})</span></p>
                        </div>
                        ${!canBook ? `<span class="status-tag tag-red">è³‡æ ¼ä¸ç¬¦</span>` : `<span class="text-blue-500 text-xs">é¸æ“‡ âœ</span>`}
                    </div>`;
            }).join('');
        }

        function selectMember(id) {
            state.selected = state.members.find(m => String(m.å­¸å“¡ID) === String(id));
            document.querySelectorAll('.member-item').forEach(el => el.classList.remove('active'));
            document.getElementById('m-'+id).classList.add('active');
            document.getElementById('disp-final-price').innerText = `NT$ ${state.basePrice.toLocaleString()}`;
            document.getElementById('step-2').classList.remove('hidden');
        }

        async function submitBooking() {
            const b5 = document.getElementById('bank-5').value;
            if (b5.length < 5) return alert("è«‹è¼¸å…¥åŒ¯æ¬¾å¾Œäº”ç¢¼");
            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.innerText = "æ­£åœ¨å‚³é€é ç´„...";
            
            const payload = { action: 'submitRegistration', payload: { student: state.selected, eventId: state.event['æ´»å‹•ID'], amount: state.basePrice, bankLast5: b5, type: 'å–®æ—¥å‹' } };
            await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify(payload) });
            alert("ğŸ‰ é ç´„æˆåŠŸï¼");
            window.location.href = 'index.html';
        }

        window.onload = init;
    </script>
</body>
</html>
