<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é ç´„å ±å - é‹å‹•å³¶</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .main-container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 140px; }
        .content-card { background: white; border-radius: 32px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.04); padding: 28px; margin-bottom: 20px; border: 1px solid #f1f5f9; }
        .selection-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 18px; border-radius: 20px; border: 2px solid transparent; cursor: pointer; transition: 0.3s; }
        .selection-item.active { border-color: #1877f2; background: #eef2ff; }
        .btn-blue { background: #1877f2; color: white; padding: 18px 40px; border-radius: 20px; font-weight: 900; width: 100%; text-align: center; font-size: 18px; }
        .sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-top: 1px solid #f1f5f9; padding: 20px; z-index: 100; }
        .rent-card { background: #f8fafc; border-radius: 16px; padding: 14px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border: 1px solid #e2e8f0; }
        .rent-card:has(input:checked) { border-color: #1877f2; background: #e7f3ff; }
        .early-bird-badge { background: #fffbeb; color: #d97706; padding: 4px 10px; border-radius: 8px; font-size: 11px; font-weight: 900; border: 1px solid #fef3c7; }
    </style>
</head>
<body>

    <div id="view-loading" class="fixed inset-0 bg-white z-[2000] flex flex-col items-center justify-center">
        <div class="w-10 h-10 border-4 border-[#1877f2] border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-4 font-black text-slate-400 text-xs tracking-widest uppercase italic">é‹å‹•å³¶æ™ºèƒ½æ’èª²ä¸­...</p>
    </div>

    <div class="main-container">
        <div id="view-member" class="hidden text-center">
            <h2 class="text-3xl font-black mb-10 italic tracking-tight">é¸æ“‡å ±åå­¸å“¡</h2>
            <div id="member-list" class="space-y-4"></div>
        </div>

        <div id="view-details" class="hidden">
            <div class="content-card">
                <div class="flex justify-between items-center mb-1">
                    <h2 id="event-name" class="text-2xl font-black text-[#1877f2] italic">---</h2>
                    <div id="early-bird-tag" class="early-bird-badge hidden">âœ¨ æ—©é³¥å„ªæƒ ä¸­</div>
                </div>
                <div id="event-info" class="text-[10px] font-bold text-slate-400 uppercase mb-8">Loading Spec...</div>
                <div id="dynamic-booking-ui"></div>
            </div>

            <!-- âœ¨ å…¨åŸŸè£å‚™ç§Ÿç”¨ (å„ç¨®æ´»å‹•é€šç”¨) -->
            <div id="rental-area" class="content-card hidden">
                <h3 class="font-black text-slate-800 mb-6 italic">ğŸ’ åŠ è³¼è£å‚™ç§Ÿç”¨</h3>
                <div id="rental-list"></div>
            </div>
        </div>

        <div id="view-checkout" class="hidden">
            <div class="content-card">
                <h2 class="text-2xl font-black mb-8 italic text-slate-800">æœ€å¾Œç¢ºèª</h2>
                <div class="space-y-4 mb-8">
                    <div class="flex justify-between border-b pb-4"><span class="text-slate-400 font-bold">é ç´„æˆå“¡</span><span id="summary-member" class="font-black">---</span></div>
                    <div class="flex justify-between border-b pb-4"><span class="text-slate-400 font-bold">å ±åé …ç›®</span><span id="summary-target" class="font-black">---</span></div>
                </div>
                <div class="bg-blue-50 p-8 rounded-3xl text-center mb-10 border border-blue-100">
                    <p class="text-xs font-black text-[#1877f2] mb-2 uppercase tracking-widest">æ‡‰ä»˜ç¸½é‡‘é¡</p>
                    <p id="final-amount" class="text-4xl font-black text-[#1877f2] italic">NT$ 0</p>
                    <p id="summary-price-note" class="text-[10px] text-amber-600 font-bold mt-2"></p>
                </div>
                <input type="text" id="bank-5" class="w-full border-2 border-slate-100 p-5 rounded-2xl mb-8 text-center font-black text-2xl outline-none focus:border-[#1877f2]" maxlength="5" placeholder="åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼">
                <button onclick="submitBooking()" id="btn-submit" class="btn-blue">ç¢ºèªä¸¦å®Œæˆé ç´„ âœ</button>
            </div>
        </div>
    </div>

    <div id="footer-bar" class="sticky-footer flex justify-between items-center hidden">
        <div><p class="text-[10px] font-black text-slate-400">ç›®å‰çµå¸³ç¸½é¡</p><p id="footer-price" class="text-2xl font-black text-[#1877f2] italic">NT$ 0</p></div>
        <button onclick="switchView('checkout')" class="btn-blue !w-auto !px-12 !py-4 shadow-lg">ä¸‹ä¸€æ­¥ âœ</button>
    </div>

    <script>
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        const eventId = new URLSearchParams(window.location.search).get('id');
        let state = { uid: null, event: null, members: [], selectedMember: null, selectedBatch: null, rentals: [], allRentals: [], currentPrice: 0 };

        async function init() {
            try {
                await liff.init({ liffId: "2008786875-7COWtgtL" });
                if (!liff.isLoggedIn() && liff.isInClient()) { liff.login(); return; }
                const p = liff.isLoggedIn() ? await liff.getProfile() : { userId: "DEBUG_USER" };
                state.uid = p.userId;

                const [evRes, memRes] = await Promise.all([
                    fetch(`${PROXY_URL}?action=getEvents`),
                    fetch(`${PROXY_URL}?action=getFamily&uid=${state.uid}`)
                ]);
                const evData = await evRes.json();
                state.event = evData.data.find(e => String(e['æ´»å‹•ID']) === String(eventId));
                state.members = (await memRes.json()).data || [];
                state.allRentals = JSON.parse(evData.config.rentalItems || "[]");

                if (!state.event) { window.location.href = 'index.html'; return; }
                
                // âœ¨ æ ¸å¿ƒé‚è¼¯ï¼šåˆ¤æ–·æ—©é³¥åƒ¹
                const now = new Date();
                const deadline = state.event['æ—©é³¥æˆªæ­¢æ—¥æœŸ'] ? new Date(state.event['æ—©é³¥æˆªæ­¢æ—¥æœŸ']) : null;
                const earlyPrice = parseInt(state.event['å…¨æ—¥æ—©é³¥åƒ¹']);
                
                if (deadline && now <= deadline && earlyPrice > 0) {
                    state.currentPrice = earlyPrice;
                    document.getElementById('early-bird-tag').classList.remove('hidden');
                    document.getElementById('summary-price-note').innerText = "å·²è‡ªå‹•å¥—ç”¨æ—©é³¥å„ªæƒ åƒ¹";
                } else {
                    state.currentPrice = parseInt(state.event['å…¨æ—¥åƒ¹'] || 0);
                }

                document.getElementById('event-name').innerText = state.event['æ´»å‹•åç¨±'];
                document.getElementById('event-info').innerText = `${state.event['æ´»å‹•å‹æ…‹']} | ${state.event['åˆ†é¡']}`;
                
                renderMembers();
                switchView('member');
            } catch (e) { console.error(e); } finally { document.getElementById('view-loading').style.display='none'; }
        }

        function renderMembers() {
            document.getElementById('member-list').innerHTML = state.members.map(m => `
                <div onclick="selectMember('${m.å­¸å“¡ID}')" class="selection-item">
                    <div class="flex items-center gap-4"><div class="w-12 h-12 bg-blue-50 text-[#1877f2] rounded-2xl flex items-center justify-center font-black shadow-inner">${(m.å§“å||"?").charAt(0)}</div><p class="font-black text-xl text-slate-800">${m.å§“å}</p></div>
                    <span class="text-[#1877f2] font-black italic text-xs">SELECT âœ</span>
                </div>`).join('') || '<p class="text-center py-10 text-slate-300 italic">è«‹å…ˆæ–°å¢æˆå“¡è³‡æ–™</p>';
        }

        function selectMember(id) {
            state.selectedMember = state.members.find(m => String(m.å­¸å“¡ID) === id);
            document.getElementById('summary-member').innerText = state.selectedMember.å§“å;
            renderDynamicInterface();
            renderRentals();
            switchView('details');
        }

        function renderDynamicInterface() {
            const container = document.getElementById('dynamic-booking-ui');
            const type = state.event['æ´»å‹•å‹æ…‹'];

            if(type === 'æ¢¯æ¬¡å‹') {
                const batches = JSON.parse(state.event['æ¢¯æ¬¡è³‡æ–™'] || "[]");
                container.innerHTML = `<label class="block font-black text-slate-400 text-xs mb-6 uppercase tracking-widest text-left">è«‹é¸æ“‡åƒåŠ æ¢¯æ¬¡ï¼š</label>
                    <div class="space-y-4">${batches.map(b => `
                        <div onclick="state.selectedBatch='${b.n}'; document.getElementById('summary-target').innerText='${b.n}'; this.parentNode.querySelectorAll('div').forEach(d=>d.classList.remove('active')); this.classList.add('active');" class="selection-item">
                            <div class="text-left"><p class="font-black text-xl text-slate-800">${b.n}</p><p class="text-xs text-slate-400 font-bold italic">${b.s.substring(5,16).replace('T',' ')} èµ·</p></div>
                            <span class="bg-blue-50 text-[#1877f2] px-4 py-2 rounded-xl text-[10px] font-black uppercase">é¸å–</span>
                        </div>`).join('')}</div>`;
            } else if(type === 'å¸¸æ…‹å‹') {
                container.innerHTML = `<div class="bg-emerald-50 p-8 rounded-[2rem] border-2 border-emerald-100/50">
                    <h4 class="text-xl font-black text-emerald-800 italic mb-4">å­¸æœŸèª²ç¨‹èªªæ˜</h4>
                    <p class="text-emerald-700 text-sm font-medium leading-relaxed mb-6 text-left">æœ¬èª²ç¨‹ç‚ºå›ºå®šé€±èª²ï¼Œå ±åå³åŒ…å«æ•´å­¸æœŸä¸Šèª²æ—¥æœŸã€‚</p>
                    <div class="bg-white/60 p-4 rounded-2xl text-left"><p class="text-[10px] font-black text-emerald-600 uppercase mb-1">ä¸Šèª²æ—¥è¨­å®š</p><p class="font-black text-emerald-900">${state.event['æ¢¯æ¬¡è³‡æ–™'] || 'æ¯é€±å›ºå®šæ™‚æ®µ'}</p></div>
                </div>`;
                state.selectedBatch = "æ•´å­¸æœŸå¸¸æ…‹ç­";
                document.getElementById('summary-target').innerText = "æ•´å­¸æœŸå¸¸æ…‹ç­";
            } else {
                container.innerHTML = `<div class="bg-blue-50 p-8 rounded-[2rem] border-2 border-blue-100/50 text-center">
                    <h4 class="text-xl font-black text-blue-800 italic mb-2">å–®æ—¥å°ˆæ¡ˆæ´»å‹•</h4>
                    <p class="text-xs text-blue-400 font-black mb-6 uppercase tracking-widest">${state.event['é–‹å§‹æ—¥æœŸ']}</p>
                    <p class="text-blue-700 text-sm font-medium">å–®å ‚é™å®šé«”é©—é …ç›®ã€‚</p>
                </div>`;
                state.selectedBatch = "å–®æ—¥å°ˆæ¡ˆ";
                document.getElementById('summary-target').innerText = "å–®æ—¥å°ˆæ¡ˆ";
            }
            updateTotal();
        }

        function renderRentals() {
            const allowed = (state.event['å…§å®¹åª’é«”'] || "").split(',').filter(i=>i);
            const items = state.allRentals.filter(i => allowed.includes(i.name));
            if(items.length === 0) { document.getElementById('rental-area').classList.add('hidden'); return; }
            document.getElementById('rental-area').classList.remove('hidden');
            document.getElementById('rental-list').innerHTML = items.map(it => `
                <label class="rent-card">
                    <div class="flex items-center gap-3"><input type="checkbox" onchange="toggleRent('${it.name}', ${it.price})" class="w-6 h-6 accent-[#1877f2]"><span class="font-bold text-slate-700">${it.name}</span></div>
                    <span class="font-black text-[#1877f2] italic">+$${it.price}</span>
                </label>`).join('');
        }

        function toggleRent(name, price) {
            const idx = state.rentals.findIndex(i => i.name === name);
            if(idx > -1) state.rentals.splice(idx, 1); else state.rentals.push({name, price});
            updateTotal();
        }

        function updateTotal() {
            const rentTotal = state.rentals.reduce((a, b) => a + b.price, 0);
            const total = state.currentPrice + rentTotal;
            document.getElementById('footer-price').innerText = `NT$ ${total.toLocaleString()}`;
            document.getElementById('final-amount').innerText = `NT$ ${total.toLocaleString()}`;
        }

        function switchView(v) { 
            ['member', 'details', 'checkout'].forEach((i, idx) => {
                document.getElementById('view-' + i).classList.toggle('hidden', i !== v);
            });
            document.getElementById('footer-bar').classList.toggle('hidden', v !== 'details');
            window.scrollTo(0,0);
        }

        async function submitBooking() {
            const b5 = document.getElementById('bank-5').value;
            if(b5.length < 5) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„åŒ¯æ¬¾å¾Œäº”ç¢¼");
            if(!state.selectedBatch) return alert("è«‹å…ˆé¸å–é …ç›®æˆ–æ¢¯æ¬¡");

            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.innerText = "é ç´„å‚³é€ä¸­...";

            const payload = { 
                student: state.selectedMember, 
                eventId: state.event['æ´»å‹•ID'], 
                eventName: state.event['æ´»å‹•åç¨±'], 
                amount: parseInt(document.getElementById('final-amount').innerText.replace(/\D/g,'')), 
                bankLast5: b5, 
                selectedBatch: state.selectedBatch,
                rentedItems: state.rentals.map(r => r.name).join(',')
            };

            const res = await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify({ action: 'submitRegistration', payload }) });
            if((await res.json()).status === 'success') {
                alert("ğŸ‰ é ç´„æˆåŠŸï¼å ±åè³‡æ–™å·²å¯«å…¥é›²ç«¯ã€‚");
                window.location.href = 'index.html';
            } else {
                alert("é ç´„å¤±æ•—");
                btn.disabled = false;
            }
        }
        window.onload = init;
    </script>
</body>
</html>
