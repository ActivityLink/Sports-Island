<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>預約報名 - 運動島</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .main-container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 140px; }
        .content-card { background: white; border-radius: 32px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.04); padding: 28px; margin-bottom: 20px; border: 1px solid #f1f5f9; }
        .selection-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 20px; border-radius: 20px; border: 2px solid transparent; cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .selection-item.active { border-color: #1877f2; background: #eef2ff; }
        .btn-blue { background: #1877f2; color: white; padding: 18px 40px; border-radius: 20px; font-weight: 900; width: 100%; text-align: center; font-size: 18px; box-shadow: 0 10px 20px -5px rgba(24,119,242,0.3); transition: 0.2s; }
        .sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-top: 1px solid #f1f5f9; padding: 20px; z-index: 100; }
        .step-dot { height: 6px; flex: 1; border-radius: 10px; background: #e2e8f0; }
        .step-dot.active { background: #1877f2; }
        
        .diag-log { font-family: monospace; font-size: 10px; border-bottom: 1px solid #333; padding: 2px 0; }
        #diag-panel { max-height: 200px; overflow-y: auto; background: rgba(0,0,0,0.9); color: #00ff00; padding: 8px; font-size: 10px; display: none; }
        .text-island-black { color: #000000 !important; font-weight: 400 !important; }
    </style>
</head>
<body>

    <div id="view-loading" class="fixed inset-0 bg-white z-[2000] flex flex-col items-center justify-center p-8">
        <div class="w-12 h-12 border-4 border-[#1877f2] border-t-transparent rounded-full animate-spin"></div>
        <p id="loading-text" class="mt-6 font-black text-slate-400 text-sm tracking-widest uppercase text-center">正在接入島內環境...</p>
        
        <div id="debug-area" class="mt-8 w-full bg-slate-50 rounded-2xl p-4 hidden">
            <p class="text-[10px] font-black text-slate-400 uppercase mb-2">LINE 診斷報告</p>
            <div id="error-msg" class="text-[11px] text-red-500 font-mono break-all whitespace-pre-wrap mb-4"></div>
            <button onclick="location.reload()" class="w-full bg-slate-200 py-2 rounded-lg text-xs font-bold text-slate-600">強制重新整理</button>
            <button onclick="liff.logout(); location.reload();" class="w-full mt-2 bg-slate-100 py-2 rounded-lg text-[10px] text-slate-400">清除 LINE 登入狀態</button>
        </div>
    </div>

    <div id="diag-panel" class="fixed top-0 left-0 right-0 z-[3000]"></div>

    <div class="main-container">
        <!-- 步驟指示 -->
        <div class="flex gap-2 mb-6">
            <div id="step-1" class="step-dot active"></div><div id="step-2" class="step-dot"></div><div id="step-3" class="step-dot"></div>
        </div>

        <!-- 視圖: 選擇成員 -->
        <div id="view-member" class="hidden">
            <h2 class="text-3xl font-black mb-8 italic tracking-tight text-slate-800 text-left">1. 選擇預約成員</h2>
            <div id="member-list" class="space-y-4 text-left"></div>
            <button onclick="safeNavigate('register.html?mode=add')" class="w-full mt-10 py-5 border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 font-bold hover:bg-white transition-all">+ 新增成員個資</button>
        </div>

        <!-- 視圖: 課程詳情 -->
        <div id="view-details" class="hidden">
            <div class="content-card">
                <div class="flex justify-between items-start mb-1">
                    <h2 id="event-name" class="text-2xl font-black text-[#1877f2] italic leading-tight">---</h2>
                </div>
                <div id="event-info" class="text-[10px] font-bold text-slate-400 uppercase mb-8 italic">Loading...</div>
                <div id="dynamic-booking-ui" class="mt-6"></div>
            </div>
        </div>

        <!-- 視圖: 結帳 -->
        <div id="view-checkout" class="hidden">
            <div class="content-card">
                <h2 class="text-2xl font-black mb-8 italic text-slate-800">最後預約摘要</h2>
                <div class="space-y-4 mb-8 text-sm font-medium">
                    <div class="flex justify-between border-b pb-4"><span class="text-slate-400">成員</span><span id="summary-member" class="font-black text-island-black">---</span></div>
                    <div class="flex justify-between border-b pb-4"><span class="text-slate-400">項目</span><span id="summary-target" class="font-black text-island-black">---</span></div>
                </div>
                <div class="bg-blue-50 p-8 rounded-3xl text-center mb-10 border border-blue-100">
                    <p class="text-xs font-black text-[#1877f2] uppercase tracking-widest mb-2">應付學費總金額</p>
                    <p id="final-amount" class="text-4xl text-island-black italic">NT$ 0</p>
                </div>
                <input type="text" id="bank-5" class="w-full border-2 border-slate-100 p-5 rounded-2xl mb-8 text-center font-black text-2xl outline-none focus:border-[#1877f2] transition-all bg-slate-50 focus:bg-white" maxlength="5" placeholder="匯款帳號後五碼">
                <button onclick="submitBooking()" id="btn-submit" class="btn-blue">確認報名 ➜</button>
            </div>
            <button onclick="switchView('details')" class="w-full text-slate-400 font-bold text-xs uppercase mt-4">⬅ 返回修改</button>
        </div>
    </div>

    <div id="footer-bar" class="sticky-footer hidden">
        <div class="max-w-[600px] mx-auto flex items-center justify-between gap-6">
            <div>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">目前學費</p>
                <p id="footer-price" class="text-2xl text-island-black italic">NT$ 0</p>
            </div>
            <button onclick="switchView('checkout')" class="btn-blue !w-auto !px-12 !py-4 shadow-lg">下一步 ➜</button>
        </div>
    </div>

    <script>
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        const LIFF_ID = "2008786875-7COWtgtL";
        const urlParams = new URLSearchParams(window.location.search);
        const eventId = urlParams.get('id');
        
        let state = { uid: null, event: null, members: [], selectedMember: null, selectedBatch: null, basePrice: 0 };

        function diagLog(msg, isError = false) {
            const panel = document.getElementById('diag-panel');
            const div = document.createElement('div');
            div.className = `diag-log ${isError ? 'text-red-500' : ''}`;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            panel.appendChild(div);
            panel.scrollTop = panel.scrollHeight;
            if (urlParams.get('debug') === '1' || isError) panel.style.display = 'block';
            console.log(msg);
        }

        function safeNavigate(t) {
            window.location.replace(new URL(t, window.location.href).href);
        }

        async function robustFetch(url, options = {}, retries = 3) {
            try {
                diagLog(`Fetch: ${url.split('?')[0].substring(0, 30)}...`);
                const response = await fetch(url, { 
                    ...options, 
                    headers: { 'Content-Type': 'application/json', ...options.headers } 
                });
                
                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 30)}`);
                }
                const data = await response.json();
                diagLog(`Fetch Success`);
                return data;
            } catch (err) {
                diagLog(`Fetch Error: ${err.message}`, true);
                if (retries > 0) {
                    diagLog(`Retrying...`);
                    await new Promise(r => setTimeout(r, 1500));
                    return robustFetch(url, options, retries - 1);
                }
                throw err;
            }
        }

        async function init() {
            try {
                diagLog("LIFF Init 開始...");
                await liff.init({ liffId: LIFF_ID });
                
                diagLog(`環境檢查: ${liff.isInClient() ? 'LINE 內部' : '外部瀏覽器'}`);
                
                // LINE 內部環境特別檢查
                if (!liff.isLoggedIn()) {
                    diagLog("未登入，啟動登入流程...");
                    // 修正：針對 LINE App 內部，login 不一定要 redirectUri
                    // 但為了統一，我們加上當前 URL 並確保不帶 Fragment
                    const loginUrl = window.location.href.split('#')[0];
                    liff.login({ redirectUri: loginUrl });
                    return; 
                }

                diagLog("獲取個人資料...");
                // 在某些 LINE 版本，getProfile 必須放在 login 之後
                const profile = await liff.getProfile();
                state.uid = profile.userId;
                diagLog(`UID: ${state.uid}`);

                document.getElementById('loading-text').innerText = "正在讀取運動島成員資料...";
                
                // 修改：不要用 Promise.all，改為順序執行以便排查哪一個 Fetch 壞掉
                diagLog("讀取課程資料...");
                const evData = await robustFetch(`${PROXY_URL}?action=getEvents`);
                if (!evData || !evData.data) throw new Error("課程資料讀取失敗");

                diagLog("讀取成員個資...");
                const memData = await robustFetch(`${PROXY_URL}?action=getFamily&uid=${state.uid}`);
                
                state.event = evData.data.find(e => String(e['活動ID']) === String(eventId));
                if (!state.event) {
                    throw new Error("找不到指定的活動 ID (" + eventId + ")");
                }

                state.members = memData.data || [];
                state.basePrice = parseInt(state.event['全日價'] || 0);

                // 更新 UI
                document.getElementById('event-name').innerText = state.event['活動名稱'];
                document.getElementById('event-info').innerText = `${state.event['活動型態']} | ${state.event['分類']}`;
                
                renderMembers();
                switchView('member');
                document.getElementById('view-loading').style.display='none';
                diagLog("初始化完全成功");

            } catch (e) {
                diagLog(`致命錯誤: ${e.message}`, true);
                document.getElementById('loading-text').innerText = "系統初始化失敗";
                document.getElementById('debug-area').classList.remove('hidden');
                document.getElementById('error-msg').innerText = 
                    `【錯誤報告】\n訊息: ${e.message}\n` +
                    `環境: ${liff.isInClient() ? 'LINE' : 'Web'}\n` +
                    `UA: ${navigator.userAgent.substring(0, 50)}...`;
            }
        }

        function renderMembers() {
            if (state.members.length === 0) {
                document.getElementById('member-list').innerHTML = `
                    <div class="text-center p-8 bg-slate-50 rounded-3xl border-2 border-dashed border-slate-200">
                        <p class="text-slate-400 font-bold">目前暫無成員資料</p>
                    </div>`;
                return;
            }
            document.getElementById('member-list').innerHTML = state.members.map(m => `
                <div onclick="selectMember('${m.學員ID}')" class="selection-item">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-50 text-[#1877f2] rounded-2xl flex items-center justify-center font-black italic shadow-inner">${(m.姓名||"?").charAt(0)}</div>
                        <p class="font-black text-xl text-slate-800">${m.姓名}</p>
                    </div>
                    <span class="text-[#1877f2] font-black italic text-xs">選擇 ➜</span>
                </div>`).join('');
        }

        function selectMember(id) {
            state.selectedMember = state.members.find(m => String(m.學員ID) === id);
            document.getElementById('summary-member').innerText = state.selectedMember.姓名;
            renderDynamicInterface();
            switchView('details');
        }

        function renderDynamicInterface() {
            const container = document.getElementById('dynamic-booking-ui');
            const type = state.event['活動型態'];
            if(type === '梯次型') {
                try {
                    const batches = JSON.parse(state.event['梯次資料'] || "[]");
                    container.innerHTML = batches.map(b => `
                        <div onclick="state.selectedBatch='${b.n}'; Array.from(this.parentNode.children).forEach(d=>d.classList.remove('active')); this.classList.add('active'); updatePrice();" class="selection-item mb-3">
                            <div class="text-left">
                                <p class="font-black text-xl text-slate-800">${b.n}</p>
                                <p class="text-sm text-island-black italic">${b.s.substring(5,10)} ~ ${b.e.substring(5,10)}</p>
                            </div>
                            <span class="bg-blue-50 text-[#1877f2] px-4 py-2 rounded-xl text-xs font-black">選取</span>
                        </div>`).join('');
                } catch(e) {
                    container.innerHTML = `<p class="text-red-500 text-xs">梯次資料解析失敗</p>`;
                }
            } else {
                container.innerHTML = `<div class="bg-blue-50 p-8 rounded-3xl border-2 border-blue-100 text-center"><p class="text-island-black text-sm italic">活動日期：${state.event['開始日期'] || '未定'}</p></div>`;
                state.selectedBatch = "一般預約";
            }
            updatePrice();
        }

        function updatePrice() {
            const final = state.basePrice;
            document.getElementById('footer-price').innerText = `NT$ ${final.toLocaleString()}`;
            document.getElementById('final-amount').innerText = `NT$ ${final.toLocaleString()}`;
            document.getElementById('summary-target').innerText = state.selectedBatch || "未選項目";
        }

        function switchView(v) { 
            const views = ['member', 'details', 'checkout'];
            views.forEach((i, idx) => {
                document.getElementById('view-' + i).classList.toggle('hidden', i !== v);
                const dot = document.getElementById('step-' + (idx + 1));
                if (dot) dot.classList.toggle('active', i === v || views.indexOf(i) < views.indexOf(v));
            });
            document.getElementById('footer-bar').classList.toggle('hidden', v !== 'details');
            window.scrollTo(0,0);
        }

        async function submitBooking() {
            const b5 = document.getElementById('bank-5').value;
            if(b5.length < 5) return alert("請輸入正確匯款後五碼");
            
            const btn = document.getElementById('btn-submit'); 
            btn.disabled = true; 
            btn.innerText = "正在傳送預約...";
            
            const payload = { 
                student: state.selectedMember, 
                eventId: state.event['活動ID'], 
                eventName: state.event['活動名稱'], 
                amount: state.basePrice, 
                bankLast5: b5, 
                selectedBatch: state.selectedBatch 
            };

            try {
                diagLog("提交預約中...");
                const res = await robustFetch(PROXY_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ action: 'submitRegistration', payload }) 
                });
                
                if(res.status === 'success') { 
                    alert("預約成功！"); 
                    safeNavigate('index.html'); 
                } else {
                    throw new Error(res.message || "伺服器回傳失敗");
                }
            } catch(e) { 
                diagLog(`提交失敗: ${e.message}`, true);
                alert("報名失敗: " + e.message); 
                btn.disabled = false; 
                btn.innerText = "確認報名 ➜";
            }
        }

        window.onload = init;
    </script>
</body>
</html>
