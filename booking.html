<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é ç´„ç´°ç¯€ç¢ºèª - é‹å‹•å³¶</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; }
        .main-container { max-width: 600px; margin: 0 auto; padding: 20px 16px; }
        .content-card { background: white; border-radius: 20px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); padding: 24px; margin-bottom: 16px; border: 1px solid #f1f5f9; }
        
        /* æ—¥æ›†å¡ç‰‡æ¨£å¼ */
        .calendar-day-card { border: 1px solid #e2e8f0; border-radius: 12px; padding: 12px; margin-bottom: 8px; transition: 0.2s; }
        .calendar-day-card.has-leave { border-color: #f87171; background-color: #fef2f2; }
        
        .leave-option { font-size: 11px; padding: 6px 4px; border-radius: 6px; border: 1px solid #e2e8f0; cursor: pointer; text-align: center; font-weight: 700; color: #64748b; background: white; }
        .leave-option.active { background: #3b82f6; border-color: #3b82f6; color: white; }
        .leave-option.active.absent { background: #ef4444; border-color: #ef4444; }

        .btn-primary { background: #3b82f6; color: white; padding: 16px; border-radius: 12px; font-weight: 900; width: 100%; cursor: pointer; border: none; }
        .section-view { display: none; }
        .section-view.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- 0. è¼‰å…¥ä¸­ -->
        <div id="view-loading" class="text-center py-20 section-view active">
            <div class="inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 font-black text-slate-400 text-xs tracking-widest uppercase">Expert Logic Loading...</p>
        </div>

        <!-- 1. é¸æ“‡æˆå“¡ -->
        <div id="view-member" class="section-view">
            <h2 class="text-xl font-black mb-6 italic text-slate-800">STEP 1. é¸æ“‡åƒåŠ æˆå“¡</h2>
            <div id="member-list" class="grid gap-3"></div>
            <button onclick="safeNavigate('register.html?mode=add')" class="w-full mt-6 py-4 border-2 border-dashed border-slate-200 rounded-xl text-slate-400 font-black text-sm hover:bg-white">+ æ–°å¢å…¶ä»–å®¶äºº</button>
        </div>

        <!-- 2. æ—¥æ›†è«‹å‡èˆ‡è¦æ ¼ -->
        <div id="view-details" class="section-view">
            <button onclick="switchView('member')" class="mb-4 text-slate-400 font-bold text-xs">â¬… è¿”å›é¸æ“‡æˆå“¡</button>
            <div class="content-card">
                <h2 id="event-title-display" class="text-xl font-black mb-1 text-blue-600">---</h2>
                <p id="early-bird-tag" class="text-[10px] font-black text-green-600 uppercase mb-6 hidden">âœ¨ å·²å•Ÿå‹•æ—©é³¥å„ªæƒ è¨ˆåƒ¹</p>
                
                <!-- æ—¥æ›†è«‹å‡å€ -->
                <div class="mb-8">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest">è«‹å‡å®‰æ’ (å‹¾é¸ä¸å‡ºå¸­çš„æ™‚æ®µ)</label>
                    <div id="calendar-container" class="space-y-2">
                        <!-- ç”± JS æ¸²æŸ“æ—¥æ›† -->
                    </div>
                </div>

                <!-- è¨­å‚™ç§Ÿå€Ÿå€ -->
                <div id="rental-section" class="mb-8 hidden">
                    <label class="block text-[10px] font-black text-blue-500 uppercase mb-3 tracking-widest">é¸è³¼è¨­å‚™ç§Ÿå€Ÿ</label>
                    <div id="rental-options" class="space-y-2"></div>
                </div>

                <!-- é‡‘é¡åŒ¯ç¸½ -->
                <div class="bg-slate-900 text-white p-6 rounded-2xl mb-6 shadow-xl">
                    <div class="flex justify-between text-xs opacity-60 mb-1"><span>åŸå§‹ç¸½é¡</span><span id="price-original">NT$ 0</span></div>
                    <div class="flex justify-between text-xs text-red-400 mb-1"><span>è«‹å‡æ‰£é™¤</span><span id="price-deduction">- NT$ 0</span></div>
                    <div class="flex justify-between text-xs text-blue-300 mb-4"><span>è¨­å‚™ç§Ÿå€Ÿ</span><span id="price-rent">NT$ 0</span></div>
                    <div class="flex justify-between items-end border-t border-white/10 pt-4">
                        <span class="font-black text-sm italic">æ‡‰ä»˜ç¸½è¨ˆ TOTAL</span>
                        <span id="price-total" class="text-3xl font-black italic text-blue-400">NT$ 0</span>
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">åŒ¯æ¬¾å¾Œäº”ç¢¼</label>
                    <input type="text" id="bank-5" class="w-full border rounded-xl p-4 font-black bg-slate-50 outline-none focus:bg-white focus:border-blue-500" maxlength="5" placeholder="00000">
                </div>

                <button onclick="submitBooking()" id="btn-submit" class="btn-primary shadow-lg uppercase italic tracking-tighter text-lg">Confirm Booking âœ</button>
            </div>
        </div>
    </div>

    <script>
        const LIFF_ID = "2008786875-7COWtgtL";
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        const eventId = new URLSearchParams(window.location.search).get('id');

        let state = { 
            uid: null, event: null, members: [], config: {}, 
            selectedMember: null, leaves: {}, rentedItems: [], isEarlyBird: false 
        };

        function safeNavigate(t) { if (window.location.protocol==='blob:'){ console.warn("Blob skip: "+t); return; } window.location.href=t; }

        async function init() {
            if (!eventId) { safeNavigate('index.html'); return; }
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const p = await liff.getProfile();
                state.uid = p.userId;

                const [evRes, memRes] = await Promise.all([
                    fetch(`${PROXY_URL}?action=getEvents`),
                    fetch(`${PROXY_URL}?action=getFamily&uid=${state.uid}`)
                ]);
                const evData = await evRes.json();
                const memData = await memRes.json();

                state.event = evData.data.find(e => String(e['æ´»å‹•ID']) === String(eventId));
                state.config = evData.config || {};
                state.members = memData.data || [];

                if (!state.event) { alert("æ´»å‹•ä¸å­˜åœ¨"); safeNavigate('index.html'); return; }

                // åˆ¤å®šæ—©é³¥
                const deadline = new Date(state.event['æ—©é³¥æˆªæ­¢æ—¥æœŸ']);
                state.isEarlyBird = !isNaN(deadline) && (new Date() <= deadline);
                if(state.isEarlyBird) document.getElementById('early-bird-tag').classList.remove('hidden');

                document.getElementById('event-title-display').innerText = state.event['æ´»å‹•åç¨±'];
                
                renderMembers();
                renderCalendar();
                renderRentalOptions();
                switchView('member');
            } catch (e) { console.error(e); }
        }

        function renderMembers() {
            const container = document.getElementById('member-list');
            if(state.members.length === 0) { safeNavigate('register.html?mode=add'); return; }
            container.innerHTML = state.members.map(m => `
                <div onclick="selectMember('${m.å­¸å“¡ID}')" class="bg-white p-4 rounded-xl border border-slate-200 cursor-pointer flex justify-between items-center hover:shadow-md transition-all">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-lg flex items-center justify-center font-black">${m.å§“å.charAt(0)}</div>
                        <p class="font-black text-sm">${m.å§“å}</p>
                    </div>
                    <div class="text-blue-500 font-black text-xs italic">SELECT âœ</div>
                </div>`).join('');
        }

        function renderCalendar() {
            const container = document.getElementById('calendar-container');
            const start = new Date(state.event['é–‹å§‹æ—¥æœŸ']);
            const end = new Date(state.event['çµæŸæ—¥æœŸ']);
            let current = new Date(start);
            let html = "";

            while (current <= end) {
                const dStr = current.toISOString().split('T')[0];
                state.leaves[dStr] = 'å‡ºå¸­'; // é è¨­å…¨éƒ¨å‡ºå¸­
                html += `
                <div id="day-card-${dStr}" class="calendar-day-card">
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-black text-xs text-slate-700">${dStr}</span>
                        <span id="status-text-${dStr}" class="text-[10px] font-bold text-blue-500 uppercase">å‡ºå¸­ä¸­</span>
                    </div>
                    <div class="grid grid-cols-4 gap-1">
                        <div onclick="setLeave('${dStr}', 'å‡ºå¸­')" id="opt-${dStr}-å‡ºå¸­" class="leave-option active">å‡ºå¸­</div>
                        <div onclick="setLeave('${dStr}', 'å…¨æ—¥')" id="opt-${dStr}-å…¨æ—¥" class="leave-option absent">å…¨æ—¥å‡</div>
                        <div onclick="setLeave('${dStr}', 'ä¸Šåˆ')" id="opt-${dStr}-ä¸Šåˆ" class="leave-option absent">ä¸Šåˆå‡</div>
                        <div onclick="setLeave('${dStr}', 'ä¸‹åˆ')" id="opt-${dStr}-ä¸‹åˆ" class="leave-option absent">ä¸‹åˆå‡</div>
                    </div>
                </div>`;
                current.setDate(current.getDate() + 1);
            }
            container.innerHTML = html;
        }

        function setLeave(date, type) {
            state.leaves[date] = type;
            
            // æ›´æ–° UI ç‹€æ…‹
            const options = ['å‡ºå¸­', 'å…¨æ—¥', 'ä¸Šåˆ', 'ä¸‹åˆ'];
            options.forEach(opt => {
                const el = document.getElementById(`opt-${date}-${opt}`);
                el.classList.toggle('active', opt === type);
            });

            const card = document.getElementById(`day-card-${date}`);
            const statusText = document.getElementById(`status-text-${date}`);
            
            if (type === 'å‡ºå¸­') {
                card.classList.remove('has-leave');
                statusText.innerText = "å‡ºå¸­ä¸­";
                statusText.className = "text-[10px] font-bold text-blue-500 uppercase";
            } else {
                card.classList.add('has-leave');
                statusText.innerText = type + "è«‹å‡";
                statusText.className = "text-[10px] font-bold text-red-500 uppercase";
            }
            calculatePrice();
        }

        function renderRentalOptions() {
            const items = JSON.parse(state.config.rentalItems || "[]");
            if (items.length === 0) return;
            document.getElementById('rental-section').classList.remove('hidden');
            document.getElementById('rental-options').innerHTML = items.map((item, i) => `
                <label class="flex items-center justify-between p-4 border rounded-xl bg-slate-50 cursor-pointer hover:bg-blue-50 transition-all">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" onchange="updateRental(${i}, this.checked)" class="w-5 h-5 accent-blue-600">
                        <span class="font-bold text-sm text-slate-700">${item.name}</span>
                    </div>
                    <span class="font-black text-blue-600 italic">$${item.price}</span>
                </label>`).join('');
        }

        function updateRental(idx, checked) {
            const items = JSON.parse(state.config.rentalItems || "[]");
            if (checked) state.rentedItems.push(items[idx]);
            else state.rentedItems = state.rentedItems.filter(it => it.name !== items[idx].name);
            calculatePrice();
        }

        function calculatePrice() {
            // 1. æ±ºå®šå–®æ—¥åŸºç¤åƒ¹ (æ—©é³¥åˆ¤å®š)
            const unitPrice = state.isEarlyBird ? Number(state.event['å…¨æ—¥æ—©é³¥åƒ¹'] || state.event['å…¨æ—¥åƒ¹']) : Number(state.event['å…¨æ—¥åƒ¹']);
            const totalDays = Object.keys(state.leaves).length;
            const originalTotal = unitPrice * totalDays;

            // 2. è¨ˆç®—æ‰£é™¤é¡
            let totalDeduction = 0;
            const fullDeduct = Number(state.event['å…¨æ—¥æ‰£é™¤'] || 0);
            const halfDeduct = Number(state.event['åŠæ—¥æ‰£é™¤'] || 0);

            Object.values(state.leaves).forEach(val => {
                if (val === 'å…¨æ—¥') totalDeduction += fullDeduct;
                if (val === 'ä¸Šåˆ' || val === 'ä¸‹åˆ') totalDeduction += halfDeduct;
            });

            // 3. è¨ˆç®—ç§Ÿå€Ÿ
            const rentalTotal = state.rentedItems.reduce((acc, it) => acc + Number(it.price), 0);

            state.finalTotal = originalTotal - totalDeduction + rentalTotal;
            if (state.finalTotal < 0) state.finalTotal = 0;

            document.getElementById('price-original').innerText = `NT$ ${originalTotal.toLocaleString()}`;
            document.getElementById('price-deduction').innerText = `- NT$ ${totalDeduction.toLocaleString()}`;
            document.getElementById('price-rent').innerText = `NT$ ${rentalTotal.toLocaleString()}`;
            document.getElementById('price-total').innerText = `NT$ ${state.finalTotal.toLocaleString()}`;
        }

        function selectMember(mid) { state.selectedMember = state.members.find(m => String(m.å­¸å“¡ID) === String(mid)); switchView('details'); calculatePrice(); }

        async function submitBooking() {
            const b5 = document.getElementById('bank-5').value;
            if (b5.length < 5) return alert("è«‹è¼¸å…¥æ­£ç¢ºçš„åŒ¯æ¬¾å¾Œäº”ç¢¼");

            document.getElementById('btn-submit').disabled = true;
            document.getElementById('btn-submit').innerText = "PUSHING TO CLOUD...";

            // æ•´ç†è«‹å‡å‚™è¨»
            const leaveList = Object.entries(state.leaves)
                .filter(([d, type]) => type !== 'å‡ºå¸­')
                .map(([d, type]) => `${d}(${type})`)
                .join(', ');

            const payload = {
                student: state.selectedMember,
                eventId: state.event['æ´»å‹•ID'],
                eventName: state.event['æ´»å‹•åç¨±'],
                type: 'æ—¥æ›†é ç´„',
                session: leaveList || 'å…¨å‹¤åƒåŠ ',
                amount: state.finalTotal,
                bankLast5: b5,
                rentedItems: state.rentedItems.map(it => it.name)
            };

            const res = await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify({ action: 'submitRegistration', payload }) });
            if ((await res.json()).status === 'success') {
                alert("ğŸ‰ é ç´„å®Œæˆï¼è«‹éœå€™åº—å®¶æ ¸å¸³é€šçŸ¥ã€‚");
                safeNavigate('index.html');
            }
        }

        function switchView(v) {
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + v).classList.add('active');
            window.scrollTo(0,0);
        }

        window.onload = init;
    </script>
</body>
</html>
