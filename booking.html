<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é ç´„å ±å - é‹å‹•å³¶</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .main-container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 140px; }
        
        /* ç»ç’ƒæ“¬æ…‹å¡ç‰‡ */
        .content-card { background: white; border-radius: 32px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.04); padding: 28px; margin-bottom: 20px; border: 1px solid #f1f5f9; }
        
        /* é¸æ“‡é …ç›®æ¨£å¼ */
        .selection-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 20px; border-radius: 20px; border: 2px solid transparent; cursor: pointer; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .selection-item:hover { background: #f1f5f9; }
        .selection-item.active { border-color: #1877f2; background: #eef2ff; box-shadow: 0 8px 20px -5px rgba(24,119,242,0.15); }
        
        /* æ—¥æ›†æ ¼é» */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
        .cal-day { aspect-ratio: 1; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 14px; font-weight: 900; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .status-attend { background: #eef2ff; color: #1877f2; border-color: #dbeafe; }
        .status-absent-full { background: #fee2e2; color: #dc2626; border-color: #fecaca; }
        .status-absent-half { background: #fef3c7; color: #d97706; border-color: #fde68a; }
        .status-disabled { background: #f8fafc; color: #e2e8f0; opacity: 0.3; pointer-events: none; }
        .day-label { font-size: 8px; margin-top: 1px; font-weight: 800; }

        /* æ´»åŠ›è—æŒ‰éˆ• */
        .btn-blue { background: #1877f2; color: white; padding: 18px 40px; border-radius: 20px; font-weight: 900; width: 100%; text-align: center; font-size: 18px; box-shadow: 0 10px 20px -5px rgba(24,119,242,0.3); transition: 0.2s; }
        .btn-blue:active { transform: scale(0.96); opacity: 0.9; }
        .btn-blue:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }

        .sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-top: 1px solid #f1f5f9; padding: 20px; box-shadow: 0 -10px 30px rgba(0,0,0,0.05); z-index: 100; }
        .step-dot { height: 6px; flex: 1; border-radius: 10px; background: #e2e8f0; }
        .step-dot.active { background: #1877f2; }

        /* è£å‚™ç§Ÿç”¨å¡ç‰‡ */
        .rent-card { background: #f8fafc; border-radius: 16px; padding: 16px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border: 1px solid #e2e8f0; }
        .rent-card:has(input:checked) { border-color: #1877f2; background: #e7f3ff; }

        /* å½ˆå‡ºå¼é¸å–® */
        .leave-menu { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 32px 32px 0 0; padding: 32px; z-index: 1001; transform: translateY(100%); transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 -10px 50px rgba(0,0,0,0.1); }
        .leave-menu.active { transform: translateY(0); }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 1000; display: none; }

        /* âœ¨ æ–‡å­—æ¨£å¼ï¼šç´”é»‘è‰²ã€ä¸åŠ ç²— */
        .text-island-black { color: #000000 !important; font-weight: 400 !important; }
    </style>
</head>
<body>

    <!-- è¼‰å…¥ä¸­ç•«é¢ï¼šæ–°å¢è¨ºæ–·æ§åˆ¶å° -->
    <div id="view-loading" class="fixed inset-0 bg-white z-[2000] flex flex-col items-center justify-center p-8">
        <div class="w-12 h-12 border-4 border-[#1877f2] border-t-transparent rounded-full animate-spin"></div>
        <p id="loading-text" class="mt-6 font-black text-slate-400 text-sm tracking-widest uppercase text-center">é‹å‹•å³¶è³‡æºå°æ¥ä¸­...</p>
        
        <!-- è¨ºæ–·è³‡è¨Šå€ (å ±éŒ¯æ™‚è‡ªå‹•å±•é–‹) -->
        <div id="debug-panel" class="mt-8 w-full bg-slate-50 rounded-2xl p-4 hidden">
            <p class="text-[10px] font-black text-slate-400 uppercase mb-2">Diagnostic Data</p>
            <div id="error-msg" class="text-[11px] text-red-500 font-mono break-all whitespace-pre-wrap"></div>
            <button onclick="location.reload()" class="w-full mt-4 bg-slate-200 py-2 rounded-lg text-xs font-bold text-slate-600">æ‰‹å‹•é‡æ–°é€£ç·š</button>
        </div>
    </div>

    <div class="main-container">
        <div class="flex gap-2 mb-6">
            <div id="step-1" class="step-dot active"></div><div id="step-2" class="step-dot"></div><div id="step-3" class="step-dot"></div>
        </div>

        <!-- æ­¥é©Ÿ 1: é¸æ“‡å­¸å“¡ -->
        <div id="view-member" class="hidden text-center">
            <h2 class="text-3xl font-black mb-8 italic tracking-tight text-slate-800 text-left">1. é¸æ“‡é ç´„æˆå“¡</h2>
            <div id="member-list" class="space-y-4 text-left"></div>
            <button onclick="safeNavigate('register.html?mode=add')" class="w-full mt-10 py-5 border-2 border-dashed border-slate-200 rounded-3xl text-slate-400 font-bold hover:bg-white transition-all">+ æ–°å¢æˆå“¡å€‹è³‡</button>
        </div>

        <!-- æ­¥é©Ÿ 2: å°ˆç”¨å ±åä»‹é¢ -->
        <div id="view-details" class="hidden">
            <div class="content-card">
                <div class="flex justify-between items-start mb-1">
                    <h2 id="event-name" class="text-2xl font-black text-[#1877f2] italic leading-tight">---</h2>
                    <div id="early-bird-tag" class="hidden bg-amber-50 text-amber-600 text-[10px] font-black px-2 py-1 rounded border border-amber-100">æ—©é³¥å„ªæƒ ä¸­</div>
                </div>
                <div id="event-info" class="text-[10px] font-bold text-slate-400 uppercase mb-8 italic">Loading Spec...</div>
                
                <div id="dynamic-booking-ui" class="mt-6"></div>
            </div>

            <!-- è£å‚™ç§Ÿç”¨å€ (å‹•æ…‹å°å…¥) -->
            <div id="rental-area" class="content-card hidden">
                <h3 class="font-black text-slate-800 mb-6 italic text-lg">ğŸ’ è£å‚™ç§Ÿç”¨</h3>
                <div id="rental-list"></div>
            </div>
        </div>

        <!-- æ­¥é©Ÿ 3: æ‘˜è¦èˆ‡çµå¸³ -->
        <div id="view-checkout" class="hidden">
            <div class="content-card">
                <h2 class="text-2xl font-black mb-8 italic text-slate-800">æœ€å¾Œé ç´„æ‘˜è¦</h2>
                <div class="space-y-4 mb-8">
                    <div class="flex justify-between border-b pb-4 text-sm font-medium"><span class="text-slate-400">æˆå“¡</span><span id="summary-member" class="font-black">---</span></div>
                    <div class="flex justify-between border-b pb-4 text-sm font-medium"><span class="text-slate-400">é …ç›®</span><span id="summary-target" class="font-black text-island-black">---</span></div>
                    <div id="summary-deduction-area" class="flex justify-between border-b pb-4 text-red-500 hidden">
                        <span class="font-bold">è«‹å‡æ‰£æŠµ</span><span id="summary-deduction">---</span>
                    </div>
                </div>
                <div class="bg-blue-50 p-8 rounded-3xl text-center mb-10 border border-blue-100">
                    <p class="text-xs font-black text-[#1877f2] uppercase tracking-widest mb-2">æ‡‰ä»˜å­¸è²»ç¸½é‡‘é¡</p>
                    <!-- âœ¨ å­¸è²»ï¼šç´”é»‘ä¸åŠ ç²— -->
                    <p id="final-amount" class="text-4xl text-island-black italic">NT$ 0</p>
                    <p id="summary-price-note" class="text-[10px] text-amber-600 font-bold mt-2"></p>
                </div>
                <label class="block text-[10px] font-black text-slate-400 uppercase mb-3 text-center tracking-widest">åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
                <input type="text" id="bank-5" class="w-full border-2 border-slate-100 p-5 rounded-2xl mb-8 text-center font-black text-2xl outline-none focus:border-[#1877f2] transition-all bg-slate-50 focus:bg-white" maxlength="5" placeholder="00000">
                <button onclick="submitBooking()" id="btn-submit" class="btn-blue">ç¢ºèªå ±å âœ</button>
            </div>
            <button onclick="switchView('details')" class="w-full text-slate-400 font-bold text-xs uppercase mt-4">â¬… è¿”å›ä¿®æ”¹</button>
        </div>
    </div>

    <!-- åº•éƒ¨å›ºå®šæ¢ -->
    <div id="footer-bar" class="sticky-footer hidden">
        <div class="max-w-[600px] mx-auto flex items-center justify-between gap-6">
            <div>
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">ç›®å‰å­¸è²»</p>
                <!-- âœ¨ å­¸è²»å‘ˆç¾æ–‡å­—ï¼šç´”é»‘ã€ä¸åŠ ç²— -->
                <p id="footer-price" class="text-2xl text-island-black italic">NT$ 0</p>
            </div>
            <button onclick="switchView('checkout')" class="btn-blue !w-auto !px-12 !py-4 shadow-lg">ä¸‹ä¸€æ­¥ âœ</button>
        </div>
    </div>

    <!-- å½ˆå‡ºé¸å–® -->
    <div id="overlay" class="overlay" onclick="closeLeaveMenu()"></div>
    <div id="leave-menu" class="leave-menu">
        <h3 id="menu-date-title" class="text-xl font-black mb-8 italic text-slate-800">ä¿®æ”¹å‡ºå¸­ç‹€æ…‹</h3>
        <div class="grid grid-cols-2 gap-4 mb-8">
            <button onclick="updateDayStatus('attend')" class="p-6 border-2 border-slate-100 rounded-3xl font-black text-sm">æ¢å¾©å‡ºå¸­</button>
            <button onclick="updateDayStatus('full')" class="p-6 border-2 border-red-50 bg-red-50 text-red-600 rounded-3xl font-black text-sm">å…¨æ—¥è«‹å‡</button>
            <button onclick="updateDayStatus('morning')" class="p-6 border-2 border-orange-50 bg-orange-50 text-orange-600 rounded-3xl font-black text-sm">ä¸Šåˆè«‹å‡</button>
            <button onclick="updateDayStatus('afternoon')" class="p-6 border-2 border-orange-50 bg-orange-50 text-orange-600 rounded-3xl font-black text-sm">ä¸‹åˆè«‹å‡</button>
        </div>
        <button onclick="closeLeaveMenu()" class="w-full py-2 text-slate-400 font-bold uppercase tracking-widest">å–æ¶ˆ</button>
    </div>

    <script>
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        const eventId = new URLSearchParams(window.location.search).get('id');
        let state = { uid: null, event: null, members: [], selectedMember: null, selectedBatch: null, leaves: {}, rentals: [], allRentals: [], currentFocusDate: null, basePrice: 0 };

        function safeNavigate(t) {
            if (window.location.protocol === 'blob:') return;
            const targetUrl = new URL(t, window.location.href).href;
            window.location.replace(targetUrl);
        }

        /**
         * âœ¨ åŠ å¼·ç‰ˆ Fetchï¼šé™„å¸¶è¨ºæ–·èˆ‡è‡ªå‹•é‡è©¦
         */
        async function robustFetch(url, options = {}, retries = 3) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: { 'Content-Type': 'text/plain', ...options.headers } // ä½¿ç”¨ text/plain ç¹éæŸäº› CORS é æª¢é™åˆ¶
                });
                if (!response.ok) throw new Error(`Server Error: ${response.status}`);
                return await response.json();
            } catch (err) {
                if (retries > 0) {
                    await new Promise(r => setTimeout(r, 1500));
                    return robustFetch(url, options, retries - 1);
                }
                throw err;
            }
        }

        async function init() {
            const debugPanel = document.getElementById('debug-panel');
            const errorMsg = document.getElementById('error-msg');
            
            try {
                // 1. LIFF åˆå§‹åŒ–èˆ‡ç™»å…¥
                await liff.init({ liffId: "2008786875-7COWtgtL" });
                if (!liff.isLoggedIn()) { liff.login(); return; }

                const profile = await liff.getProfile();
                state.uid = profile.userId;

                // 2. ç²å–è³‡æ–™
                document.getElementById('loading-text').innerText = "æ­£åœ¨åŒæ­¥å³¶å…§èª²ç¨‹...";
                const evData = await robustFetch(`${PROXY_URL}?action=getEvents`);
                const memData = await robustFetch(`${PROXY_URL}?action=getFamily&uid=${state.uid}`);

                if (!evData || !evData.data) throw new Error("Cloudflare å›å‚³æ´»å‹•æ•¸æ“šæ ¼å¼éŒ¯èª¤");

                state.event = evData.data.find(e => String(e['æ´»å‹•ID']) === String(eventId));
                if (!state.event) { alert("èª²ç¨‹å·²ä¸‹æ¶æˆ–æ‰¾ä¸åˆ°è³‡æ–™"); safeNavigate('index.html'); return; }

                state.members = memData.data || [];
                state.allRentals = JSON.parse(evData.config.rentalItems || "[]");

                // 3. åƒ¹æ ¼åˆå§‹åŒ–
                const now = new Date();
                const deadline = state.event['æ—©é³¥æˆªæ­¢æ—¥æœŸ'] ? new Date(state.event['æ—©é³¥æˆªæ­¢æ—¥æœŸ']) : null;
                const earlyPrice = parseInt(state.event['å…¨æ—¥æ—©é³¥åƒ¹']);
                if (deadline && now <= deadline && earlyPrice > 0) {
                    state.basePrice = earlyPrice;
                    document.getElementById('early-bird-tag').classList.remove('hidden');
                    document.getElementById('summary-price-note').innerText = "âœ¨ æœ¬æ¬¡å·²äº«æ—©é³¥å„ªæƒ åƒ¹";
                } else {
                    state.basePrice = parseInt(state.event['å…¨æ—¥åƒ¹'] || 0);
                }

                document.getElementById('event-name').innerText = state.event['æ´»å‹•åç¨±'];
                document.getElementById('event-info').innerText = `${state.event['æ´»å‹•å‹æ…‹']} | ${state.event['åˆ†é¡']}`;
                
                renderMembers();
                switchView('member');
                document.getElementById('view-loading').style.display='none';

            } catch (e) {
                console.error("Init Failure:", e);
                document.getElementById('loading-text').innerText = "ç¶²è·¯é€£ç·šç•°å¸¸";
                document.getElementById('loading-text').classList.add('text-red-500');
                debugPanel.classList.remove('hidden');
                errorMsg.innerText = `[Error Diagnosis]\nMessage: ${e.message}\nTarget: ${PROXY_URL}\nStack: ${e.stack ? e.stack.substring(0,100) : 'N/A'}`;
            }
        }

        function renderMembers() {
            document.getElementById('member-list').innerHTML = state.members.map(m => `
                <div onclick="selectMember('${m.å­¸å“¡ID}')" class="selection-item">
                    <div class="flex items-center gap-4"><div class="w-12 h-12 bg-blue-50 text-[#1877f2] rounded-2xl flex items-center justify-center font-black italic shadow-inner">${(m.å§“å||"?").charAt(0)}</div><p class="font-black text-xl text-slate-800">${m.å§“å}</p></div>
                    <span class="text-[#1877f2] font-black italic text-xs">SELECT âœ</span>
                </div>`).join('') || '<p class="text-center py-10 text-slate-300 italic">å°šæœªè¨»å†Šæˆå“¡è³‡æ–™</p>';
        }

        function selectMember(id) {
            state.selectedMember = state.members.find(m => String(m.å­¸å“¡ID) === id);
            document.getElementById('summary-member').innerText = state.selectedMember.å§“å;
            renderDynamicInterface();
            renderRentals();
            switchView('details');
        }

        function renderDynamicInterface() {
            const container = document.getElementById('dynamic-booking-ui');
            const type = state.event['æ´»å‹•å‹æ…‹'];
            state.leaves = {}; 

            if(type === 'æ¢¯æ¬¡å‹') {
                const batches = JSON.parse(state.event['æ¢¯æ¬¡è³‡æ–™'] || "[]");
                container.innerHTML = `<label class="block font-black text-slate-400 text-xs mb-4 uppercase tracking-widest text-left">è«‹é¸æ“‡åƒåŠ æ¢¯æ¬¡ï¼š</label>
                    <div class="space-y-4 mb-8">${batches.map(b => `
                        <div onclick="pickBatch('${b.n}', '${b.s}', '${b.e}', this)" class="selection-item">
                            <div class="text-left"><p class="font-black text-xl text-slate-800">${b.n}</p>
                            <!-- âœ¨ æ—¥æœŸå‘ˆç¾ï¼šç´”é»‘ã€ä¸åŠ ç²— -->
                            <p class="text-sm text-island-black italic">${b.s.substring(5,10)} ~ ${b.e.substring(5,10)}</p></div>
                            <span class="bg-blue-50 text-[#1877f2] px-4 py-2 rounded-xl text-[10px] font-black uppercase">é¸å–</span>
                        </div>`).join('')}</div>
                    <div id="batch-calendar-area" class="hidden border-t pt-8">
                        <label class="block font-black text-slate-400 text-xs mb-4 uppercase text-left tracking-widest">ä¸å‡ºå¸­æ—¥æ‰£æŠµè¨­å®šï¼š</label>
                        <div id="batch-cal" class="calendar-grid"></div>
                    </div>`;
            } else if(type === 'å¸¸æ…‹å‹') {
                container.innerHTML = `<div class="bg-emerald-50 p-6 rounded-3xl border-2 border-emerald-100 mb-8 text-left">
                    <p class="text-emerald-700 text-sm font-bold leading-relaxed">å­¸æœŸå¸¸æ…‹èª²ç¨‹åŒ…å«æ‰€æœ‰å›ºå®šä¸Šèª²æ—¥ã€‚å¦‚æœ‰å·²çŸ¥ä¸å‡ºå¸­æ—¥ï¼Œè«‹æ–¼ä¸‹æ–¹é å…ˆå‹¾é¸ä»¥æ‰£æŠµå­¸è²»ã€‚</p>
                    </div><div id="term-cal" class="calendar-grid"></div>`;
                state.selectedBatch = "å…¨å­¸æœŸèª²ç¨‹";
                generateCalendar('term', state.event['é–‹å§‹æ—¥æœŸ'], state.event['çµæŸæ—¥æœŸ']);
            } else {
                container.innerHTML = `<div class="bg-blue-50 p-8 rounded-[2rem] border-2 border-blue-100 text-center">
                    <h4 class="text-xl font-black text-blue-800 italic mb-2">å–®æ—¥å°ˆæ¡ˆ/é«”é©—æ´»å‹•</h4>
                    <p class="text-island-black text-xs font-normal mb-2 tracking-widest uppercase">${state.event['é–‹å§‹æ—¥æœŸ']}</p>
                </div>`;
                state.selectedBatch = "å–®æ—¥å°ˆæ¡ˆ";
            }
            updatePrice();
        }

        function pickBatch(name, start, end, el) {
            state.selectedBatch = name;
            document.querySelectorAll('.selection-item').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('batch-calendar-area').classList.remove('hidden');
            generateCalendar('batch', start, end);
        }

        function generateCalendar(mode, sDate, eDate) {
            const container = document.getElementById(mode === 'batch' ? 'batch-cal' : 'term-cal');
            const start = new Date(sDate.substring(0,10));
            const end = new Date(eDate.substring(0,10));
            const activeWeekdays = (state.event['æ¢¯æ¬¡è³‡æ–™'] || "").split(',').map(Number);
            let html = ""; let curr = new Date(start);
            while(curr <= end) {
                const dStr = curr.toISOString().split('T')[0];
                if (mode === 'term' ? activeWeekdays.includes(curr.getDay()) : true) {
                    if(!state.leaves[dStr]) state.leaves[dStr] = 'attend';
                    html += `<div id="day-${dStr}" onclick="openLeaveMenu('${dStr}')" class="cal-day status-attend">
                        <span>${curr.getDate()}</span><span id="lb-${dStr}" class="day-label">å‡ºå¸­</span></div>`;
                } else {
                    html += `<div class="cal-day status-disabled"><span>${curr.getDate()}</span></div>`;
                }
                curr.setDate(curr.getDate() + 1);
            }
            container.innerHTML = html;
            updatePrice();
        }

        function openLeaveMenu(d) { state.currentFocusDate = d; document.getElementById('menu-date-title').innerText = `${d.substring(5)} ä¿®æ”¹ç‹€æ…‹`; document.getElementById('overlay').style.display='block'; document.getElementById('leave-menu').classList.add('active'); }
        function closeLeaveMenu() { document.getElementById('overlay').style.display='none'; document.getElementById('leave-menu').classList.remove('active'); }
        function updateDayStatus(s) {
            state.leaves[state.currentFocusDate] = s;
            const el = document.getElementById(`day-${state.currentFocusDate}`);
            const lb = document.getElementById(`lb-${state.currentFocusDate}`);
            const config = { 'attend': ['status-attend','å‡ºå¸­'], 'full': ['status-absent-full','å…¨å‡'], 'morning': ['status-absent-half','ä¸Šå‡'], 'afternoon': ['status-absent-half','ä¸‹å‡'] };
            el.className = `cal-day ${config[s][0]}`; lb.innerText = config[s][1];
            closeLeaveMenu(); updatePrice();
        }

        function renderRentals() {
            const allowed = (state.event['å…§å®¹åª’é«”'] || "").split(',').filter(i=>i);
            const items = state.allRentals.filter(i => allowed.includes(i.name));
            if(items.length === 0) { document.getElementById('rental-area').classList.add('hidden'); return; }
            document.getElementById('rental-area').classList.remove('hidden');
            document.getElementById('rental-list').innerHTML = items.map(it => `
                <label class="rent-card">
                    <div class="flex items-center gap-3"><input type="checkbox" onchange="toggleRent('${it.name}', ${it.price})" class="w-6 h-6 accent-[#1877f2]"><span class="font-bold text-slate-700">${it.name}</span></div>
                    <span class="text-island-black italic">+$${it.price}</span>
                </label>`).join('');
        }

        function toggleRent(name, price) {
            const idx = state.rentals.findIndex(i => i.name === name);
            if(idx > -1) state.rentals.splice(idx, 1); else state.rentals.push({name, price});
            updatePrice();
        }

        function updatePrice() {
            let deduction = 0;
            Object.values(state.leaves).forEach(v => {
                if(v === 'full') deduction += Number(state.event['å…¨æ—¥æ‰£é™¤'] || 0);
                else if(v === 'morning' || v === 'afternoon') deduction += Number(state.event['åŠæ—¥æ‰£é™¤'] || 0);
            });
            const rentTotal = state.rentals.reduce((a, b) => a + b.price, 0);
            const final = state.basePrice - deduction + rentTotal;
            document.getElementById('footer-price').innerText = `NT$ ${final.toLocaleString()}`;
            document.getElementById('final-amount').innerText = `NT$ ${final.toLocaleString()}`;
            document.getElementById('summary-target').innerText = state.selectedBatch || "æœªé¸é …ç›®";
            if(deduction > 0) { 
                document.getElementById('summary-deduction-area').classList.remove('hidden'); 
                document.getElementById('summary-deduction').innerText = `- NT$ ${deduction.toLocaleString()}`; 
            } else { document.getElementById('summary-deduction-area').classList.add('hidden'); }
        }

        function switchView(v) { 
            ['member', 'details', 'checkout'].forEach((i, idx) => {
                document.getElementById('view-' + i).classList.toggle('hidden', i !== v);
                const dot = document.getElementById('step-' + (idx + 1));
                if (dot) dot.classList.toggle('active', i === v || ['member', 'details', 'checkout'].indexOf(i) < ['member', 'details', 'checkout'].indexOf(v));
            });
            document.getElementById('footer-bar').classList.toggle('hidden', v !== 'details');
            window.scrollTo(0,0);
        }

        async function submitBooking() {
            const b5 = document.getElementById('bank-5').value;
            if(b5.length < 5) return alert("è«‹è¼¸å…¥æ­£ç¢ºåŒ¯æ¬¾å¾Œäº”ç¢¼");
            if(!state.selectedBatch) return alert("è«‹å…ˆé¸å–åƒåŠ é …ç›®");
            const btn = document.getElementById('btn-submit'); btn.disabled = true; btn.innerText = "å‚³é€ä¸­...";
            const payload = { student: state.selectedMember, eventId: state.event['æ´»å‹•ID'], eventName: state.event['æ´»å‹•åç¨±'], amount: parseInt(document.getElementById('final-amount').innerText.replace(/\D/g,'')), bankLast5: b5, selectedBatch: state.selectedBatch, selectedDates: Object.entries(state.leaves).filter(e => e[1] !== 'attend').map(e => `${e[0]}:${e[1]}`).join('|') || 'å…¨å‹¤', rentedItems: state.rentals.map(r => r.name).join(',') };
            
            try {
                const res = await robustFetch(PROXY_URL, { method: 'POST', body: JSON.stringify({ action: 'submitRegistration', payload }) });
                if(res.status === 'success') { alert("ğŸ‰ é ç´„æˆåŠŸï¼è³‡æ–™å·²åŒæ­¥ã€‚"); safeNavigate('index.html'); }
            } catch(e) { alert("å‚³é€å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²è·¯å¾Œé‡è©¦"); btn.disabled = false; }
        }
        window.onload = init;
    </script>
</body>
</html>
