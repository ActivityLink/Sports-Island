<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é ç´„èˆ‡è«‹å‡å®‰æ’ - é‹å‹•å³¶</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f4f7f9; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .main-container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 120px; }
        .content-card { background: white; border-radius: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); padding: 24px; margin-bottom: 16px; border: 1px solid #edf2f7; }
        
        /* æœˆæ›†ç¶²æ ¼æ¨£å¼ */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; margin-top: 10px; }
        .cal-header { text-align: center; font-size: 10px; font-weight: 900; color: #94a3b8; padding-bottom: 8px; }
        .cal-day { aspect-ratio: 1; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 13px; font-weight: 900; cursor: pointer; position: relative; transition: 0.2s; border: 2px solid transparent; }
        
        /* ç‹€æ…‹é¡è‰²ï¼šæ¶ˆå»æ³•é‚è¼¯ */
        .status-attending { background: #eff6ff; color: #1d4ed8; border-color: #dbeafe; } /* é è¨­ï¼šå‡ºå¸­ */
        .status-absent-full { background: #fee2e2; color: #b91c1c; border-color: #fecaca; } /* å…¨æ—¥è«‹å‡ */
        .status-absent-half { background: #ffedd5; color: #c2410c; border-color: #fed7aa; } /* åŠæ—¥è«‹å‡ */
        .status-disabled { background: #f8fafc; color: #cbd5e1; cursor: default; } /* éæ´»å‹•æ—¥ */

        .status-label { font-size: 8px; margin-top: 2px; font-weight: 700; }

        /* å½ˆå‡ºé¸æ“‡é¸å–® */
        .leave-menu { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 24px 24px 0 0; padding: 24px; z-index: 1000; box-shadow: 0 -10px 25px rgba(0,0,0,0.1); transform: translateY(100%); transition: 0.3s; }
        .leave-menu.active { transform: translateY(0); }
        .menu-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 999; display: none; }
        .menu-overlay.active { display: block; }

        .btn-primary { background: #2563eb; color: white; padding: 18px; border-radius: 16px; font-weight: 900; width: 100%; cursor: pointer; border: none; font-size: 16px; }
        .section-view { display: none; }
        .section-view.active { display: block; animation: slideUp 0.4s ease; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- 0. è®€å–ä¸­ -->
        <div id="view-loading" class="text-center py-20 section-view active">
            <div class="inline-block w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 font-black text-slate-400 text-[10px] tracking-widest uppercase">System Initializing...</p>
        </div>

        <!-- 1. é¸æ“‡æˆå“¡ -->
        <div id="view-member" class="section-view">
            <h2 class="text-2xl font-black mb-6 italic tracking-tighter">STEP 1. é¸æ“‡æˆå“¡</h2>
            <div id="member-list" class="grid gap-3"></div>
            <button onclick="safeNavigate('register.html?mode=add')" class="w-full mt-6 py-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-black text-sm hover:bg-white">+ æ–°å¢å®¶äººè³‡è¨Š</button>
        </div>

        <!-- 2. æ—¥æ›†è«‹å‡å®‰æ’ -->
        <div id="view-details" class="section-view">
            <button onclick="switchView('member')" class="mb-4 text-slate-400 font-bold text-xs">â¬… ä¸Šä¸€æ­¥</button>
            
            <div class="content-card">
                <h2 id="event-name" class="text-xl font-black text-blue-600 mb-1">---</h2>
                <p id="early-bird-hint" class="text-[10px] font-black text-green-600 hidden">âœ¨ æ—©é³¥å„ªæƒ å·²å¥—ç”¨</p>

                <!-- æ—¥æ›†ç¶²æ ¼å€åŸŸ -->
                <div class="mt-8">
                    <div class="flex justify-between items-end mb-2">
                        <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest">è«‹å‡å®‰æ’ (é»æ“Šæ—¥æœŸä¿®æ”¹ç‹€æ…‹)</label>
                        <span id="calendar-month" class="font-black text-sm text-slate-800">2025å¹´ 1æœˆ</span>
                    </div>
                    <div class="calendar-grid">
                        <div class="cal-header">æ—¥</div><div class="cal-header">ä¸€</div><div class="cal-header">äºŒ</div><div class="cal-header">ä¸‰</div><div class="cal-header">å››</div><div class="cal-header">äº”</div><div class="cal-header">å…­</div>
                    </div>
                    <div id="cal-body" class="calendar-grid">
                        <!-- ç”± JS ç”Ÿæˆ -->
                    </div>
                </div>
            </div>

            <!-- è¨­å‚™ç§Ÿå€Ÿ -->
            <div id="rental-section" class="content-card hidden">
                <label class="block text-[10px] font-black text-blue-500 uppercase mb-4 tracking-widest">é¸è³¼è¨­å‚™ç§Ÿå€Ÿ (å¤šé¸)</label>
                <div id="rental-options" class="space-y-2"></div>
            </div>

            <!-- æµ®å‹•è¨ˆè²»ç¸½é¡æ¬„ -->
            <div class="fixed bottom-0 left-0 right-0 bg-white p-6 border-t shadow-2xl flex items-center justify-between z-[50]">
                <div>
                    <p class="text-[10px] font-black text-slate-400 uppercase">æ‡‰ä»˜ç¸½é¡ Total</p>
                    <p id="price-total" class="text-2xl font-black italic text-blue-600">NT$ 0</p>
                </div>
                <button onclick="switchView('checkout')" class="bg-blue-600 text-white px-8 py-3 rounded-xl font-black text-sm shadow-lg">ä¸‹ä¸€æ­¥ âœ</button>
            </div>
        </div>

        <!-- 3. æœ€å¾Œçµå¸³ -->
        <div id="view-checkout" class="section-view">
            <button onclick="switchView('details')" class="mb-4 text-slate-400 font-bold text-xs">â¬… è¿”å›ä¿®æ”¹è«‹å‡</button>
            <div class="content-card">
                <h2 class="text-xl font-black mb-8 border-b pb-4">ç¢ºèªå ±åè³‡è¨Š</h2>
                <div class="space-y-4 mb-8">
                    <div class="flex justify-between text-xs font-bold text-slate-400"><span>åŸºç¤èª²ç¨‹è²»ç”¨</span><span id="final-base">NT$ 0</span></div>
                    <div class="flex justify-between text-xs font-bold text-red-500"><span>ä¸å‡ºå¸­å¤©æ•¸æ‰£é™¤</span><span id="final-deduct">- NT$ 0</span></div>
                    <div class="flex justify-between text-xs font-bold text-blue-500"><span>è¨­å‚™ç§Ÿç”¨å°è¨ˆ</span><span id="final-rent">NT$ 0</span></div>
                </div>

                <div class="mb-8">
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-2">åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
                    <input type="text" id="bank-5" class="w-full border-2 rounded-xl p-4 font-black bg-slate-50 outline-none focus:border-blue-600" maxlength="5" placeholder="å¡«å¯«äº”ç¢¼ä¾›åº—å®¶æ ¸å¸³">
                </div>

                <button onclick="submitRegistration()" id="btn-submit" class="btn-primary shadow-xl italic uppercase tracking-tighter">Confirm Registration âœ</button>
            </div>
        </div>
    </div>

    <!-- è«‹å‡é¸å–® Modal -->
    <div id="menu-overlay" class="menu-overlay" onclick="closeLeaveMenu()"></div>
    <div id="leave-menu" class="leave-menu">
        <h3 id="menu-date-title" class="text-lg font-black mb-6">ä¿®æ”¹ 2025-01-20 ç‹€æ…‹</h3>
        <div class="grid grid-cols-2 gap-3 mb-6">
            <button onclick="updateDayStatus('å‡ºå¸­')" class="p-4 border-2 rounded-xl font-black text-sm hover:bg-blue-50">æ¢å¾©å‡ºå¸­</button>
            <button onclick="updateDayStatus('å…¨æ—¥')" class="p-4 border-2 border-red-100 bg-red-50 text-red-600 rounded-xl font-black text-sm">å…¨æ—¥è«‹å‡</button>
            <button onclick="updateDayStatus('ä¸Šåˆ')" class="p-4 border-2 border-orange-100 bg-orange-50 text-orange-600 rounded-xl font-black text-sm">ä¸Šåˆè«‹å‡</button>
            <button onclick="updateDayStatus('ä¸‹åˆ')" class="p-4 border-2 border-orange-100 bg-orange-50 text-orange-600 rounded-xl font-black text-sm">ä¸‹åˆè«‹å‡</button>
        </div>
        <button onclick="closeLeaveMenu()" class="w-full py-3 text-slate-400 font-bold text-sm">å–æ¶ˆ</button>
    </div>

    <script>
        const LIFF_ID = "2008786875-7COWtgtL";
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        const eventId = new URLSearchParams(window.location.search).get('id');

        let state = { 
            uid: null, event: null, members: [], config: {}, 
            selectedMember: null, leaves: {}, rentedItems: [], isEarlyBird: false,
            currentFocusDate: null
        };

        function safeNavigate(t) { if (window.location.protocol==='blob:'){ console.warn("Blob skip: "+t); return; } window.location.href=t; }

        async function init() {
            if (!eventId) { safeNavigate('index.html'); return; }
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const p = await liff.getProfile();
                state.uid = p.userId;

                const [evRes, memRes] = await Promise.all([
                    fetch(`${PROXY_URL}?action=getEvents`),
                    fetch(`${PROXY_URL}?action=getFamily&uid=${state.uid}`)
                ]);
                const evData = await evRes.json();
                const memData = await memRes.json();

                state.event = evData.data.find(e => String(e['æ´»å‹•ID']) === String(eventId));
                state.config = evData.config || {};
                state.members = memData.data || [];

                if (!state.event) { alert("æ´»å‹•ä¸å­˜åœ¨"); safeNavigate('index.html'); return; }

                // æ—©é³¥åˆ¤æ–·
                const deadline = new Date(state.event['æ—©é³¥æˆªæ­¢æ—¥æœŸ']);
                state.isEarlyBird = !isNaN(deadline.getTime()) && (new Date() <= deadline);
                if(state.isEarlyBird) document.getElementById('early-bird-hint').classList.remove('hidden');

                document.getElementById('event-name').innerText = state.event['æ´»å‹•åç¨±'];
                
                renderMembers();
                renderCalendar();
                renderRentalOptions();
                switchView('member');
            } catch (e) { console.error(e); }
        }

        function renderMembers() {
            const container = document.getElementById('member-list');
            if(state.members.length === 0) { safeNavigate('register.html?mode=add'); return; }
            container.innerHTML = state.members.map(m => `
                <div onclick="selectMember('${m.å­¸å“¡ID}')" class="bg-white p-5 rounded-2xl border border-slate-100 cursor-pointer flex justify-between items-center hover:shadow-md transition-all">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-600 text-white rounded-xl flex items-center justify-center font-black italic text-xl">${m.å§“å.charAt(0)}</div>
                        <div><p class="font-black text-base text-slate-800">${m.å§“å}</p><p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">${m.èº«åˆ† || 'MEMBER'}</p></div>
                    </div>
                    <div class="text-blue-600 font-black text-xs">SELECT âœ</div>
                </div>`).join('');
        }

        function renderCalendar() {
            const container = document.getElementById('cal-body');
            const start = new Date(state.event['é–‹å§‹æ—¥æœŸ']);
            const end = new Date(state.event['çµæŸæ—¥æœŸ']);
            
            // æ±ºå®šé¡¯ç¤ºå“ªå€‹æœˆ
            document.getElementById('calendar-month').innerText = `${start.getFullYear()}å¹´ ${start.getMonth()+1}æœˆ`;

            // è¨ˆç®—å¡«è£œï¼ˆç¬¬ä¸€å¤©æ˜ŸæœŸå¹¾ï¼‰
            const firstDayOfWeek = new Date(start.getFullYear(), start.getMonth(), 1).getDay();
            let html = "";
            for (let i = 0; i < firstDayOfWeek; i++) {
                html += `<div class="cal-day status-disabled"></div>`;
            }

            // ç”Ÿæˆæ—¥æœŸå¤©æ•¸
            let current = new Date(start);
            while (current <= end) {
                const dStr = current.toISOString().split('T')[0];
                const dayNum = current.getDate();
                
                // é è¨­å…¨å‡ºå¸­ï¼ˆæ¶ˆå»æ³•æ ¸å¿ƒï¼‰
                if(!state.leaves[dStr]) state.leaves[dStr] = 'å‡ºå¸­'; 

                html += `
                <div id="day-${dStr}" onclick="openLeaveMenu('${dStr}')" class="cal-day status-attending">
                    <span>${dayNum}</span>
                    <span id="label-${dStr}" class="status-label">å‡ºå¸­</span>
                </div>`;
                current.setDate(current.getDate() + 1);
            }
            container.innerHTML = html;
            calculatePrice();
        }

        function openLeaveMenu(date) {
            state.currentFocusDate = date;
            document.getElementById('menu-date-title').innerText = `ä¿®æ”¹ ${date} ç‹€æ…‹`;
            document.getElementById('menu-overlay').classList.add('active');
            document.getElementById('leave-menu').classList.add('active');
        }

        function closeLeaveMenu() {
            document.getElementById('menu-overlay').classList.remove('active');
            document.getElementById('leave-menu').classList.remove('active');
        }

        function updateDayStatus(status) {
            const date = state.currentFocusDate;
            state.leaves[date] = status;
            const el = document.getElementById(`day-${date}`);
            const label = document.getElementById(`label-${date}`);
            
            // æ›´æ–° UI ç‹€æ…‹é¡è‰²
            el.className = "cal-day " + (status === 'å‡ºå¸­' ? 'status-attending' : (status === 'å…¨æ—¥' ? 'status-absent-full' : 'status-absent-half'));
            label.innerText = status === 'å‡ºå¸­' ? 'å‡ºå¸­' : status + 'å‡';
            
            calculatePrice();
            closeLeaveMenu();
        }

        function renderRentalOptions() {
            const items = JSON.parse(state.config.rentalItems || "[]");
            if (items.length === 0) return;
            document.getElementById('rental-section').classList.remove('hidden');
            document.getElementById('rental-options').innerHTML = items.map((item, i) => `
                <label class="flex items-center justify-between p-4 border rounded-2xl bg-slate-50 cursor-pointer hover:bg-blue-50">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" onchange="updateRental(${i}, this.checked)" class="w-5 h-5 accent-blue-600">
                        <span class="font-bold text-sm">${item.name}</span>
                    </div>
                    <span class="font-black text-blue-600">$${item.price}</span>
                </label>`).join('');
        }

        function updateRental(idx, checked) {
            const items = JSON.parse(state.config.rentalItems || "[]");
            if (checked) state.rentedItems.push(items[idx]);
            else state.rentedItems = state.rentedItems.filter(it => it.name !== items[idx].name);
            calculatePrice();
        }

        function calculatePrice() {
            // åŸºç¤åƒ¹æ ¼ (å–®æ—¥åƒ¹ x æ´»å‹•ç¯„åœç¸½å¤©æ•¸)
            const unitPrice = state.isEarlyBird ? Number(state.event['å…¨æ—¥æ—©é³¥åƒ¹'] || state.event['å…¨æ—¥åƒ¹']) : Number(state.event['å…¨æ—¥åƒ¹']);
            const totalActiveDays = Object.keys(state.leaves).length;
            const originalTotal = unitPrice * totalActiveDays;

            // è«‹å‡æ‰£é™¤é‡‘é¡
            let totalDeduction = 0;
            const fullDeduct = Number(state.event['å…¨æ—¥æ‰£é™¤'] || 0);
            const halfDeduct = Number(state.event['åŠæ—¥æ‰£é™¤'] || 0);

            Object.values(state.leaves).forEach(v => {
                if (v === 'å…¨æ—¥') totalDeduction += fullDeduct;
                if (v === 'ä¸Šåˆ' || v === 'ä¸‹åˆ') totalDeduction += halfDeduct;
            });

            const rentalTotal = state.rentedItems.reduce((acc, it) => acc + Number(it.price), 0);
            state.finalTotal = originalTotal - totalDeduction + rentalTotal;

            // UI é¡¯ç¤º
            document.getElementById('price-total').innerText = `NT$ ${state.finalTotal.toLocaleString()}`;
            document.getElementById('final-base').innerText = `NT$ ${originalTotal.toLocaleString()}`;
            document.getElementById('final-deduct').innerText = `- NT$ ${totalDeduction.toLocaleString()}`;
            document.getElementById('final-rent').innerText = `NT$ ${rentalTotal.toLocaleString()}`;
        }

        function selectMember(mid) { state.selectedMember = state.members.find(m => String(m.å­¸å“¡ID) === String(mid)); switchView('details'); }

        async function submitRegistration() {
            const b5 = document.getElementById('bank-5').value;
            if (b5.length < 5) return alert("è«‹è¼¸å…¥äº”ç¢¼");
            document.getElementById('btn-submit').disabled = true;
            document.getElementById('btn-submit').innerText = "æäº¤é ç´„ä¸­...";

            // æ•´ç†è«‹å‡å‚™è¨»
            const leaveDetails = Object.entries(state.leaves).filter(e => e[1] !== 'å‡ºå¸­').map(e => `${e[0]}(${e[1]}å‡)`).join(', ');

            const payload = {
                student: state.selectedMember,
                eventId: state.event['æ´»å‹•ID'],
                eventName: state.event['æ´»å‹•åç¨±'],
                amount: state.finalTotal,
                bankLast5: b5,
                rentedItems: state.rentedItems.map(it => it.name),
                selectedDates: leaveDetails || 'ç„¡è«‹å‡(å…¨å‹¤)'
            };

            const res = await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify({ action: 'submitRegistration', payload }) });
            if ((await res.json()).status === 'success') {
                alert("ğŸ‰ é ç´„æˆåŠŸï¼åº—å®¶æ ¸å¸³å¾Œæœƒé€šçŸ¥æ‚¨ã€‚");
                safeNavigate('index.html');
            }
        }

        function switchView(v) { document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active')); document.getElementById('view-' + v).classList.add('active'); window.scrollTo(0,0); }
        window.onload = init;
    </script>
</body>
</html>
