<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é ç´„å ±å - é‹å‹•å³¶</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .main-container { max-width: 600px; margin: 0 auto; padding: 16px; padding-bottom: 140px; }
        
        .content-card { background: white; border-radius: 32px; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.04); padding: 28px; margin-bottom: 20px; border: 1px solid #f1f5f9; }
        
        /* å°ˆç”¨æ¸…å–®æ¨£å¼ (è¦æ ¼åŒ–) */
        .batch-item { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; padding: 20px; border-radius: 20px; border: 2px solid transparent; cursor: pointer; transition: 0.3s; }
        .batch-item:hover { background: #f1f5f9; }
        .batch-item.active { border-color: #1877f2; background: #eef2ff; box-shadow: 0 8px 20px -5px rgba(24,119,242,0.15); }
        
        .btn-blue { background: #1877f2; color: white; padding: 18px 40px; border-radius: 20px; font-weight: 900; width: 100%; text-align: center; font-size: 18px; box-shadow: 0 10px 20px -5px rgba(24,119,242,0.3); transition: 0.2s; }
        .btn-blue:active { transform: scale(0.96); opacity: 0.9; }
        .btn-blue:disabled { background: #cbd5e1; box-shadow: none; cursor: not-allowed; }

        .sticky-footer { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border-top: 1px solid #f1f5f9; padding: 20px; box-shadow: 0 -10px 30px rgba(0,0,0,0.05); z-index: 100; }
        
        .step-indicator { display: flex; gap: 8px; margin-bottom: 24px; }
        .step-dot { height: 6px; flex: 1; border-radius: 10px; background: #e2e8f0; transition: 0.4s; }
        .step-dot.active { background: #1877f2; }

        .loading-ring { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #1877f2; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- å…¨åŸŸè¼‰å…¥é®ç½© -->
    <div id="view-loading" class="fixed inset-0 bg-white z-[2000] flex flex-col items-center justify-center">
        <div class="loading-ring"></div>
        <p class="mt-6 font-black text-slate-400 text-sm tracking-widest uppercase italic">é‹å‹•å³¶æ•¸æ“šå°æ¥ä¸­...</p>
    </div>

    <div class="main-container">
        <!-- æ­¥é©ŸæŒ‡ç¤ºå™¨ -->
        <div class="step-indicator">
            <div id="step-1" class="step-dot active"></div>
            <div id="step-2" class="step-dot"></div>
            <div id="step-3" class="step-dot"></div>
        </div>

        <!-- æ­¥é©Ÿ 1: é¸æ“‡å­¸å“¡ (è¦æ ¼åŒ–å…¥å£) -->
        <div id="view-member" class="hidden">
            <h2 class="text-3xl font-black mb-2 italic tracking-tight text-slate-800">é¸æ“‡é ç´„å­¸å“¡</h2>
            <p class="text-sm text-slate-400 font-bold mb-10 uppercase tracking-widest italic">Choose Student Profile</p>
            <div id="member-list" class="space-y-4"></div>
            <button onclick="safeNavigate('register.html?mode=add')" class="w-full mt-10 py-6 border-2 border-dashed border-slate-200 rounded-[2rem] text-slate-400 font-black hover:bg-white hover:border-slate-300 transition-all">+ æ–°å¢å®¶åº­æˆå“¡å€‹è³‡</button>
        </div>

        <!-- æ­¥é©Ÿ 2: å°ˆç”¨å ±åä»‹é¢ (å‹•æ…‹æ¸²æŸ“) -->
        <div id="view-details" class="hidden">
            <div class="content-card">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 id="event-name" class="text-2xl font-black text-slate-800 italic leading-tight">---</h2>
                        <span id="event-type-badge" class="inline-block mt-2 text-[10px] font-black bg-[#1877f2] text-white px-3 py-1 rounded-full uppercase tracking-tighter shadow-sm">---</span>
                    </div>
                </div>
                
                <!-- å‹•æ…‹æ³¨å…¥å€ï¼šä¾èª²ç¨‹ç¨®é¡é¡¯ç¤º UI -->
                <div id="dynamic-booking-ui" class="mt-10 min-h-[200px]">
                    <p class="text-center py-10 text-slate-300 italic">åˆå§‹åŒ–å°ˆç”¨å ±åä»‹é¢...</p>
                </div>
            </div>
            <button onclick="switchView('member')" class="w-full text-slate-400 font-bold text-xs uppercase mt-4">â¬… è¿”å›é‡æ–°é¸æ“‡å­¸å“¡</button>
        </div>

        <!-- æ­¥é©Ÿ 3: çµå¸³èˆ‡åŒ¯æ¬¾ -->
        <div id="view-checkout" class="hidden">
            <div class="content-card">
                <h2 class="text-2xl font-black mb-8 italic text-slate-800">å ±åæ‘˜è¦ç¢ºèª</h2>
                
                <div class="space-y-4 mb-10">
                    <div class="flex justify-between items-center py-4 border-b border-slate-50">
                        <span class="text-sm font-bold text-slate-400">å ±åå­¸å“¡</span>
                        <span id="summary-member" class="font-black text-slate-700">---</span>
                    </div>
                    <div class="flex justify-between items-center py-4 border-b border-slate-50">
                        <span class="text-sm font-bold text-slate-400">é¸å–é …ç›®/æ¢¯æ¬¡</span>
                        <span id="summary-target" class="font-black text-slate-700">---</span>
                    </div>
                    <div class="bg-blue-50/50 p-8 rounded-3xl text-center mt-8">
                        <p class="text-xs font-black text-[#1877f2] uppercase tracking-widest mb-2">æ‡‰ä»˜å­¸è²»ç¸½é¡</p>
                        <p id="final-amount" class="text-4xl font-black text-[#1877f2] italic">NT$ 0</p>
                    </div>
                </div>

                <label class="block text-[10px] font-black text-slate-400 uppercase mb-3 tracking-widest text-center">è«‹è¼¸å…¥åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼</label>
                <input type="text" id="bank-5" class="w-full border-2 border-slate-100 p-5 rounded-2xl mb-10 text-center font-black text-2xl outline-none focus:border-[#1877f2] transition-all bg-slate-50 focus:bg-white" maxlength="5" placeholder="00000">
                
                <button onclick="submitBooking()" id="btn-submit" class="btn-blue">ç¢ºèªä¸¦å®Œæˆå ±å âœ</button>
            </div>
            <button onclick="switchView('details')" class="w-full text-slate-400 font-bold text-xs uppercase mt-4">â¬… è¿”å›ä¿®æ”¹é ç´„å…§å®¹</button>
        </div>
    </div>

    <!-- åº•éƒ¨å‹•ä½œæ¢ -->
    <div id="footer-bar" class="sticky-footer hidden">
        <div class="max-w-[600px] mx-auto flex items-center justify-between gap-6">
            <div>
                <p class="text-[10px] font-black text-slate-400 uppercase">é è¨ˆæ‡‰ä»˜å­¸è²»</p>
                <p id="footer-price" class="text-xl font-black text-[#1877f2] italic">NT$ 0</p>
            </div>
            <button onclick="switchView('checkout')" class="btn-blue !w-auto !px-12 !py-4 shadow-lg">ä¸‹ä¸€æ­¥ âœ</button>
        </div>
    </div>

    <script>
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        const eventId = new URLSearchParams(window.location.search).get('id');
        
        let state = { 
            uid: null, 
            event: null, 
            members: [], 
            selectedMember: null, 
            selectedBatch: null,
            basePrice: 0 
        };

        /**
         * âœ¨ ç©©å®šå°èˆªï¼šè§£æ±ºé è¦½ç’°å¢ƒ 404 å•é¡Œ
         */
        function safeNavigate(target) {
            if (window.location.protocol === 'blob:') {
                alert("[é–‹ç™¼æ¸¬è©¦æ¨¡å¼] é è¦½ç’°å¢ƒä¸æ”¯æ´ç›´æ¥è·³è½‰ã€‚åœ¨æ­£å¼ç’°å¢ƒä¸­ï¼Œç³»çµ±å°‡å°å‘: " + target);
                console.log("Mock Navigation to:", target);
                return;
            }
            try {
                const url = new URL(target, window.location.href);
                window.location.href = url.href;
            } catch (e) {
                window.location.href = target;
            }
        }

        /**
         * âœ¨ å¾¹åº•æ­¸é›¶ç‹€æ…‹
         */
        function resetBookingSession() {
            state.selectedBatch = null;
            state.finalAmount = 0;
            const ui = document.getElementById('dynamic-booking-ui');
            if(ui) ui.innerHTML = '<p class="text-center py-10 text-slate-300 italic">åˆå§‹åŒ–ä¸­...</p>';
        }

        async function init() {
            resetBookingSession();
            try {
                // LIFF åˆå§‹åŒ–
                await liff.init({ liffId: "2008786875-7COWtgtL" });
                if (!liff.isLoggedIn() && liff.isInClient()) { liff.login(); return; }
                const p = liff.isLoggedIn() ? await liff.getProfile() : { userId: "DEBUG_USER" };
                state.uid = p.userId;

                // æŠ“å–é›²ç«¯æ´»å‹•èˆ‡æˆå“¡è³‡æ–™
                const [evRes, memRes] = await Promise.all([
                    fetch(`${PROXY_URL}?action=getEvents`),
                    fetch(`${PROXY_URL}?action=getFamily&uid=${state.uid}`)
                ]);
                
                const evData = await evRes.json();
                const memData = await memRes.json();

                // âœ¨ ä¿®å¾©é»ï¼šåœ¨å­˜å–å±¬æ€§å‰ç¢ºä¿æ´»å‹•è³‡æ–™å­˜åœ¨
                if (!evData.data || !Array.isArray(evData.data)) { throw new Error("æ´»å‹•åº«åŒæ­¥å¤±æ•—"); }
                
                state.event = evData.data.find(e => String(e['æ´»å‹•ID']) === String(eventId));
                
                if (!state.event) {
                    alert("æ‰¾ä¸åˆ°è©²æ´»å‹•çš„è¦æ ¼è¨­å®šï¼Œå°‡è¿”å›é¦–é ã€‚");
                    safeNavigate('index.html');
                    return;
                }

                state.members = memData.data || [];
                state.basePrice = parseInt(state.event['å…¨æ—¥åƒ¹'] || 0);
                
                // æ¸²æŸ“åŸºç¤ UI è³‡è¨Š
                document.getElementById('event-name').innerText = state.event['æ´»å‹•åç¨±'] || "æœªå‘½åæ´»å‹•";
                document.getElementById('event-type-badge').innerText = state.event['æ´»å‹•å‹æ…‹'] || "å–®æ—¥å‹";
                document.getElementById('footer-price').innerText = `NT$ ${state.basePrice.toLocaleString()}`;
                
                renderMembers();
                switchView('member');

            } catch (e) {
                console.error("Critical Init Error:", e);
                document.getElementById('view-loading').innerHTML = `
                    <div class="text-center p-10">
                        <p class="text-red-500 font-bold mb-4">é›²ç«¯è³‡æ–™åŒæ­¥å¤±æ•—</p>
                        <button onclick="location.reload()" class="btn-blue !w-auto !px-8">é»æ­¤é‡è©¦</button>
                    </div>`;
            } finally {
                document.getElementById('view-loading').style.display = 'none';
            }
        }

        function renderMembers() {
            const list = document.getElementById('member-list');
            if (state.members.length === 0) {
                list.innerHTML = `<p class="text-center py-10 text-slate-400 font-bold italic">ç›®å‰æˆå“¡åº«ç‚ºç©ºï¼Œè«‹é»æ“Šä¸‹æ–¹æ–°å¢</p>`;
                return;
            }
            list.innerHTML = state.members.map(m => `
                <div onclick="selectMember('${m.å­¸å“¡ID}')" class="batch-item">
                    <div class="flex items-center gap-4">
                        <div class="w-12 h-12 bg-blue-50 text-[#1877f2] rounded-2xl flex items-center justify-center font-black italic shadow-inner">${(m.å§“å||"ç„¡").charAt(0)}</div>
                        <div>
                            <p class="font-black text-xl text-slate-800">${m.å§“å || 'æœªå¡«å¯«å§“å'}</p>
                            <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">${m.å­¸æ ¡ || 'æ ¡å¤–äººå£«'} | ${m.å¹´ç´š || '-'}</p>
                        </div>
                    </div>
                    <span class="text-[#1877f2] font-black italic text-xs">SELECT âœ</span>
                </div>`).join('');
        }

        function selectMember(id) {
            state.selectedMember = state.members.find(m => String(m.å­¸å“¡ID) === id);
            document.getElementById('summary-member').innerText = state.selectedMember.å§“å;
            renderSpecializedUI();
            switchView('details');
        }

        /**
         * âœ¨ è¦æ ¼åŒ–å°ˆç”¨å ±åä»‹é¢æ¸²æŸ“ (è¶…è¶Šå¥èº«æˆ¿ç­‰ç´š)
         */
        function renderSpecializedUI() {
            const container = document.getElementById('dynamic-booking-ui');
            const type = state.event['æ´»å‹•å‹æ…‹'];

            if(type === 'æ¢¯æ¬¡å‹') {
                let batches = [];
                try { batches = JSON.parse(state.event['æ¢¯æ¬¡è³‡æ–™'] || "[]"); } catch(e) { batches = []; }
                
                if (batches.length === 0) {
                    container.innerHTML = `<p class="text-center py-20 text-slate-300 font-bold italic">æ­¤æ´»å‹•å°šæœªé…ç½®ä»»ä½•æ¢¯æ¬¡ï¼Œè«‹æ´½ç®¡ç†å“¡ã€‚</p>`;
                    return;
                }

                container.innerHTML = `
                    <label class="block font-black text-slate-400 text-xs mb-6 uppercase tracking-widest">è«‹é¸å–æ‚¨è¦åƒåŠ çš„æ¢¯æ¬¡æ™‚æ®µï¼š</label>
                    <div class="space-y-4">${batches.map((b, i) => `
                        <div onclick="pickBatch('${b.n}', this)" class="batch-item">
                            <div class="text-left">
                                <p class="font-black text-xl text-slate-800 mb-1">${b.n}</p>
                                <p class="text-xs text-slate-400 font-bold italic tracking-tighter">${b.s ? b.s.replace('T',' ') : ''} ~ ${b.e ? b.e.split('T')[1] : ''}</p>
                            </div>
                            <div class="text-right">
                                <span class="bg-blue-50 text-[#1877f2] px-4 py-2 rounded-xl text-[10px] font-black uppercase">é¸å–</span>
                            </div>
                        </div>`).join('')}</div>`;
            } else if(type === 'å¸¸æ…‹å‹') {
                container.innerHTML = `
                    <div class="bg-emerald-50 p-8 rounded-[2rem] border-2 border-emerald-100/50">
                        <div class="flex items-center gap-4 mb-6">
                            <span class="text-3xl">ğŸ—“ï¸</span>
                            <h4 class="text-xl font-black text-emerald-800 italic">å­¸æœŸå¸¸æ…‹èª²ç¨‹</h4>
                        </div>
                        <p class="text-emerald-700 text-sm font-medium leading-relaxed mb-8">
                            æœ¬èª²ç¨‹ç‚ºå­¸æœŸåˆ¶å›ºå®šé€±èª²ï¼Œå ±åå³åŒ…å«æ•´å­¸æœŸæ‰€æœ‰èª²ç¨‹æ—¥æœŸã€‚æˆ‘å€‘å°‡ç‚ºå­¸å“¡é ç•™å°ˆå±¬åé¡ã€‚
                        </p>
                        <div class="bg-white/60 p-5 rounded-2xl">
                            <p class="text-[10px] font-black text-emerald-600 uppercase mb-2 tracking-widest">ç›®å‰è¨­å®š</p>
                            <p class="font-black text-emerald-900">${state.event['æ¢¯æ¬¡è³‡æ–™'] || 'æ¯é€±å›ºå®šä¸Šèª²'}</p>
                        </div>
                    </div>`;
                state.selectedBatch = "æ•´å­¸æœŸå¸¸æ…‹èª²ç¨‹";
            } else {
                container.innerHTML = `
                    <div class="bg-blue-50 p-8 rounded-[2rem] border-2 border-blue-100/50 text-center">
                        <span class="text-4xl block mb-4">ğŸ·ï¸</span>
                        <h4 class="text-xl font-black text-[#1877f2] italic mb-2">å–®æ—¥/é«”é©—å°ˆæ¡ˆ</h4>
                        <p class="text-xs text-blue-400 font-black uppercase tracking-widest mb-6">${state.event['é–‹å§‹æ—¥æœŸ']}</p>
                        <p class="text-blue-700 text-sm font-medium leading-relaxed">
                            æœ¬é …ç›®ç‚ºå–®æ¬¡é«”é©—æˆ–å°ˆæ¡ˆæ´»å‹•ï¼Œé©åˆåˆå­¸è€…æˆ–çŸ­æœŸé€²ä¿®ã€‚
                        </p>
                    </div>`;
                state.selectedBatch = "å–®æ—¥å°ˆæ¡ˆæ´»å‹•";
            }
            document.getElementById('summary-target').innerText = state.selectedBatch || "æœªé¸å–";
            updateCalculation();
        }

        function pickBatch(name, el) {
            state.selectedBatch = name;
            document.querySelectorAll('.batch-item').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            document.getElementById('summary-target').innerText = name;
        }

        function updateCalculation() {
            document.getElementById('final-amount').innerText = `NT$ ${state.basePrice.toLocaleString()}`;
        }

        function switchView(v) { 
            const views = ['member', 'details', 'checkout'];
            views.forEach((i, idx) => {
                document.getElementById('view-' + i).classList.toggle('hidden', i !== v);
                const dot = document.getElementById('step-' + (idx + 1));
                if (dot) dot.classList.toggle('active', i === v || views.indexOf(i) < views.indexOf(v));
            });
            document.getElementById('footer-bar').classList.toggle('hidden', v !== 'details');
            window.scrollTo(0,0);
        }

        async function submitBooking() {
            const b5 = document.getElementById('bank-5').value;
            if(b5.length < 5) return alert("è«‹è¼¸å…¥åŒ¯æ¬¾å¸³è™Ÿå¾Œäº”ç¢¼ä»¥åˆ©å°å¸³");
            if(!state.selectedBatch) return alert("è«‹å…ˆé¸å–åƒåŠ æ™‚æ®µæˆ–æ¢¯æ¬¡");

            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = "é ç´„ä¸­ï¼Œè«‹å‹¿é›¢é–‹æ­¤ç•«é¢...";

            const payload = { 
                student: state.selectedMember, 
                eventId: state.event['æ´»å‹•ID'], 
                eventName: state.event['æ´»å‹•åç¨±'], 
                type: state.event['æ´»å‹•å‹æ…‹'],
                amount: state.basePrice, 
                bankLast5: b5, 
                selectedBatch: state.selectedBatch 
            };

            try {
                const res = await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify({ action: 'submitRegistration', payload }) });
                const r = await res.json();
                if(r.status === 'success') {
                    alert("ğŸ‰ é ç´„ç”³è«‹å·²æˆåŠŸé€å‡ºï¼è«‹ç¨å€™è€å¸«çš„é€šçŸ¥ã€‚");
                    safeNavigate('index.html');
                } else {
                    alert("ä¼ºæœå™¨å›æ‡‰ç•°å¸¸ï¼Œè«‹é‡æ–°å˜—è©¦ã€‚");
                    btn.disabled = false;
                }
            } catch (e) {
                alert("é€£ç·šè¶…æ™‚ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ç‹€æ…‹ã€‚");
                btn.disabled = false;
            }
        }

        window.onload = init;
    </script>
</body>
</html>
