<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆå“¡è³‡æ–™ç®¡ç† - é‹å‹•å³¶</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px 0; }
        .container { max-width: 500px; margin: 0 auto; padding: 0 15px; }
        
        /* å‚³çµ±å•†å‹™é¢¨æ ¼å¡ç‰‡ */
        .form-card { background: white; border: 1px solid #dcdfe6; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .card-header { padding: 15px 20px; border-bottom: 1px solid #ebeef5; background: #fbfbfc; font-weight: 700; color: #1a73e8; font-size: 16px; }
        .card-body { padding: 25px 20px; }

        .form-group { margin-bottom: 18px; }
        .form-label { display: block; font-size: 13px; font-weight: 700; color: #606266; margin-bottom: 6px; }
        .form-input { width: 100%; border: 1px solid #dcdfe6; border-radius: 4px; padding: 10px 12px; font-size: 14px; outline: none; transition: 0.2s; }
        .form-input:focus { border-color: #409eff; box-shadow: 0 0 0 2px rgba(64,158,255,0.1); }
        .form-input:disabled { background-color: #f5f7fa; color: #c0c4cc; cursor: not-allowed; }

        .btn { width: 100%; padding: 12px; border-radius: 4px; font-weight: 700; border: none; cursor: pointer; font-size: 15px; transition: 0.2s; }
        .btn-primary { background: #409eff; color: white; }
        .btn-primary:hover { background: #66b1ff; }
        .btn-primary:active { background: #3a8ee6; }

        .hint-text { font-size: 12px; color: #909399; mt-2; line-height: 1.5; }
        
        /* æ€§åˆ¥åˆ‡æ›å™¨æ¨£å¼ */
        .radio-group { display: flex; gap: 15px; padding-top: 5px; }
        .radio-label { display: flex; align-items: center; gap: 5px; font-size: 14px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="view-loading" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="animate-spin w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
        <p class="text-gray-400 text-sm">æ­£åœ¨è¼‰å…¥ç³»çµ±ä»‹é¢...</p>
    </div>

    <div class="container">
        <div class="form-card">
            <div class="card-header" id="page-title">æˆå“¡è³‡æ–™è¨­å®š</div>
            <div class="card-body">
                <form id="reg-form" onsubmit="handleSubmit(event)">
                    
                    <!-- å®¶é•·è³‡è¨Š (åƒ…åœ¨åˆæ¬¡è¨»å†Šæˆ–ç®¡ç†å“¡ç·¨è¼¯æ™‚é‡è¦) -->
                    <div class="form-group">
                        <label class="form-label">å®¶é•·å§“å</label>
                        <input type="text" id="parent-name" class="form-input" required placeholder="å¡«å¯«è¯ç¹«å®¶é•·å§“å">
                    </div>

                    <div class="form-group">
                        <label class="form-label">è¯ç¹«é›»è©±</label>
                        <input type="text" id="parent-phone" class="form-input" required placeholder="09xx-xxx-xxx">
                    </div>

                    <hr class="my-6 border-gray-100">

                    <!-- å­¸å“¡è³‡è¨Š -->
                    <div class="form-group">
                        <label class="form-label">å­¸å“¡å§“å</label>
                        <input type="text" id="student-name" class="form-input" required placeholder="å¡«å¯«åƒåŠ å­¸å“¡å§“å">
                    </div>

                    <div class="form-group">
                        <label class="form-label">å­¸å“¡æ€§åˆ¥</label>
                        <div class="radio-group">
                            <label class="radio-label"><input type="radio" name="gender" value="ç”·" checked> ç”·ç”Ÿ</label>
                            <label class="radio-label"><input type="radio" name="gender" value="å¥³"> å¥³ç”Ÿ</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">å‡ºç”Ÿæ—¥æœŸ</label>
                        <input type="date" id="student-birthday" class="form-input" required>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">å°±è®€å­¸æ ¡</label>
                            <input type="text" id="student-school" class="form-input" placeholder="ä¾‹å¦‚ï¼šæ–°ç«¹åœ‹å°">
                        </div>
                        <div class="form-group">
                            <label class="form-label">ç›®å‰å¹´ç´š</label>
                            <select id="student-grade" class="form-input" required>
                                <option value="">è«‹é¸æ“‡</option>
                                <option value="å¹¼å…’çµ„">å¹¼å…’çµ„ (å¤§/ä¸­/å°ç­)</option>
                                <option value="ä½å¹´ç´š">åœ‹å°ä½å¹´ç´š (1-2å¹´ç´š)</option>
                                <option value="ä¸­å¹´ç´š">åœ‹å°ä¸­å¹´ç´š (3-4å¹´ç´š)</option>
                                <option value="é«˜å¹´ç´š">åœ‹å°é«˜å¹´ç´š (5-6å¹´ç´š)</option>
                                <option value="åœ‹é«˜ä¸­">åœ‹é«˜ä¸­</option>
                                <option value="æˆäºº">æˆäºº</option>
                            </select>
                        </div>
                    </div>

                    <!-- ç­‰ç´šé¡¯ç¤º (å”¯è®€ï¼Œé™¤éæ˜¯ç®¡ç†å“¡) -->
                    <div class="form-group" id="level-group" style="display: none;">
                        <label class="form-label">ç›®å‰ç­æ¬¡ç­‰ç´š</label>
                        <input type="text" id="student-level" class="form-input" disabled value="åˆç´š">
                        <p class="hint-text">â€» ç­‰ç´šç”±æ•™ç·´æ ¹æ“šä¸Šèª²è¡¨ç¾æ ¸å®šï¼Œç„¡æ³•è‡ªè¡Œä¿®æ”¹ã€‚</p>
                    </div>

                    <div class="mt-10">
                        <button type="submit" id="btn-submit" class="btn btn-primary">å„²å­˜ä¸¦ç¢ºèªè³‡æ–™ ğŸ’¾</button>
                        <button type="button" onclick="history.back()" class="btn mt-3 border border-gray-200 text-gray-500 bg-white">å–æ¶ˆè¿”å›</button>
                    </div>
                </form>
            </div>
        </div>
        
        <p class="text-center text-[10px] text-gray-400 mt-6 px-4">
            æäº¤è³‡æ–™å³ä»£è¡¨æ‚¨åŒæ„é‹å‹•å³¶æ”¶é›†ä¸Šè¿°å€‹è³‡ç”¨æ–¼æ´»å‹•å ±åèˆ‡ä¿éšªæŠ•ä¿ã€‚
        </p>
    </div>

    <script>
        const LIFF_ID = "2008786875-7COWtgtL";
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/";
        const params = new URLSearchParams(window.location.search);
        const editId = params.get('edit');
        const mode = params.get('mode'); // 'add' ä»£è¡¨æ–°å¢å®¶åº­æˆå“¡

        let state = { uid: null, isEdit: !!editId };

        async function init() {
            try {
                await liff.init({ liffId: LIFF_ID });
                if (!liff.isLoggedIn()) { liff.login(); return; }
                const profile = await liff.getProfile();
                state.uid = profile.userId;

                if (state.isEdit) {
                    document.getElementById('page-title').innerText = "ç·¨è¼¯æˆå“¡è³‡æ–™";
                    document.getElementById('level-group').style.display = "block";
                    await loadMemberData(editId);
                } else if (mode === 'add') {
                    document.getElementById('page-title').innerText = "æ–°å¢å®¶åº­æˆå“¡";
                } else {
                    document.getElementById('page-title').innerText = "åˆæ¬¡ä½¿ç”¨è€…è¨»å†Š";
                }

                document.getElementById('view-loading').style.display = 'none';
            } catch (e) { alert("LIFF åˆå§‹åŒ–å¤±æ•—"); }
        }

        async function loadMemberData(id) {
            const res = await fetch(`${PROXY_URL}?action=getFamily&uid=${state.uid}`);
            const r = await res.json();
            const member = r.data.find(m => String(m.å­¸å“¡ID) === String(id));
            if (member) {
                document.getElementById('parent-name').value = member.å®¶é•·å§“å || '';
                document.getElementById('parent-phone').value = member.è¯ç¹«é›»è©± || '';
                document.getElementById('student-name').value = member.å§“å || '';
                document.getElementById('student-birthday').value = (member.ç”Ÿæ—¥ || '').substring(0, 10);
                document.getElementById('student-school').value = member.å­¸æ ¡ || '';
                document.getElementById('student-grade').value = member.å¹´ç´š || '';
                document.getElementById('student-level').value = member.ç­‰ç´š || 'åˆç´š';
                const genderInputs = document.getElementsByName('gender');
                for (let input of genderInputs) if (input.value === member.æ€§åˆ¥) input.checked = true;
            }
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.disabled = true; btn.innerText = "è³‡æ–™å‚³è¼¸ä¸­...";

            const payload = {
                action: state.isEdit ? 'updateRegistration' : 'registerUser',
                payload: {
                    uid: state.uid,
                    studentId: editId || 'SID' + Date.now(),
                    parentName: document.getElementById('parent-name').value,
                    parentPhone: document.getElementById('parent-phone').value,
                    studentName: document.getElementById('student-name').value,
                    gender: document.querySelector('input[name="gender"]:checked').value,
                    birthday: document.getElementById('student-birthday').value,
                    school: document.getElementById('student-school').value,
                    grade: document.getElementById('student-grade').value,
                    level: document.getElementById('student-level').value || 'åˆç´š'
                }
            };

            try {
                const res = await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify(payload) });
                const r = await res.json();
                if (r.status === 'success') {
                    alert("âœ… è³‡æ–™å·²æˆåŠŸå„²å­˜ï¼");
                    window.location.href = 'index.html';
                } else { throw new Error(r.message); }
            } catch (err) {
                alert("å„²å­˜å¤±æ•—ï¼š" + err.message);
                btn.disabled = false; btn.innerText = "å„²å­˜ä¸¦ç¢ºèªè³‡æ–™ ğŸ’¾";
            }
        }

        window.onload = init;
    </script>
</body>
</html>
