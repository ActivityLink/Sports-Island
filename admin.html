<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>活動規格專家 - 運動島</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; font-size: 16px; }
        .main-container { max-width: 1000px; margin: 0 auto; padding: 24px 16px; }
        .input-field { width: 100%; border: 1px solid #e2e8f0; border-radius: 12px; padding: 14px; font-weight: 500; outline: none; background: #fff; font-size: 16px; transition: 0.2s; }
        .input-field:focus { border-color: #1877f2; box-shadow: 0 0 0 4px rgba(24, 119, 242, 0.1); }
        .spec-card { background: white; border-radius: 24px; padding: 24px; border: 1px solid #e2e8f0; transition: 0.3s; }
        .btn-blue { background: #1877f2; color: white; padding: 14px 28px; border-radius: 12px; font-weight: 700; cursor: pointer; border: none; font-size: 16px; }
        .btn-blue:active { opacity: 0.8; transform: scale(0.98); }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 850px; border-radius: 32px; padding: 40px; margin-bottom: 50px; position: relative; }
        .type-pill { padding: 8px 20px; border-radius: 99px; background: #f1f5f9; color: #64748b; font-weight: 700; cursor: pointer; border: 2px solid transparent; }
        .type-pill.active { background: #eef2ff; color: #1877f2; border-color: #1877f2; }
        .session-row { background: #f8fafc; border-radius: 20px; padding: 20px; margin-bottom: 12px; border: 1px solid #e2e8f0; }
        .tag-label { display: block; font-size: 14px; font-weight: 700; color: #64748b; margin-bottom: 8px; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="flex justify-between items-center mb-10">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-slate-900 rounded-xl flex items-center justify-center shadow-lg"><span class="text-white font-black italic text-2xl">SI</span></div>
                <div>
                    <h1 class="text-xl font-black italic">規格化管理端</h1>
                    <p class="text-xs text-slate-400 font-bold uppercase tracking-widest">Industry Standard Console</p>
                </div>
            </div>
            <button onclick="EventManager.openEditor(null)" class="btn-blue shadow-lg">+ 新增專業規格</button>
        </div>

        <div id="admin-event-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- 由 JS 渲染 -->
        </div>
    </div>

    <!-- 專業化規格編輯器 -->
    <div id="editor-modal" class="modal-overlay" onclick="if(event.target===this) EventManager.closeEditor()">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-8 border-b pb-6">
                <div>
                    <h2 class="text-3xl font-black italic text-[#1877f2]">專業規格配置</h2>
                    <p class="text-xs text-slate-400 font-bold uppercase mt-1">Multi-Type Activity Architect</p>
                </div>
                <button onclick="EventManager.closeEditor()" class="text-slate-300 hover:text-red-500 text-4xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 overflow-y-auto max-h-[65vh] px-2 no-scrollbar">
                <!-- 種類切換 -->
                <div class="col-span-full">
                    <label class="tag-label">1. 請選擇課程專業類型</label>
                    <div class="flex gap-3">
                        <div onclick="EventManager.setType('單日型')" id="type-single" class="type-pill active">單日/體驗型</div>
                        <div onclick="EventManager.setType('梯次型')" id="type-batch" class="type-pill">梯次營隊型</div>
                        <div onclick="EventManager.setType('常態型')" id="type-term" class="type-pill">學期常態型</div>
                    </div>
                </div>

                <div class="col-span-full"><label class="tag-label">課程正式名稱</label><input type="text" id="ed-name" class="input-field" placeholder="例如：U12 菁英足球學期班"></div>
                <div><label class="tag-label">分類標籤</label><select id="ed-cat" class="input-field font-bold"></select></div>
                <div><label class="tag-label">主視覺圖片 URL</label><input type="text" id="ed-img" class="input-field"></div>

                <!-- 專用區域：梯次設定 -->
                <div id="area-batch" class="col-span-full bg-blue-50/50 p-8 rounded-[2rem] border-2 border-dashed border-blue-200 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <label class="tag-label !mb-0 text-[#1877f2]">梯次清單設定</label>
                        <button onclick="EventManager.appendSession()" class="bg-[#1877f2] text-white px-5 py-2 rounded-xl text-sm font-bold">+ 新增梯次</button>
                    </div>
                    <div id="session-list-container"></div>
                </div>

                <!-- 專用區域：學期常態設定 -->
                <div id="area-term" class="col-span-full bg-emerald-50/50 p-8 rounded-[2rem] border-2 border-dashed border-emerald-200 hidden">
                    <label class="tag-label text-emerald-700">固定上課星期設定</label>
                    <div class="grid grid-cols-4 gap-2">
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="1"> 週一</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="2"> 週二</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="3"> 週三</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="4"> 週四</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="5"> 週五</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="6"> 週六</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="0"> 週日</label>
                    </div>
                </div>

                <!-- 通用價格區 -->
                <div><label class="tag-label">活動開始日期</label><input type="date" id="ed-start" class="input-field"></div>
                <div><label class="tag-label">活動結束日期</label><input type="date" id="ed-end" class="input-field"></div>
                <div><label class="tag-label text-[#1877f2]">基礎學費總額 (全勤)</label><input type="number" id="ed-price" class="input-field" value="0"></div>
                <div><label class="tag-label text-red-500">單日請假扣額</label><input type="number" id="ed-deduct" class="input-field" value="0"></div>
                
                <div class="col-span-full"><label class="tag-label">詳細活動內容</label><textarea id="ed-desc" rows="5" class="input-field"></textarea></div>
            </div>
            
            <button onclick="EventManager.save()" id="btn-save-event" class="btn-blue w-full mt-10 shadow-2xl">同步發布專業規格 ➜</button>
        </div>
    </div>

    <script>
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        let state = { events: [], config: { sportCategories: [] }, currentEditId: null, currentType: '單日型' };

        async function init() {
            const res = await fetch(`${PROXY_URL}?action=getEvents&_t=${Date.now()}`);
            const r = await res.json();
            state.events = r.data || [];
            state.config.sportCategories = (r.config.sportCategories || "足球,籃球").split(',');
            EventManager.renderGrid();
        }

        const EventManager = {
            renderGrid() {
                document.getElementById('admin-event-grid').innerHTML = state.events.map(ev => `
                    <div class="spec-card">
                        <div class="flex gap-4 mb-4">
                            <div class="w-16 h-16 rounded-xl bg-slate-100 overflow-hidden flex-shrink-0"><img src="${ev['圖片URL']}" class="w-full h-full object-cover"></div>
                            <div class="flex-1">
                                <span class="text-[10px] font-bold px-2 py-0.5 rounded bg-blue-50 text-[#1877f2] uppercase">${ev['活動型態']}</span>
                                <h4 class="font-bold text-lg text-slate-800 leading-tight">${ev['活動名稱']}</h4>
                            </div>
                        </div>
                        <div class="flex justify-between items-center pt-4 border-t border-slate-50">
                            <div class="text-xs font-bold text-slate-400 italic">${ev['開始日期']}</div>
                            <button onclick="EventManager.openEditor('${ev['活動ID']}')" class="text-[#1877f2] font-bold text-sm">編輯規格</button>
                        </div>
                    </div>`).join('');
            },
            setType(t) {
                state.currentType = t;
                document.querySelectorAll('.type-pill').forEach(el => el.classList.remove('active'));
                if(t === '單日型') document.getElementById('type-single').classList.add('active');
                if(t === '梯次型') document.getElementById('type-batch').classList.add('active');
                if(t === '常態型') document.getElementById('type-term').classList.add('active');
                
                document.getElementById('area-batch').classList.toggle('hidden', t !== '梯次型');
                document.getElementById('area-term').classList.toggle('hidden', t !== '常態型');
            },
            appendSession(obj = { n: "", s: "", e: "" }) {
                const container = document.getElementById('session-list-container');
                const count = container.children.length + 1;
                const cn = ['零','一','二','三','四','五','六','七','八','九','十'][count] || count;
                const div = document.createElement('div'); div.className = "session-row";
                div.innerHTML = `<div class="flex justify-between items-center mb-4"><span class="font-bold text-slate-700">配置明細</span><button onclick="this.closest('.session-row').remove()" class="text-red-400 text-xs font-bold">移除</button></div>
                    <input type="text" class="input-field session-n mb-4" value="${obj.n || '第'+cn+'梯次'}">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="datetime-local" class="input-field session-s" value="${obj.s}">
                        <input type="datetime-local" class="input-field session-e" value="${obj.e}">
                    </div>`;
                container.appendChild(div);
            },
            openEditor(id) {
                state.currentEditId = id; const ev = state.events.find(e => String(e['活動ID']) === String(id)) || {};
                document.getElementById('editor-modal').classList.add('active');
                document.getElementById('session-list-container').innerHTML = "";
                document.getElementById('ed-cat').innerHTML = state.config.sportCategories.map(c => `<option value="${c}">${c}</option>`).join('');
                
                document.getElementById('ed-name').value = ev['活動名稱'] || "";
                document.getElementById('ed-cat').value = ev['分類'] || "";
                document.getElementById('ed-start').value = ev['開始日期'] ? ev['開始日期'].substring(0,10) : "";
                document.getElementById('ed-end').value = ev['結束日期'] ? ev['結束日期'].substring(0,10) : "";
                document.getElementById('ed-price').value = ev['全日價'] || 0;
                document.getElementById('ed-deduct').value = ev['全日扣除'] || 0;
                document.getElementById('ed-img').value = ev['圖片URL'] || "";
                document.getElementById('ed-desc').value = ev['描述'] || "";
                
                this.setType(ev['活動型態'] || '單日型');
                const raw = ev['梯次資料'] || "";
                if(state.currentType === '梯次型' && raw) {
                    try { JSON.parse(raw).forEach(s => this.appendSession(s)); } catch(e){}
                } else if (state.currentType === '常態型' && raw) {
                    const days = raw.split(',');
                    document.querySelectorAll('.wk-day').forEach(el => el.checked = days.includes(el.value));
                }
            },
            closeEditor() { document.getElementById('editor-modal').classList.remove('active'); },
            async save() {
                const btn = document.getElementById('btn-save-event'); btn.disabled = true;
                let sessionData = "";
                if(state.currentType === '梯次型') {
                    sessionData = JSON.stringify(Array.from(document.querySelectorAll('.session-row')).map(r => ({
                        n: r.querySelector('.session-n').value, s: r.querySelector('.session-s').value, e: r.querySelector('.session-e').value
                    })));
                } else if(state.currentType === '常態型') {
                    sessionData = Array.from(document.querySelectorAll('.wk-day:checked')).map(el => el.value).join(',');
                }

                const payload = { 
                    "活動ID": state.currentEditId || ("EVT-" + Date.now()), "活動型態": state.currentType, "活動名稱": document.getElementById('ed-name').value, 
                    "分類": document.getElementById('ed-cat').value, "梯次資料": sessionData, "開始日期": document.getElementById('ed-start').value, 
                    "結束日期": document.getElementById('ed-end').value, "全日價": document.getElementById('ed-price').value, 
                    "全日扣除": document.getElementById('ed-deduct').value, "圖片URL": document.getElementById('ed-img').value, "狀態": "上架"
                };
                await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify({ action: 'updateEvent', payload }) });
                alert("✅ 專業規格已發布！"); location.reload();
            }
        };
        window.onload = init;
    </script>
</body>
</html>
