<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¦æ ¼å°ˆå®¶ç®¡ç† - é‹å‹•å³¶</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; font-size: 16px; }
        .main-container { max-width: 1000px; margin: 0 auto; padding: 24px 16px; }
        .input-field { width: 100%; border: 1px solid #e2e8f0; border-radius: 14px; padding: 14px; font-weight: 500; outline: none; background: #fff; font-size: 16px; transition: 0.2s; }
        .input-field:focus { border-color: #1877f2; box-shadow: 0 0 0 4px rgba(24, 119, 242, 0.1); }
        .type-pill { flex: 1; text-align: center; padding: 14px; border-radius: 16px; background: #f1f5f9; color: #64748b; font-weight: 700; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .type-pill.active { background: #eef2ff; color: #1877f2; border-color: #1877f2; }
        .tag-label { display: block; font-size: 13px; font-weight: 900; color: #64748b; margin-bottom: 8px; margin-top: 16px; text-transform: uppercase; letter-spacing: 0.05em; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 850px; border-radius: 32px; padding: 40px; margin-bottom: 50px; position: relative; }
        .session-row { background: #f8fafc; border-radius: 20px; padding: 20px; margin-bottom: 12px; border: 1px solid #e2e8f0; }
        .eq-chip { display: flex; align-items: center; gap: 8px; background: #f1f5f9; padding: 10px 16px; border-radius: 12px; cursor: pointer; font-weight: 700; border: 1.5px solid transparent; }
        .eq-chip:has(input:checked) { background: #e7f3ff; color: #1877f2; border-color: #1877f2; }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="flex justify-between items-center mb-10">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-slate-900 rounded-2xl flex items-center justify-center shadow-xl"><span class="text-white font-black italic text-2xl">SI</span></div>
                <div><h1 class="text-xl font-black italic">æ´»å‹•è¦æ ¼å°ˆå®¶ç«¯</h1><p class="text-xs text-slate-400 font-bold uppercase">Standardized Activity Architect</p></div>
            </div>
            <div class="flex gap-3">
                <button onclick="window.location.href='index.html'" class="text-slate-400 font-bold text-sm px-5 py-2.5 border rounded-xl bg-white shadow-sm">è¿”å›é¦–é </button>
                <button onclick="EventManager.openEditor(null)" class="bg-[#1877f2] text-white px-8 py-3 rounded-xl font-bold shadow-lg">+ æ–°å¢èª²ç¨‹è¦æ ¼</button>
            </div>
        </div>
        <div id="admin-event-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
    </div>

    <!-- 19 æ¬„ä½å°ˆç”¨æ——è‰¦ç·¨è¼¯å™¨ -->
    <div id="editor-modal" class="modal-overlay" onclick="if(event.target===this) EventManager.closeEditor()">
        <div class="modal-content">
            <h2 class="text-3xl font-black italic text-[#1877f2] mb-10 border-b pb-6">å°ˆæ¥­èª²ç¨‹é…ç½® Matrix</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 overflow-y-auto max-h-[70vh] px-2 no-scrollbar">
                <!-- ç‡Ÿé‹æ¨¡å¼æ±ºå®šä»‹é¢ -->
                <div class="col-span-full">
                    <label class="tag-label !mt-0">é¸å®šç‡Ÿé‹æ¨¡å¼ (å°‡è‡ªå‹•éæ¿¾ç„¡é—œæ¬„ä½)</label>
                    <div class="flex gap-4 mt-2">
                        <div onclick="EventManager.setType('å–®æ—¥å‹')" id="btn-type-single" class="type-pill active">å–®æ—¥é«”é©—</div>
                        <div onclick="EventManager.setType('æ¢¯æ¬¡å‹')" id="btn-type-batch" class="type-pill">å¤šæ¢¯æ¬¡ç‡ŸéšŠ</div>
                        <div onclick="EventManager.setType('å¸¸æ…‹å‹')" id="btn-type-term" class="type-pill">å­¸æœŸå¸¸æ…‹èª²</div>
                    </div>
                </div>

                <div class="col-span-full"><label class="tag-label">èª²ç¨‹æ­£å¼åç¨±</label><input type="text" id="ed-name" class="input-field"></div>
                <div><label class="tag-label">åˆ†é¡æ¨™ç±¤</label><select id="ed-cat" class="input-field font-bold"></select></div>
                <div><label class="tag-label">ä¸»è¦–è¦ºåœ–ç‰‡ URL</label><input type="text" id="ed-img" class="input-field"></div>

                <!-- æ¢¯æ¬¡é…ç½®å€ -->
                <div id="area-batch" class="col-span-full bg-blue-50/50 p-8 rounded-[2.5rem] border-2 border-dashed border-blue-200 hidden">
                    <div class="flex justify-between items-center mb-6"><span class="font-black text-[#1877f2]">æ¢¯æ¬¡æ™‚é–“æ¸…å–®è¨­å®š</span><button onclick="EventManager.appendSession()" class="bg-[#1877f2] text-white px-5 py-2 rounded-xl text-sm font-bold shadow-md">+ æ–°å¢æ¢¯æ¬¡</button></div>
                    <div id="session-list-container"></div>
                </div>

                <!-- å¸¸æ…‹å‹é…ç½®å€ -->
                <div id="area-term" class="col-span-full bg-emerald-50/50 p-8 rounded-[2.5rem] border-2 border-dashed border-emerald-200 hidden">
                    <label class="tag-label !mt-0 text-emerald-700">å›ºå®šä¸Šèª²æ˜ŸæœŸè¨­å®š</label>
                    <div class="grid grid-cols-4 gap-3 mb-8">
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="1"> é€±ä¸€</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="2"> é€±äºŒ</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="3"> é€±ä¸‰</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="4"> é€±å››</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="5"> é€±äº”</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="6"> é€±å…­</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="0"> é€±æ—¥</label>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="tag-label text-red-500 !mt-0">è«‹å‡æ‰£æŠµ (å…¨æ—¥)</label><input type="number" id="ed-deduct" class="input-field" value="0"></div>
                        <div><label class="tag-label text-orange-500 !mt-0">è«‹å‡æ‰£æŠµ (åŠæ—¥)</label><input type="number" id="ed-deduct-half" class="input-field" value="0"></div>
                    </div>
                </div>

                <!-- æ—©é³¥å„ªæƒ å€ -->
                <div class="col-span-full bg-amber-50 p-8 rounded-[2.5rem] border-2 border-amber-200 border-dotted">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="tag-label !mt-0 text-amber-700">âœ¨ æ—©é³¥å„ªæƒ æ¨™åƒ¹</label><input type="number" id="ed-early-price" class="input-field border-amber-200" placeholder="ç•™ç©ºå‰‡ç„¡å„ªæƒ "></div>
                        <div><label class="tag-label !mt-0 text-amber-700">âŒ› æ—©é³¥æˆªæ­¢æ™‚é–“</label><input type="datetime-local" id="ed-early-date" class="input-field border-amber-200"></div>
                    </div>
                </div>

                <!-- é€šç”¨è¨­å®š -->
                <div><label class="tag-label">æ´»å‹•é–‹å§‹æ—¥æœŸ</label><input type="date" id="ed-start" class="input-field"></div>
                <div><label class="tag-label">æ´»å‹•çµæŸæ—¥æœŸ</label><input type="date" id="ed-end" class="input-field"></div>
                <div><label class="tag-label text-[#1877f2]">åŸºç¤å­¸è²»ç¸½é¡ (åŸåƒ¹)</label><input type="number" id="ed-price" class="input-field" value="0"></div>
                <div><label class="tag-label text-blue-400">æ‹›æ”¶ç¸½åé¡</label><input type="number" id="ed-quota" class="input-field" value="0"></div>

                <div class="col-span-full">
                    <label class="tag-label">é–‹æ”¾ç§Ÿç”¨è£å‚™ (ç”±åƒæ•¸å€å°å…¥)</label>
                    <div id="activity-eq-options" class="flex flex-wrap gap-2"></div>
                </div>
                
                <div class="col-span-full"><label class="tag-label">è©³ç´°æ´»å‹•å…§å®¹</label><textarea id="ed-desc" rows="5" class="input-field"></textarea></div>
            </div>
            
            <button onclick="EventManager.save()" id="btn-save" class="bg-[#1877f2] text-white w-full py-5 rounded-2xl font-black mt-10 shadow-2xl text-xl italic uppercase">åŒæ­¥ç™¼å¸ƒè‡³é‹å‹•å³¶è³‡æ–™åº« âœ</button>
        </div>
    </div>

    <script>
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        let state = { events: [], config: { sportCategories: [], rentalItems: [] }, currentEditId: null, currentType: 'å–®æ—¥å‹' };

        async function init() {
            const res = await fetch(`${PROXY_URL}?action=getEvents&_t=${Date.now()}`);
            const r = await res.json();
            state.events = r.data || [];
            state.config.sportCategories = (r.config.sportCategories || "").split(',').filter(i=>i);
            try { state.config.rentalItems = JSON.parse(r.config.rentalItems || "[]"); } catch(e){ state.config.rentalItems = []; }
            EventManager.renderGrid();
        }

        const EventManager = {
            renderGrid() {
                document.getElementById('admin-event-grid').innerHTML = state.events.map(ev => `
                    <div class="bg-white p-7 rounded-[2.5rem] border shadow-sm flex gap-6 items-center hover:border-[#1877f2] transition-all">
                        <img src="${ev['åœ–ç‰‡URL'] || 'https://placehold.co/200x200'}" class="w-24 h-24 rounded-3xl object-cover bg-slate-100 shadow-inner">
                        <div class="flex-1">
                            <span class="text-[10px] font-black px-2.5 py-1 rounded-full bg-blue-50 text-[#1877f2] uppercase tracking-tighter">${ev['æ´»å‹•å‹æ…‹']}</span>
                            <h4 class="font-black text-xl text-slate-800 leading-tight mt-2">${ev['æ´»å‹•åç¨±']}</h4>
                            <button onclick="EventManager.openEditor('${ev['æ´»å‹•ID']}')" class="text-[#1877f2] font-black text-sm mt-4 border-b-2 border-blue-50 hover:border-blue-500 transition-all">ç·¨è¼¯è¦æ ¼ Matrix</button>
                        </div>
                    </div>`).join('');
            },
            setType(t) {
                state.currentType = t;
                document.querySelectorAll('.type-pill').forEach(el => el.classList.toggle('active', el.innerText.includes(t.substring(0,2))));
                document.getElementById('area-batch').classList.toggle('hidden', t !== 'æ¢¯æ¬¡å‹');
                document.getElementById('area-term').classList.toggle('hidden', t !== 'å¸¸æ…‹å‹');
            },
            appendSession(obj = { n: "", s: "", e: "" }) {
                const container = document.getElementById('session-list-container');
                const count = container.children.length + 1;
                const div = document.createElement('div'); div.className = "session-row";
                div.innerHTML = `<div class="flex justify-between mb-4"><span class="font-bold text-sm text-slate-400">#${count} æ¢¯æ¬¡æ˜ç´°</span><button onclick="this.closest('.session-row').remove()" class="text-red-400 text-xs font-bold uppercase">ç§»é™¤</button></div>
                    <input type="text" class="input-field session-n mb-4" value="${obj.n || 'ç¬¬'+count+'æ¢¯æ¬¡'}" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€æ¢¯æ¬¡ (å¯’å‡ä¸Šåˆç­)">
                    <div class="grid grid-cols-2 gap-4"><input type="datetime-local" class="input-field session-s" value="${obj.s}"><input type="datetime-local" class="input-field session-e" value="${obj.e}"></div>`;
                container.appendChild(div);
            },
            openEditor(id) {
                state.currentEditId = id; 
                const ev = state.events.find(e => String(e['æ´»å‹•ID']) === String(id)) || {};
                document.getElementById('editor-modal').classList.add('active');
                document.getElementById('session-list-container').innerHTML = "";
                document.getElementById('ed-cat').innerHTML = state.config.sportCategories.map(c => `<option value="${c}">${c}</option>`).join('');
                
                // è£å‚™ç§Ÿç”¨å‹¾é¸é‚è¼¯
                const activeEq = (ev['å…§å®¹åª’é«”'] || "").split(',').filter(i=>i);
                document.getElementById('activity-eq-options').innerHTML = state.config.rentalItems.map(it => `
                    <label class="eq-chip"><input type="checkbox" class="act-eq" value="${it.name}" ${activeEq.includes(it.name)?'checked':''}> ${it.name}</label>
                `).join('') || '<p class="text-slate-300 italic">è«‹å…ˆè‡³åƒæ•¸å€æ–°å¢ç§Ÿç”¨è£å‚™</p>';

                document.getElementById('ed-name').value = ev['æ´»å‹•åç¨±'] || "";
                document.getElementById('ed-cat').value = ev['åˆ†é¡'] || "";
                document.getElementById('ed-start').value = ev['é–‹å§‹æ—¥æœŸ'] ? ev['é–‹å§‹æ—¥æœŸ'].substring(0,10) : "";
                document.getElementById('ed-end').value = ev['çµæŸæ—¥æœŸ'] ? ev['çµæŸæ—¥æœŸ'].substring(0,10) : "";
                document.getElementById('ed-price').value = ev['å…¨æ—¥åƒ¹'] || 0;
                document.getElementById('ed-deduct').value = ev['å…¨æ—¥æ‰£é™¤'] || 0;
                document.getElementById('ed-deduct-half').value = ev['åŠæ—¥æ‰£é™¤'] || 0;
                document.getElementById('ed-img').value = ev['åœ–ç‰‡URL'] || "";
                document.getElementById('ed-desc').value = ev['æè¿°'] || "";
                document.getElementById('ed-quota').value = ev['ç¸½åé¡'] || 0;
                document.getElementById('ed-early-price').value = ev['å…¨æ—¥æ—©é³¥åƒ¹'] || "";
                document.getElementById('ed-early-date').value = ev['æ—©é³¥æˆªæ­¢æ—¥æœŸ'] ? ev['æ—©é³¥æˆªæ­¢æ—¥æœŸ'].substring(0,16) : "";
                
                this.setType(ev['æ´»å‹•å‹æ…‹'] || 'å–®æ—¥å‹');
                const raw = ev['æ¢¯æ¬¡è³‡æ–™'] || "";
                if(state.currentType === 'æ¢¯æ¬¡å‹' && raw) { try { JSON.parse(raw).forEach(s => this.appendSession(s)); } catch(e){} }
                else if (state.currentType === 'å¸¸æ…‹å‹' && raw) {
                    const days = raw.split(','); document.querySelectorAll('.wk-day').forEach(el => el.checked = days.includes(el.value));
                }
            },
            closeEditor() { document.getElementById('editor-modal').classList.remove('active'); },
            async save() {
                const btn = document.getElementById('btn-save'); btn.disabled = true; btn.innerText = "æ­£åœ¨åŠ å¯†åŒæ­¥è‡³é›²ç«¯...";
                let sessionData = "";
                if(state.currentType === 'æ¢¯æ¬¡å‹') {
                    sessionData = JSON.stringify(Array.from(document.querySelectorAll('.session-row')).map(r => ({
                        n: r.querySelector('.session-n').value, s: r.querySelector('.session-s').value, e: r.querySelector('.session-e').value
                    })));
                } else if(state.currentType === 'å¸¸æ…‹å‹') {
                    sessionData = Array.from(document.querySelectorAll('.wk-day:checked')).map(el => el.value).join(',');
                }

                const payload = { 
                    "æ´»å‹•ID": state.currentEditId || ("EVT-" + Date.now()), "æ´»å‹•å‹æ…‹": state.currentType, "æ´»å‹•åç¨±": document.getElementById('ed-name').value, 
                    "åˆ†é¡": document.getElementById('ed-cat').value, "æ¢¯æ¬¡è³‡æ–™": sessionData, "é–‹å§‹æ—¥æœŸ": document.getElementById('ed-start').value, 
                    "çµæŸæ—¥æœŸ": document.getElementById('ed-end').value, "å…¨æ—¥åƒ¹": document.getElementById('ed-price').value, 
                    "å…¨æ—¥æ‰£é™¤": document.getElementById('ed-deduct').value, "åŠæ—¥æ‰£é™¤": document.getElementById('ed-deduct-half').value,
                    "åœ–ç‰‡URL": document.getElementById('ed-img').value, "ç‹€æ…‹": "ä¸Šæ¶", "ç¸½åé¡": document.getElementById('ed-quota').value, 
                    "å…§å®¹åª’é«”": Array.from(document.querySelectorAll('.act-eq:checked')).map(el => el.value).join(','),
                    "æè¿°": document.getElementById('ed-desc').value, "å…¨æ—¥æ—©é³¥åƒ¹": document.getElementById('ed-early-price').value, "æ—©é³¥æˆªæ­¢æ—¥æœŸ": document.getElementById('ed-early-date').value
                };

                const res = await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify({ action: 'updateEvent', payload }) });
                if((await res.json()).status === 'success') { alert("ğŸ‰ å°ˆæ¥­æ´»å‹•è¦æ ¼å·²æˆåŠŸå­˜æª”ï¼"); location.reload(); }
                else { alert("é€£ç·šå¤±æ•—"); btn.disabled = false; }
            }
        };
        window.onload = init;
    </script>
</body>
</html>
