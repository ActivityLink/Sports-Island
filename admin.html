<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¦æ ¼å°ˆå®¶ç®¡ç† - é‹å‹•å³¶</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; font-size: 16px; }
        .main-container { max-width: 1000px; margin: 0 auto; padding: 24px 16px; }
        .input-field { width: 100%; border: 1px solid #e2e8f0; border-radius: 14px; padding: 14px; font-weight: 500; outline: none; background: #fff; font-size: 16px; transition: 0.2s; }
        .input-field:focus { border-color: #1877f2; box-shadow: 0 0 0 4px rgba(24, 119, 242, 0.1); }
        .type-pill { flex: 1; text-align: center; padding: 14px; border-radius: 16px; background: #f1f5f9; color: #64748b; font-weight: 700; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .type-pill.active { background: #eef2ff; color: #1877f2; border-color: #1877f2; }
        .tag-label { display: block; font-size: 13px; font-weight: 900; color: #64748b; margin-bottom: 8px; margin-top: 16px; text-transform: uppercase; letter-spacing: 0.05em; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 850px; border-radius: 32px; padding: 40px; margin-bottom: 50px; position: relative; }
        .session-row { background: #f8fafc; border-radius: 20px; padding: 20px; margin-bottom: 12px; border: 1px solid #e2e8f0; }
        .eq-chip { display: flex; align-items: center; gap: 8px; background: #f1f5f9; padding: 10px 16px; border-radius: 12px; cursor: pointer; font-weight: 700; border: 1.5px solid transparent; }
        .eq-chip:has(input:checked) { background: #e7f3ff; color: #1877f2; border-color: #1877f2; }
        .loading-spinner { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; }
        .loading-spinner.active { display: flex; }
        .loading-spinner .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #1877f2; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- è¼‰å…¥å‹•ç•« -->
    <div id="loading-spinner" class="loading-spinner">
        <div class="spinner"></div>
        <div class="mt-4 text-blue-600 font-bold">è³‡æ–™åŒæ­¥ä¸­...</div>
    </div>

    <div class="main-container">
        <div class="flex justify-between items-center mb-10">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-slate-900 rounded-2xl flex items-center justify-center shadow-xl"><span class="text-white font-black italic text-2xl">SI</span></div>
                <div>
                    <h1 class="text-xl font-black italic">æ´»å‹•è¦æ ¼å°ˆå®¶ç«¯</h1>
                    <p class="text-xs text-slate-400 font-bold uppercase">Standardized Activity Architect</p>
                    <div id="data-status" class="text-xs text-slate-500 mt-1"></div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="window.location.href='index.html'" class="text-slate-400 font-bold text-sm px-5 py-2.5 border rounded-xl bg-white shadow-sm">è¿”å›é¦–é </button>
                <button onclick="EventManager.openEditor(null)" class="bg-[#1877f2] text-white px-8 py-3 rounded-xl font-bold shadow-lg">+ æ–°å¢èª²ç¨‹è¦æ ¼</button>
            </div>
        </div>
        
        <!-- æ•¸æ“šçµ±è¨ˆ -->
        <div id="stats-container" class="mb-8 grid grid-cols-1 md:grid-cols-4 gap-4"></div>
        
        <!-- æ´»å‹•ç¶²æ ¼ -->
        <div id="admin-event-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
        
        <!-- ç©ºç‹€æ…‹ -->
        <div id="empty-state" class="hidden text-center py-16">
            <div class="text-5xl mb-6">ğŸ“</div>
            <h3 class="text-2xl font-black text-slate-800 mb-3">å°šç„¡æ´»å‹•è¦æ ¼</h3>
            <p class="text-slate-600 mb-8">é–‹å§‹å»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹å°ˆæ¥­æ´»å‹•è¦æ ¼</p>
            <button onclick="EventManager.openEditor(null)" 
                    class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-10 py-4 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl transition-all">
                + å»ºç«‹æ–°è¦æ ¼
            </button>
        </div>
        
        <!-- éŒ¯èª¤ç‹€æ…‹ -->
        <div id="error-state" class="hidden text-center py-16">
            <div class="text-6xl mb-6">âš ï¸</div>
            <h3 class="text-2xl font-black text-slate-800 mb-3">è³‡æ–™è¼‰å…¥å¤±æ•—</h3>
            <p id="error-message" class="text-slate-600 mb-8"></p>
            <button onclick="init()" 
                    class="bg-red-500 text-white px-8 py-3 rounded-xl font-bold hover:bg-red-600 transition-all">
                ğŸ”„ é‡æ–°è¼‰å…¥
            </button>
        </div>
    </div>

    <!-- ç·¨è¼¯å™¨æ¨¡æ…‹æ¡† -->
    <div id="editor-modal" class="modal-overlay" onclick="if(event.target===this) EventManager.closeEditor()">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-black italic text-[#1877f2]">å°ˆæ¥­èª²ç¨‹é…ç½® Matrix</h2>
                <button onclick="EventManager.closeEditor()" class="text-slate-400 text-2xl font-bold hover:text-slate-600">Ã—</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 overflow-y-auto max-h-[70vh] px-2 no-scrollbar">
                <!-- ç‡Ÿé‹æ¨¡å¼æ±ºå®šä»‹é¢ -->
                <div class="col-span-full">
                    <label class="tag-label !mt-0">é¸å®šç‡Ÿé‹æ¨¡å¼ (å°‡è‡ªå‹•éæ¿¾ç„¡é—œæ¬„ä½)</label>
                    <div class="flex gap-4 mt-2">
                        <div onclick="EventManager.setType('å–®æ—¥å‹')" id="btn-type-single" class="type-pill active">å–®æ—¥é«”é©—</div>
                        <div onclick="EventManager.setType('æ¢¯æ¬¡å‹')" id="btn-type-batch" class="type-pill">å¤šæ¢¯æ¬¡ç‡ŸéšŠ</div>
                        <div onclick="EventManager.setType('å¸¸æ…‹å‹')" id="btn-type-term" class="type-pill">å­¸æœŸå¸¸æ…‹èª²</div>
                    </div>
                </div>

                <div class="col-span-full"><label class="tag-label">èª²ç¨‹æ­£å¼åç¨±</label><input type="text" id="ed-name" class="input-field" placeholder="ä¾‹å¦‚ï¼šå…’ç«¥ç±ƒçƒåŸºç¤è¨“ç·´ç‡Ÿ"></div>
                
                <div><label class="tag-label">åˆ†é¡æ¨™ç±¤</label><select id="ed-cat" class="input-field font-bold"></select></div>
                
                <div><label class="tag-label">ä¸»è¦–è¦ºåœ–ç‰‡ URL</label><input type="text" id="ed-img" class="input-field" placeholder="https://example.com/image.jpg"></div>

                <!-- æ¢¯æ¬¡é…ç½®å€ -->
                <div id="area-batch" class="col-span-full bg-blue-50/50 p-8 rounded-[2.5rem] border-2 border-dashed border-blue-200 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <span class="font-black text-[#1877f2]">æ¢¯æ¬¡æ™‚é–“æ¸…å–®è¨­å®š</span>
                            <p class="text-sm text-slate-500 mt-1">æ¯å€‹æ¢¯æ¬¡ç¨ç«‹è¨­å®šåç¨±å’Œæ™‚é–“</p>
                        </div>
                        <button onclick="EventManager.appendSession()" class="bg-[#1877f2] text-white px-5 py-2 rounded-xl text-sm font-bold shadow-md">+ æ–°å¢æ¢¯æ¬¡</button>
                    </div>
                    <div id="session-list-container"></div>
                </div>

                <!-- å¸¸æ…‹å‹é…ç½®å€ -->
                <div id="area-term" class="col-span-full bg-emerald-50/50 p-8 rounded-[2.5rem] border-2 border-dashed border-emerald-200 hidden">
                    <label class="tag-label !mt-0 text-emerald-700">å›ºå®šä¸Šèª²æ˜ŸæœŸè¨­å®š</label>
                    <div class="grid grid-cols-4 gap-3 mb-8">
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="1"> é€±ä¸€</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="2"> é€±äºŒ</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="3"> é€±ä¸‰</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="4"> é€±å››</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="5"> é€±äº”</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="6"> é€±å…­</label>
                        <label class="flex items-center gap-2 font-bold"><input type="checkbox" class="wk-day" value="0"> é€±æ—¥</label>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="tag-label text-red-500 !mt-0">è«‹å‡æ‰£æŠµ (å…¨æ—¥)</label><input type="number" id="ed-deduct" class="input-field" value="0" min="0"></div>
                        <div><label class="tag-label text-orange-500 !mt-0">è«‹å‡æ‰£æŠµ (åŠæ—¥)</label><input type="number" id="ed-deduct-half" class="input-field" value="0" min="0"></div>
                    </div>
                </div>

                <!-- æ—©é³¥å„ªæƒ å€ -->
                <div class="col-span-full bg-amber-50 p-8 rounded-[2.5rem] border-2 border-amber-200 border-dotted">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="tag-label !mt-0 text-amber-700">âœ¨ æ—©é³¥å„ªæƒ æ¨™åƒ¹</label><input type="number" id="ed-early-price" class="input-field border-amber-200" placeholder="ç•™ç©ºå‰‡ç„¡å„ªæƒ " min="0"></div>
                        <div><label class="tag-label !mt-0 text-amber-700">âŒ› æ—©é³¥æˆªæ­¢æ™‚é–“</label><input type="datetime-local" id="ed-early-date" class="input-field border-amber-200"></div>
                    </div>
                </div>

                <!-- é€šç”¨è¨­å®š -->
                <div><label class="tag-label">æ´»å‹•é–‹å§‹æ—¥æœŸ</label><input type="date" id="ed-start" class="input-field"></div>
                <div><label class="tag-label">æ´»å‹•çµæŸæ—¥æœŸ</label><input type="date" id="ed-end" class="input-field"></div>
                <div><label class="tag-label text-[#1877f2]">åŸºç¤å­¸è²»ç¸½é¡ (åŸåƒ¹)</label><input type="number" id="ed-price" class="input-field" value="0" min="0"></div>
                <div><label class="tag-label text-blue-400">æ‹›æ”¶ç¸½åé¡</label><input type="number" id="ed-quota" class="input-field" value="0" min="0"></div>

                <div class="col-span-full">
                    <label class="tag-label">é–‹æ”¾ç§Ÿç”¨è£å‚™ (ç”±åƒæ•¸å€å°å…¥)</label>
                    <div id="activity-eq-options" class="flex flex-wrap gap-2"></div>
                </div>
                
                <div class="col-span-full">
                    <label class="tag-label">è©³ç´°æ´»å‹•å…§å®¹</label>
                    <textarea id="ed-desc" rows="5" class="input-field" placeholder="è«‹è©³ç´°æè¿°æ´»å‹•å…§å®¹ã€é©åˆå°è±¡ã€æ³¨æ„äº‹é …ç­‰..."></textarea>
                </div>
            </div>
            
            <button onclick="EventManager.save()" id="btn-save" class="bg-[#1877f2] text-white w-full py-5 rounded-2xl font-black mt-10 shadow-2xl text-xl italic uppercase hover:bg-blue-700 transition-all">
                åŒæ­¥ç™¼å¸ƒè‡³é‹å‹•å³¶è³‡æ–™åº« âœ
            </button>
        </div>
    </div>

    <script>
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        let state = { 
            events: [], 
            config: { sportCategories: [], rentalItems: [] }, 
            currentEditId: null, 
            currentType: 'å–®æ—¥å‹',
            lastSyncTime: null
        };

        // é¡¯ç¤º/éš±è—è¼‰å…¥å‹•ç•«
        function showLoading(show) {
            document.getElementById('loading-spinner').classList.toggle('active', show);
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-500' : 
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            } text-white`;
            notification.style.transform = 'translateX(100%)';
            notification.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-xl">${type === 'success' ? 'âœ…' : type === 'error' ? 'âŒ' : 'â„¹ï¸'}</span>
                    <span>${message}</span>
                </div>
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => notification.style.transform = 'translateX(0)', 10);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // è§£ææ•¸æ“šçš„è¼”åŠ©å‡½æ•¸
        function parseCategories(categories) {
            if (Array.isArray(categories)) return categories;
            if (typeof categories === 'string') {
                try {
                    // å˜—è©¦è§£æç‚º JSON
                    const parsed = JSON.parse(categories);
                    return Array.isArray(parsed) ? parsed : [];
                } catch {
                    // å¦‚æœæ˜¯é€—è™Ÿåˆ†éš”çš„å­—ç¬¦ä¸²
                    return categories.split(',').map(s => s.trim()).filter(s => s);
                }
            }
            return [];
        }

        async function init() {
            try {
                showLoading(true);
                console.log('é–‹å§‹è¼‰å…¥æ•¸æ“š...');
                
                // å˜—è©¦ç²å–æ‰€æœ‰æ•¸æ“š
                const response = await fetch(`${PROXY_URL}?action=getEvents&_t=${Date.now()}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('åŸå§‹å›æ‡‰æ•¸æ“š:', result);
                
                // æª¢æŸ¥æ•¸æ“šçµæ§‹
                if (result.status === 'error') {
                    throw new Error(result.message || 'ä¼ºæœå™¨è¿”å›éŒ¯èª¤');
                }
                
                // è™•ç†äº‹ä»¶æ•¸æ“š
                if (result.data && Array.isArray(result.data)) {
                    state.events = result.data;
                } else if (result.events && Array.isArray(result.events)) {
                    state.events = result.events;
                } else {
                    console.warn('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ´»å‹•æ•¸æ“šï¼Œä½¿ç”¨ç©ºé™£åˆ—');
                    state.events = [];
                }
                
                // è™•ç†é…ç½®æ•¸æ“š
                if (result.config) {
                    // è§£æåˆ†é¡æ•¸æ“š
                    state.config.sportCategories = parseCategories(result.config.sportCategories);
                    
                    // è§£æè£å‚™æ•¸æ“š
                    if (Array.isArray(result.config.rentalItems)) {
                        state.config.rentalItems = result.config.rentalItems;
                    } else if (typeof result.config.rentalItems === 'string') {
                        try {
                            state.config.rentalItems = JSON.parse(result.config.rentalItems);
                        } catch (e) {
                            console.warn('ç„¡æ³•è§£æ rentalItems:', e);
                            state.config.rentalItems = [];
                        }
                    } else {
                        state.config.rentalItems = [];
                    }
                } else {
                    // å˜—è©¦å¾æ ¹ç´šåˆ¥ç²å–
                    state.config.sportCategories = parseCategories(result.sportCategories || []);
                    state.config.rentalItems = Array.isArray(result.rentalItems) ? result.rentalItems : [];
                }
                
                state.lastSyncTime = new Date();
                
                // æ›´æ–° UI
                updateDataStatus();
                EventManager.renderGrid();
                EventManager.renderStats();
                
                // éš±è—éŒ¯èª¤ç‹€æ…‹
                document.getElementById('error-state').classList.add('hidden');
                document.getElementById('error-message').textContent = '';
                
                showNotification('è³‡æ–™è¼‰å…¥æˆåŠŸ', 'success');
                
            } catch (error) {
                console.error('è¼‰å…¥æ•¸æ“šå¤±æ•—:', error);
                
                // é¡¯ç¤ºéŒ¯èª¤ç‹€æ…‹
                document.getElementById('error-state').classList.remove('hidden');
                document.getElementById('error-message').textContent = error.message;
                
                document.getElementById('admin-event-grid').innerHTML = '';
                document.getElementById('empty-state').classList.add('hidden');
                
                showNotification(`è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
                
            } finally {
                showLoading(false);
            }
        }

        // æ›´æ–°æ•¸æ“šç‹€æ…‹é¡¯ç¤º
        function updateDataStatus() {
            const statusEl = document.getElementById('data-status');
            if (statusEl) {
                statusEl.textContent = `å·²è¼‰å…¥ ${state.events.length} å€‹æ´»å‹•ï¼Œæœ€å¾Œæ›´æ–°: ${state.lastSyncTime ? state.lastSyncTime.toLocaleTimeString('zh-TW') : 'å°šæœªåŒæ­¥'}`;
            }
        }

        const EventManager = {
            renderStats() {
                const stats = document.getElementById('stats-container');
                if (!stats) return;
                
                const typeCounts = {};
                state.events.forEach(ev => {
                    const type = ev['æ´»å‹•å‹æ…‹'] || 'æœªçŸ¥';
                    typeCounts[type] = (typeCounts[type] || 0) + 1;
                });
                
                stats.innerHTML = `
                    <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <div class="text-3xl font-black text-slate-800 mb-2">${state.events.length}</div>
                        <div class="text-sm text-slate-500 font-bold">ç¸½æ´»å‹•æ•¸</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <div class="text-3xl font-black text-blue-600 mb-2">${state.config.sportCategories.length}</div>
                        <div class="text-sm text-slate-500 font-bold">åˆ†é¡é …ç›®</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <div class="text-3xl font-black text-purple-600 mb-2">${state.config.rentalItems.length}</div>
                        <div class="text-sm text-slate-500 font-bold">ç§Ÿç”¨è£å‚™</div>
                    </div>
                    <div class="bg-white p-6 rounded-2xl shadow-sm border">
                        <div class="text-3xl font-black text-emerald-600 mb-2">${Object.keys(typeCounts).length}</div>
                        <div class="text-sm text-slate-500 font-bold">ç‡Ÿé‹æ¨¡å¼</div>
                    </div>
                `;
            },

            renderGrid() {
                const grid = document.getElementById('admin-event-grid');
                const emptyState = document.getElementById('empty-state');
                
                if (!state.events || state.events.length === 0) {
                    grid.innerHTML = '';
                    emptyState.classList.remove('hidden');
                    return;
                }
                
                emptyState.classList.add('hidden');
                
                grid.innerHTML = state.events.map(ev => {
                    const typeColor = {
                        'å–®æ—¥å‹': 'blue',
                        'æ¢¯æ¬¡å‹': 'purple',
                        'å¸¸æ…‹å‹': 'emerald'
                    }[ev['æ´»å‹•å‹æ…‹']] || 'gray';
                    
                    return `
                    <div class="bg-white p-7 rounded-[2.5rem] border-2 border-slate-100 shadow-sm hover:shadow-xl hover:border-blue-200 transition-all duration-300 group">
                        <div class="flex gap-6 items-start">
                            <div class="relative flex-shrink-0">
                                <img src="${ev['åœ–ç‰‡URL'] || 'https://placehold.co/200x200?text=æ´»å‹•åœ–ç‰‡'}" 
                                     class="w-24 h-24 rounded-3xl object-cover bg-gradient-to-br from-slate-100 to-slate-200 shadow-inner"
                                     onerror="this.src='https://placehold.co/200x200?text=æ´»å‹•åœ–ç‰‡'">
                                <span class="absolute -top-2 -right-2 text-[10px] font-black px-2.5 py-1 rounded-full bg-${typeColor}-50 text-${typeColor}-600 uppercase tracking-tighter">
                                    ${ev['æ´»å‹•å‹æ…‹'] || 'å–®æ—¥å‹'}
                                </span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="font-black text-xl text-slate-800 leading-tight mb-2" title="${ev['æ´»å‹•åç¨±']}">
                                    ${ev['æ´»å‹•åç¨±'] || 'æœªå‘½åæ´»å‹•'}
                                </h4>
                                <div class="flex flex-wrap gap-2 mb-3">
                                    <span class="text-sm font-bold px-3 py-1 rounded-full bg-slate-50 text-slate-700 border border-slate-200">
                                        ${ev['åˆ†é¡'] || 'æœªåˆ†é¡'}
                                    </span>
                                    <span class="text-sm font-bold px-3 py-1 rounded-full bg-blue-50 text-blue-700 border border-blue-200">
                                        NT$ ${parseInt(ev['å…¨æ—¥åƒ¹'] || 0).toLocaleString()}
                                    </span>
                                </div>
                                <p class="text-slate-600 text-sm line-clamp-2 mb-4">
                                    ${(ev['æè¿°'] || 'ç„¡æè¿°å…§å®¹').substring(0, 100)}${ev['æè¿°']?.length > 100 ? '...' : ''}
                                </p>
                                <div class="flex gap-3">
                                    <button onclick="EventManager.openEditor('${ev['æ´»å‹•ID']}')" 
                                            class="text-[#1877f2] font-bold text-sm px-4 py-2 border-2 border-blue-100 rounded-xl hover:bg-blue-50 transition-all flex-1 text-center">
                                        âœï¸ ç·¨è¼¯è¦æ ¼
                                    </button>
                                    <button onclick="EventManager.duplicateEvent('${ev['æ´»å‹•ID']}')" 
                                            class="text-slate-600 font-bold text-sm px-4 py-2 border border-slate-200 rounded-xl hover:bg-slate-50 transition-all">
                                        ğŸ“‹ è¤‡è£½
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            },

            setType(t) {
                state.currentType = t;
                document.querySelectorAll('.type-pill').forEach(el => el.classList.remove('active'));
                document.querySelectorAll('.type-pill').forEach(el => {
                    if (el.innerText.includes(t.substring(0,2))) {
                        el.classList.add('active');
                    }
                });
                document.getElementById('area-batch').classList.toggle('hidden', t !== 'æ¢¯æ¬¡å‹');
                document.getElementById('area-term').classList.toggle('hidden', t !== 'å¸¸æ…‹å‹');
            },

            appendSession(obj = { n: "", s: "", e: "" }) {
                const container = document.getElementById('session-list-container');
                const count = container.children.length + 1;
                const div = document.createElement('div'); 
                div.className = "session-row";
                div.innerHTML = `
                    <div class="flex justify-between mb-4">
                        <span class="font-bold text-sm text-slate-400">#${count} æ¢¯æ¬¡æ˜ç´°</span>
                        <button onclick="this.closest('.session-row').remove()" 
                                class="text-red-400 text-xs font-bold uppercase hover:text-red-600">
                            ç§»é™¤
                        </button>
                    </div>
                    <input type="text" class="input-field session-n mb-4" 
                           value="${obj.n || 'ç¬¬' + count + 'æ¢¯æ¬¡'}" 
                           placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€æ¢¯æ¬¡ (å¯’å‡ä¸Šåˆç­)">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">é–‹å§‹æ™‚é–“</label>
                            <input type="datetime-local" class="input-field session-s" value="${obj.s}">
                        </div>
                        <div>
                            <label class="text-xs text-slate-500 mb-1 block">çµæŸæ™‚é–“</label>
                            <input type="datetime-local" class="input-field session-e" value="${obj.e}">
                        </div>
                    </div>`;
                container.appendChild(div);
            },

            openEditor(id) {
                state.currentEditId = id; 
                const ev = state.events.find(e => String(e['æ´»å‹•ID']) === String(id)) || {};
                document.getElementById('editor-modal').classList.add('active');
                document.getElementById('session-list-container').innerHTML = "";
                
                // å¡«å……åˆ†é¡é¸é …
                const catSelect = document.getElementById('ed-cat');
                catSelect.innerHTML = '<option value="">è«‹é¸æ“‡åˆ†é¡</option>' + 
                    state.config.sportCategories.map(c => `<option value="${c}">${c}</option>`).join('');
                
                // è£å‚™ç§Ÿç”¨å‹¾é¸é‚è¼¯
                const eqContainer = document.getElementById('activity-eq-options');
                if (state.config.rentalItems.length > 0) {
                    const activeEq = (ev['å…§å®¹åª’é«”'] || "").split(',').filter(i => i.trim());
                    eqContainer.innerHTML = state.config.rentalItems.map(it => {
                        const isChecked = activeEq.includes(it.name || it);
                        return `
                            <label class="eq-chip">
                                <input type="checkbox" class="act-eq" value="${it.name || it}" ${isChecked ? 'checked' : ''}>
                                ${it.name || it}
                            </label>
                        `;
                    }).join('');
                } else {
                    eqContainer.innerHTML = '<p class="text-slate-400 italic text-sm">è«‹å…ˆè‡³åƒæ•¸å€æ–°å¢ç§Ÿç”¨è£å‚™</p>';
                }

                // å¡«å……è¡¨å–®æ•¸æ“š
                document.getElementById('ed-name').value = ev['æ´»å‹•åç¨±'] || "";
                document.getElementById('ed-cat').value = ev['åˆ†é¡'] || "";
                document.getElementById('ed-start').value = ev['é–‹å§‹æ—¥æœŸ'] ? ev['é–‹å§‹æ—¥æœŸ'].substring(0,10) : "";
                document.getElementById('ed-end').value = ev['çµæŸæ—¥æœŸ'] ? ev['çµæŸæ—¥æœŸ'].substring(0,10) : "";
                document.getElementById('ed-price').value = parseInt(ev['å…¨æ—¥åƒ¹'] || 0);
                document.getElementById('ed-deduct').value = parseInt(ev['å…¨æ—¥æ‰£é™¤'] || 0);
                document.getElementById('ed-deduct-half').value = parseInt(ev['åŠæ—¥æ‰£é™¤'] || 0);
                document.getElementById('ed-img').value = ev['åœ–ç‰‡URL'] || "";
                document.getElementById('ed-desc').value = ev['æè¿°'] || "";
                document.getElementById('ed-quota').value = parseInt(ev['ç¸½åé¡'] || 0);
                document.getElementById('ed-early-price').value = ev['å…¨æ—¥æ—©é³¥åƒ¹'] || "";
                document.getElementById('ed-early-date').value = ev['æ—©é³¥æˆªæ­¢æ—¥æœŸ'] ? ev['æ—©é³¥æˆªæ­¢æ—¥æœŸ'].substring(0,16) : "";
                
                this.setType(ev['æ´»å‹•å‹æ…‹'] || 'å–®æ—¥å‹');
                
                const raw = ev['æ¢¯æ¬¡è³‡æ–™'] || "";
                if (state.currentType === 'æ¢¯æ¬¡å‹' && raw) {
                    try {
                        const sessions = JSON.parse(raw);
                        if (Array.isArray(sessions)) {
                            sessions.forEach(s => this.appendSession(s));
                        }
                    } catch(e) {
                        console.warn('ç„¡æ³•è§£ææ¢¯æ¬¡è³‡æ–™:', e);
                    }
                } else if (state.currentType === 'å¸¸æ…‹å‹' && raw) {
                    const days = raw.split(',').map(d => d.trim());
                    document.querySelectorAll('.wk-day').forEach(el => {
                        el.checked = days.includes(el.value);
                    });
                }
            },

            closeEditor() { 
                document.getElementById('editor-modal').classList.remove('active'); 
            },

            async duplicateEvent(eventId) {
                const original = state.events.find(e => String(e['æ´»å‹•ID']) === String(eventId));
                if (!original) return;
                
                const confirm = window.confirm(`ç¢ºå®šè¦è¤‡è£½ã€Œ${original['æ´»å‹•åç¨±']}ã€å—ï¼Ÿ`);
                if (!confirm) return;
                
                const duplicate = { ...original };
                duplicate['æ´»å‹•ID'] = "EVT-" + Date.now() + "-COPY";
                duplicate['æ´»å‹•åç¨±'] = duplicate['æ´»å‹•åç¨±'] + " (è¤‡è£½)";
                duplicate['ç‹€æ…‹'] = "è‰ç¨¿";
                
                await this.saveEvent(duplicate);
            },

            async saveEvent(eventData) {
                try {
                    const res = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            action: 'updateEvent', 
                            payload: eventData 
                        })
                    });
                    
                    const result = await res.json();
                    return result;
                } catch (error) {
                    throw error;
                }
            },

            async save() {
                const btn = document.getElementById('btn-save');
                if (!btn) return;
                
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<span class="animate-pulse">ğŸ”„ åŒæ­¥ä¸­...</span>';
                
                try {
                    let sessionData = "";
                    if(state.currentType === 'æ¢¯æ¬¡å‹') {
                        const sessions = Array.from(document.querySelectorAll('.session-row')).map(r => ({
                            n: r.querySelector('.session-n').value,
                            s: r.querySelector('.session-s').value,
                            e: r.querySelector('.session-e').value
                        }));
                        sessionData = JSON.stringify(sessions);
                    } else if(state.currentType === 'å¸¸æ…‹å‹') {
                        sessionData = Array.from(document.querySelectorAll('.wk-day:checked'))
                            .map(el => el.value).join(',');
                    }

                    const payload = { 
                        "æ´»å‹•ID": state.currentEditId || ("EVT-" + Date.now()),
                        "æ´»å‹•å‹æ…‹": state.currentType,
                        "æ´»å‹•åç¨±": document.getElementById('ed-name').value.trim(),
                        "åˆ†é¡": document.getElementById('ed-cat').value,
                        "æ¢¯æ¬¡è³‡æ–™": sessionData,
                        "é–‹å§‹æ—¥æœŸ": document.getElementById('ed-start').value,
                        "çµæŸæ—¥æœŸ": document.getElementById('ed-end').value,
                        "å…¨æ—¥åƒ¹": parseInt(document.getElementById('ed-price').value) || 0,
                        "å…¨æ—¥æ‰£é™¤": parseInt(document.getElementById('ed-deduct').value) || 0,
                        "åŠæ—¥æ‰£é™¤": parseInt(document.getElementById('ed-deduct-half').value) || 0,
                        "åœ–ç‰‡URL": document.getElementById('ed-img').value.trim(),
                        "ç‹€æ…‹": "ä¸Šæ¶",
                        "ç¸½åé¡": parseInt(document.getElementById('ed-quota').value) || 0,
                        "å…§å®¹åª’é«”": Array.from(document.querySelectorAll('.act-eq:checked'))
                            .map(el => el.value).join(','),
                        "æè¿°": document.getElementById('ed-desc').value.trim(),
                        "å…¨æ—¥æ—©é³¥åƒ¹": document.getElementById('ed-early-price').value ? 
                            parseInt(document.getElementById('ed-early-price').value) : "",
                        "æ—©é³¥æˆªæ­¢æ—¥æœŸ": document.getElementById('ed-early-date').value
                    };

                    // é©—è­‰å¿…å¡«å­—æ®µ
                    if (!payload["æ´»å‹•åç¨±"]) {
                        throw new Error("è«‹å¡«å¯«èª²ç¨‹åç¨±");
                    }
                    if (!payload["åˆ†é¡"]) {
                        throw new Error("è«‹é¸æ“‡åˆ†é¡");
                    }
                    if (payload["å…¨æ—¥åƒ¹"] <= 0) {
                        throw new Error("è«‹è¨­å®šåˆç†çš„åƒ¹æ ¼");
                    }

                    const result = await this.saveEvent(payload);
                    
                    if (result.status === 'success') {
                        showNotification('ğŸ‰ å°ˆæ¥­æ´»å‹•è¦æ ¼å·²æˆåŠŸå­˜æª”ï¼', 'success');
                        setTimeout(() => {
                            location.reload();
                        }, 1500);
                    } else {
                        throw new Error(result.message || 'ä¿å­˜å¤±æ•—');
                    }
                    
                } catch (error) {
                    console.error('ä¿å­˜å¤±æ•—:', error);
                    showNotification(`ä¿å­˜å¤±æ•—: ${error.message}`, 'error');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            }
        };

        // åˆå§‹åŒ–æ‡‰ç”¨
        window.onload = function() {
            console.log('é é¢è¼‰å…¥å®Œæˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            init();
        };
    </script>
</body>
</html>
