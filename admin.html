<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¦æ ¼å°ˆå®¶ç®¡ç† - é‹å‹•å³¶</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #1e293b; font-size: 16px; }
        .main-container { max-width: 1000px; margin: 0 auto; padding: 24px 16px; }
        .input-field { width: 100%; border: 1px solid #e2e8f0; border-radius: 14px; padding: 14px; font-weight: 500; outline: none; background: #fff; font-size: 16px; transition: 0.2s; }
        .input-field:focus { border-color: #1877f2; box-shadow: 0 0 0 4px rgba(24, 119, 242, 0.1); }
        .type-pill { flex: 1; text-align: center; padding: 14px; border-radius: 16px; background: #f1f5f9; color: #64748b; font-weight: 700; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .type-pill.active { background: #eef2ff; color: #1877f2; border-color: #1877f2; }
        .tag-label { display: block; font-size: 13px; font-weight: 900; color: #64748b; margin-bottom: 8px; margin-top: 16px; text-transform: uppercase; letter-spacing: 0.05em; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); z-index: 1000; display: none; align-items: flex-start; justify-content: center; padding: 20px; overflow-y: auto; }
        .modal-overlay.active { display: flex; }
        .modal-content { background: white; width: 100%; max-width: 850px; border-radius: 32px; padding: 40px; margin-bottom: 50px; position: relative; }
        .session-row { background: #f8fafc; border-radius: 20px; padding: 20px; margin-bottom: 12px; border: 1px solid #e2e8f0; }
        .eq-chip { display: flex; align-items: center; gap: 8px; background: #f1f5f9; padding: 10px 16px; border-radius: 12px; cursor: pointer; font-weight: 700; border: 1.5px solid transparent; }
        .eq-chip:has(input:checked) { background: #e7f3ff; color: #1877f2; border-color: #1877f2; }
        .debug-panel { position: fixed; bottom: 20px; right: 20px; background: #1e293b; color: #f1f5f9; padding: 15px; border-radius: 12px; z-index: 10000; font-size: 12px; max-width: 400px; max-height: 300px; overflow: auto; font-family: monospace; }
        .debug-toggle { position: fixed; bottom: 20px; left: 20px; background: #3b82f6; color: white; padding: 10px 15px; border-radius: 10px; cursor: pointer; z-index: 10000; }
    </style>
</head>
<body>

    <!-- èª¿è©¦é¢æ¿ -->
    <div class="debug-panel" id="debug-panel" style="display: none;">
        <div class="flex justify-between items-center mb-3">
            <h3 class="font-bold">ğŸ› ï¸ èª¿è©¦é¢æ¿</h3>
            <button onclick="toggleDebug()" class="text-xs text-slate-300">é—œé–‰</button>
        </div>
        <div id="debug-content"></div>
    </div>
    <div class="debug-toggle" onclick="toggleDebug()">ğŸ› ï¸ èª¿è©¦</div>

    <div class="main-container">
        <div class="flex justify-between items-center mb-10">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-slate-900 rounded-2xl flex items-center justify-center shadow-xl">
                    <span class="text-white font-black italic text-2xl">SI</span>
                </div>
                <div>
                    <h1 class="text-xl font-black italic">æ´»å‹•è¦æ ¼å°ˆå®¶ç«¯</h1>
                    <p class="text-xs text-slate-400 font-bold uppercase">Standardized Activity Architect</p>
                    <div class="flex gap-2 mt-2">
                        <button onclick="testDirectGAS()" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-lg font-bold">
                            æ¸¬è©¦ GAS
                        </button>
                        <button onclick="testWorker()" class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-lg font-bold">
                            æ¸¬è©¦ Worker
                        </button>
                    </div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="window.location.href='index.html'" class="text-slate-400 font-bold text-sm px-5 py-2.5 border rounded-xl bg-white shadow-sm">
                    è¿”å›é¦–é 
                </button>
                <button onclick="EventManager.openEditor(null)" class="bg-[#1877f2] text-white px-8 py-3 rounded-xl font-bold shadow-lg">
                    + æ–°å¢èª²ç¨‹è¦æ ¼
                </button>
            </div>
        </div>
        
        <!-- ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
        <div id="status-indicator" class="mb-6 p-4 bg-white rounded-2xl shadow-sm border">
            <div class="flex items-center justify-between">
                <div>
                    <span id="status-text" class="font-bold">æ­£åœ¨æª¢æŸ¥è³‡æ–™åº«é€£æ¥...</span>
                    <div id="status-details" class="text-sm text-slate-500 mt-1"></div>
                </div>
                <div class="flex gap-2">
                    <button onclick="init()" class="text-xs bg-slate-100 text-slate-700 px-3 py-1.5 rounded-lg font-bold">
                        ğŸ”„ é‡æ–°æª¢æŸ¥
                    </button>
                    <button onclick="addSampleData()" class="text-xs bg-green-100 text-green-700 px-3 py-1.5 rounded-lg font-bold">
                        + æ·»åŠ ç¯„ä¾‹æ•¸æ“š
                    </button>
                </div>
            </div>
        </div>
        
        <div id="admin-event-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>
    </div>

    <!-- ç·¨è¼¯å™¨æ¨¡æ…‹æ¡†ï¼ˆä¿æŒä¸è®Šï¼‰ -->
    <div id="editor-modal" class="modal-overlay" onclick="if(event.target===this) EventManager.closeEditor()">
        <div class="modal-content">
            <!-- ... ç·¨è¼¯å™¨å…§å®¹ä¿æŒä¸è®Š ... -->
        </div>
    </div>

    <script>
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/";
        const GAS_URL = "https://script.google.com/macros/s/AKfycbzJpUBaCpY1_-Qp631fpbZl-T3F5OxU-XmAXpgqQKY-NyHfei3lf8pL_W8YfkSkRRQE/exec";
        
        let state = { 
            events: [], 
            config: { sportCategories: [], rentalItems: [] }, 
            currentEditId: null, 
            currentType: 'å–®æ—¥å‹' 
        };

        // èª¿è©¦åŠŸèƒ½
        function debugLog(message, data = null) {
            const debugContent = document.getElementById('debug-content');
            const entry = document.createElement('div');
            entry.className = 'mb-2 pb-2 border-b border-slate-700';
            
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span class="text-slate-400">[${timestamp}]</span> ${message}`;
            
            if (data) {
                const pre = document.createElement('pre');
                pre.className = 'mt-1 text-xs overflow-x-auto bg-slate-800 p-2 rounded';
                pre.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
                entry.appendChild(pre);
            }
            
            debugContent.prepend(entry);
            
            // ä¿æŒæœ€æ–°100æ¢è¨˜éŒ„
            const children = debugContent.children;
            if (children.length > 100) {
                debugContent.removeChild(children[children.length - 1]);
            }
        }

        function toggleDebug() {
            const panel = document.getElementById('debug-panel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
        }

        // æ¸¬è©¦å‡½æ•¸
        async function testDirectGAS() {
            debugLog('ğŸ” é–‹å§‹æ¸¬è©¦ç›´æ¥è¨ªå• GAS...');
            
            try {
                const url = `${GAS_URL}?mode=getEvents&timestamp=${Date.now()}`;
                debugLog(`è¨ªå• URL: ${url}`);
                
                const response = await fetch(url);
                debugLog(`HTTP ç‹€æ…‹: ${response.status} ${response.statusText}`);
                
                const text = await response.text();
                debugLog('åŸå§‹éŸ¿æ‡‰:', text);
                
                try {
                    const data = JSON.parse(text);
                    debugLog('è§£æå¾Œçš„ JSON:', data);
                    alert(`âœ… GAS é€£æ¥æ­£å¸¸\nç‹€æ…‹: ${response.status}\næ•¸æ“šæ¢æ•¸: ${data.events ? data.events.length : 0}`);
                } catch (e) {
                    debugLog('JSON è§£æéŒ¯èª¤:', e.message);
                    alert('âš ï¸ GAS éŸ¿æ‡‰ä¸æ˜¯æœ‰æ•ˆçš„ JSON');
                }
            } catch (error) {
                debugLog('âŒ æ¸¬è©¦å¤±æ•—:', error.message);
                alert(`âŒ GAS é€£æ¥å¤±æ•—: ${error.message}`);
            }
        }

        async function testWorker() {
            debugLog('ğŸ” é–‹å§‹æ¸¬è©¦ Cloudflare Worker...');
            
            try {
                const url = `${PROXY_URL}?action=getEvents&_t=${Date.now()}`;
                debugLog(`è¨ªå• URL: ${url}`);
                
                const response = await fetch(url);
                debugLog(`HTTP ç‹€æ…‹: ${response.status} ${response.statusText}`);
                
                const text = await response.text();
                debugLog('Worker éŸ¿æ‡‰:', text);
                
                try {
                    const data = JSON.parse(text);
                    debugLog('Worker è¿”å›æ•¸æ“š:', data);
                    
                    // é¡¯ç¤ºè©³ç´°ä¿¡æ¯
                    const details = `
ç‹€æ…‹: ${data.status}
æ´»å‹•æ•¸é‡: ${data.data?.length || 0}
åˆ†é¡æ•¸é‡: ${data.config?.sportCategories?.length || 0}
è£å‚™æ•¸é‡: ${data.config?.rentalItems?.length || 0}
                    `;
                    
                    alert(`âœ… Worker é€£æ¥æ­£å¸¸\n${details}`);
                } catch (e) {
                    debugLog('JSON è§£æéŒ¯èª¤:', e.message);
                    alert('âš ï¸ Worker éŸ¿æ‡‰ä¸æ˜¯æœ‰æ•ˆçš„ JSON');
                }
            } catch (error) {
                debugLog('âŒ Worker æ¸¬è©¦å¤±æ•—:', error.message);
                alert(`âŒ Worker é€£æ¥å¤±æ•—: ${error.message}`);
            }
        }

        async function addSampleData() {
            debugLog('ğŸ“ æ·»åŠ ç¯„ä¾‹æ•¸æ“šåˆ° GAS...');
            
            const sampleEvent = {
                "æ´»å‹•ID": "EVT-" + Date.now(),
                "æ´»å‹•å‹æ…‹": "å–®æ—¥å‹",
                "æ´»å‹•åç¨±": "å…’ç«¥ç±ƒçƒé«”é©—èª²",
                "åˆ†é¡": "ç±ƒçƒ",
                "é–‹å§‹æ—¥æœŸ": "2024-01-15",
                "çµæŸæ—¥æœŸ": "2024-01-15",
                "å…¨æ—¥åƒ¹": 1200,
                "å…¨æ—¥æ‰£é™¤": 0,
                "åŠæ—¥æ‰£é™¤": 0,
                "åœ–ç‰‡URL": "https://example.com/basketball.jpg",
                "ç‹€æ…‹": "ä¸Šæ¶",
                "ç¸½åé¡": 20,
                "å…§å®¹åª’é«”": "ç±ƒçƒ,è­·å…·",
                "æè¿°": "å°ˆç‚ºå…’ç«¥è¨­è¨ˆçš„ç±ƒçƒåŸºç¤è¨“ç·´èª²ç¨‹",
                "å…¨æ—¥æ—©é³¥åƒ¹": 1000,
                "æ—©é³¥æˆªæ­¢æ—¥æœŸ": "2024-01-10T18:00:00"
            };
            
            try {
                const response = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'updateEvent',
                        payload: sampleEvent
                    })
                });
                
                const result = await response.json();
                debugLog('æ·»åŠ çµæœ:', result);
                
                if (result.status === 'success') {
                    alert('âœ… ç¯„ä¾‹æ•¸æ“šæ·»åŠ æˆåŠŸï¼é‡æ–°è¼‰å…¥æ•¸æ“šä¸­...');
                    setTimeout(init, 1000);
                } else {
                    alert(`âŒ æ·»åŠ å¤±æ•—: ${result.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            } catch (error) {
                debugLog('æ·»åŠ å¤±æ•—:', error);
                alert(`âŒ æ·»åŠ å¤±æ•—: ${error.message}`);
            }
        }

        async function init() {
            debugLog('ğŸš€ é–‹å§‹åˆå§‹åŒ–...');
            updateStatus('æ­£åœ¨é€£æ¥è³‡æ–™åº«...', 'info');
            
            try {
                // å…ˆæ¸¬è©¦ Worker
                debugLog('æ¸¬è©¦ Worker é€£æ¥...');
                const response = await fetch(`${PROXY_URL}?action=getEvents&_t=${Date.now()}`);
                
                updateStatus(`Worker éŸ¿æ‡‰: ${response.status}`, 'info');
                debugLog(`Worker ç‹€æ…‹: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    throw new Error(`Worker è¿”å›éŒ¯èª¤: ${response.status}`);
                }
                
                const text = await response.text();
                debugLog('åŸå§‹éŸ¿æ‡‰æ–‡æœ¬:', text);
                
                let data;
                try {
                    data = JSON.parse(text);
                    debugLog('è§£æå¾Œçš„æ•¸æ“š:', data);
                } catch (e) {
                    debugLog('JSON è§£æéŒ¯èª¤:', e.message);
                    throw new Error('ç„¡æ•ˆçš„ JSON éŸ¿æ‡‰');
                }
                
                // æª¢æŸ¥æ•¸æ“šçµæ§‹
                if (data.status === 'error') {
                    throw new Error(data.message || 'ä¼ºæœå™¨è¿”å›éŒ¯èª¤ç‹€æ…‹');
                }
                
                // è™•ç†æ•¸æ“š
                state.events = Array.isArray(data.data) ? data.data : [];
                state.config.sportCategories = Array.isArray(data.config?.sportCategories) ? 
                    data.config.sportCategories : [];
                state.config.rentalItems = Array.isArray(data.config?.rentalItems) ? 
                    data.config.rentalItems : [];
                
                debugLog('è™•ç†å¾Œçš„ç‹€æ…‹:', {
                    events: state.events.length,
                    categories: state.config.sportCategories.length,
                    equipment: state.config.rentalItems.length
                });
                
                // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
                updateStatus(`å·²è¼‰å…¥ ${state.events.length} å€‹æ´»å‹•ï¼Œ${state.config.sportCategories.length} å€‹åˆ†é¡`, 'success');
                
                // æ¸²æŸ“
                EventManager.renderGrid();
                
            } catch (error) {
                debugLog('âŒ åˆå§‹åŒ–å¤±æ•—:', error.message);
                updateStatus(`è¼‰å…¥å¤±æ•—: ${error.message}`, 'error');
                
                // é¡¯ç¤ºéŒ¯èª¤ç•Œé¢
                document.getElementById('admin-event-grid').innerHTML = `
                    <div class="col-span-full">
                        <div class="bg-red-50 border border-red-200 rounded-2xl p-8 text-center">
                            <div class="text-5xl mb-4">ğŸš¨</div>
                            <h3 class="text-xl font-bold text-red-800 mb-2">æ•¸æ“šåº«é€£æ¥å¤±æ•—</h3>
                            <p class="text-red-600 mb-6">${error.message}</p>
                            <div class="flex flex-col gap-3 max-w-md mx-auto">
                                <button onclick="testDirectGAS()" class="bg-blue-500 text-white px-6 py-3 rounded-xl font-bold">
                                    æ¸¬è©¦ Google Apps Script
                                </button>
                                <button onclick="testWorker()" class="bg-green-500 text-white px-6 py-3 rounded-xl font-bold">
                                    æ¸¬è©¦ Cloudflare Worker
                                </button>
                                <button onclick="addSampleData()" class="bg-purple-500 text-white px-6 py-3 rounded-xl font-bold">
                                    æ·»åŠ æ¸¬è©¦æ•¸æ“š
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function updateStatus(message, type = 'info') {
            const statusText = document.getElementById('status-text');
            const statusDetails = document.getElementById('status-details');
            const indicator = document.getElementById('status-indicator');
            
            if (statusText) statusText.textContent = message;
            
            // æ›´æ–°æ¨£å¼
            const colors = {
                info: { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-800' },
                success: { bg: 'bg-green-50', border: 'border-green-200', text: 'text-green-800' },
                error: { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-800' }
            };
            
            const color = colors[type] || colors.info;
            indicator.className = `mb-6 p-4 ${color.bg} rounded-2xl shadow-sm ${color.border} border`;
            statusText.className = `font-bold ${color.text}`;
            
            // æ›´æ–°æ™‚é–“
            if (statusDetails) {
                statusDetails.textContent = `æœ€å¾Œæª¢æŸ¥: ${new Date().toLocaleTimeString('zh-TW')}`;
            }
        }

        const EventManager = {
            renderGrid() {
                const grid = document.getElementById('admin-event-grid');
                
                if (!state.events || state.events.length === 0) {
                    grid.innerHTML = `
                        <div class="col-span-full">
                            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-dashed border-blue-200 rounded-2xl p-12 text-center">
                                <div class="text-6xl mb-6">ğŸ“</div>
                                <h3 class="text-2xl font-black text-slate-800 mb-3">è³‡æ–™åº«ç‚ºç©º</h3>
                                <p class="text-slate-600 mb-6">å°šæœªå»ºç«‹ä»»ä½•æ´»å‹•è¦æ ¼ï¼Œé»æ“Šä¸‹æ–¹æŒ‰éˆ•é–‹å§‹å»ºç«‹</p>
                                <div class="flex gap-4 justify-center">
                                    <button onclick="EventManager.openEditor(null)" 
                                            class="bg-gradient-to-r from-blue-500 to-blue-600 text-white px-10 py-4 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl transition-all">
                                        + å»ºç«‹æ–°è¦æ ¼
                                    </button>
                                    <button onclick="addSampleData()" 
                                            class="bg-gradient-to-r from-green-500 to-emerald-600 text-white px-10 py-4 rounded-2xl font-bold text-lg shadow-xl hover:shadow-2xl transition-all">
                                        ğŸ¯ æ·»åŠ ç¯„ä¾‹
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                grid.innerHTML = state.events.map(ev => `
                    <div class="bg-white p-7 rounded-[2.5rem] border shadow-sm flex gap-6 items-center hover:border-[#1877f2] transition-all">
                        <img src="${ev['åœ–ç‰‡URL'] || 'https://placehold.co/200x200'}" class="w-24 h-24 rounded-3xl object-cover bg-slate-100 shadow-inner">
                        <div class="flex-1">
                            <span class="text-[10px] font-black px-2.5 py-1 rounded-full bg-blue-50 text-[#1877f2] uppercase tracking-tighter">${ev['æ´»å‹•å‹æ…‹']}</span>
                            <h4 class="font-black text-xl text-slate-800 leading-tight mt-2">${ev['æ´»å‹•åç¨±']}</h4>
                            <button onclick="EventManager.openEditor('${ev['æ´»å‹•ID']}')" class="text-[#1877f2] font-black text-sm mt-4 border-b-2 border-blue-50 hover:border-blue-500 transition-all">ç·¨è¼¯è¦æ ¼ Matrix</button>
                        </div>
                    </div>`).join('');
            },
            
            // ... å…¶ä»–æ–¹æ³•ä¿æŒä¸è®Š ...
            setType(t) {
                state.currentType = t;
                document.querySelectorAll('.type-pill').forEach(el => el.classList.toggle('active', el.innerText.includes(t.substring(0,2))));
                document.getElementById('area-batch').classList.toggle('hidden', t !== 'æ¢¯æ¬¡å‹');
                document.getElementById('area-term').classList.toggle('hidden', t !== 'å¸¸æ…‹å‹');
            },
            
            appendSession(obj = { n: "", s: "", e: "" }) {
                const container = document.getElementById('session-list-container');
                const count = container.children.length + 1;
                const div = document.createElement('div'); div.className = "session-row";
                div.innerHTML = `<div class="flex justify-between mb-4"><span class="font-bold text-sm text-slate-400">#${count} æ¢¯æ¬¡æ˜ç´°</span><button onclick="this.closest('.session-row').remove()" class="text-red-400 text-xs font-bold uppercase">ç§»é™¤</button></div>
                    <input type="text" class="input-field session-n mb-4" value="${obj.n || 'ç¬¬'+count+'æ¢¯æ¬¡'}" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸€æ¢¯æ¬¡ (å¯’å‡ä¸Šåˆç­)">
                    <div class="grid grid-cols-2 gap-4"><input type="datetime-local" class="input-field session-s" value="${obj.s}"><input type="datetime-local" class="input-field session-e" value="${obj.e}"></div>`;
                container.appendChild(div);
            },
            
            openEditor(id) {
                state.currentEditId = id; 
                const ev = state.events.find(e => String(e['æ´»å‹•ID']) === String(id)) || {};
                document.getElementById('editor-modal').classList.add('active');
                document.getElementById('session-list-container').innerHTML = "";
                document.getElementById('ed-cat').innerHTML = state.config.sportCategories.map(c => `<option value="${c}">${c}</option>`).join('');
                
                // è£å‚™ç§Ÿç”¨å‹¾é¸é‚è¼¯
                const activeEq = (ev['å…§å®¹åª’é«”'] || "").split(',').filter(i=>i);
                document.getElementById('activity-eq-options').innerHTML = state.config.rentalItems.map(it => `
                    <label class="eq-chip"><input type="checkbox" class="act-eq" value="${it.name || it}" ${activeEq.includes(it.name || it)?'checked':''}> ${it.name || it}</label>
                `).join('') || '<p class="text-slate-300 italic">è«‹å…ˆè‡³åƒæ•¸å€æ–°å¢ç§Ÿç”¨è£å‚™</p>';

                document.getElementById('ed-name').value = ev['æ´»å‹•åç¨±'] || "";
                document.getElementById('ed-cat').value = ev['åˆ†é¡'] || "";
                document.getElementById('ed-start').value = ev['é–‹å§‹æ—¥æœŸ'] ? ev['é–‹å§‹æ—¥æœŸ'].substring(0,10) : "";
                document.getElementById('ed-end').value = ev['çµæŸæ—¥æœŸ'] ? ev['çµæŸæ—¥æœŸ'].substring(0,10) : "";
                document.getElementById('ed-price').value = ev['å…¨æ—¥åƒ¹'] || 0;
                document.getElementById('ed-deduct').value = ev['å…¨æ—¥æ‰£é™¤'] || 0;
                document.getElementById('ed-deduct-half').value = ev['åŠæ—¥æ‰£é™¤'] || 0;
                document.getElementById('ed-img').value = ev['åœ–ç‰‡URL'] || "";
                document.getElementById('ed-desc').value = ev['æè¿°'] || "";
                document.getElementById('ed-quota').value = ev['ç¸½åé¡'] || 0;
                document.getElementById('ed-early-price').value = ev['å…¨æ—¥æ—©é³¥åƒ¹'] || "";
                document.getElementById('ed-early-date').value = ev['æ—©é³¥æˆªæ­¢æ—¥æœŸ'] ? ev['æ—©é³¥æˆªæ­¢æ—¥æœŸ'].substring(0,16) : "";
                
                this.setType(ev['æ´»å‹•å‹æ…‹'] || 'å–®æ—¥å‹');
                const raw = ev['æ¢¯æ¬¡è³‡æ–™'] || "";
                if(state.currentType === 'æ¢¯æ¬¡å‹' && raw) { try { JSON.parse(raw).forEach(s => this.appendSession(s)); } catch(e){} }
                else if (state.currentType === 'å¸¸æ…‹å‹' && raw) {
                    const days = raw.split(','); document.querySelectorAll('.wk-day').forEach(el => el.checked = days.includes(el.value));
                }
            },
            
            closeEditor() { document.getElementById('editor-modal').classList.remove('active'); },
            
            async save() {
                const btn = document.getElementById('btn-save'); 
                btn.disabled = true; 
                btn.innerText = "æ­£åœ¨åŠ å¯†åŒæ­¥è‡³é›²ç«¯...";
                
                try {
                    let sessionData = "";
                    if(state.currentType === 'æ¢¯æ¬¡å‹') {
                        sessionData = JSON.stringify(Array.from(document.querySelectorAll('.session-row')).map(r => ({
                            n: r.querySelector('.session-n').value, 
                            s: r.querySelector('.session-s').value, 
                            e: r.querySelector('.session-e').value
                        })));
                    } else if(state.currentType === 'å¸¸æ…‹å‹') {
                        sessionData = Array.from(document.querySelectorAll('.wk-day:checked')).map(el => el.value).join(',');
                    }

                    const payload = { 
                        "æ´»å‹•ID": state.currentEditId || ("EVT-" + Date.now()), 
                        "æ´»å‹•å‹æ…‹": state.currentType, 
                        "æ´»å‹•åç¨±": document.getElementById('ed-name').value, 
                        "åˆ†é¡": document.getElementById('ed-cat').value, 
                        "æ¢¯æ¬¡è³‡æ–™": sessionData, 
                        "é–‹å§‹æ—¥æœŸ": document.getElementById('ed-start').value, 
                        "çµæŸæ—¥æœŸ": document.getElementById('ed-end').value, 
                        "å…¨æ—¥åƒ¹": document.getElementById('ed-price').value, 
                        "å…¨æ—¥æ‰£é™¤": document.getElementById('ed-deduct').value, 
                        "åŠæ—¥æ‰£é™¤": document.getElementById('ed-deduct-half').value,
                        "åœ–ç‰‡URL": document.getElementById('ed-img').value, 
                        "ç‹€æ…‹": "ä¸Šæ¶", 
                        "ç¸½åé¡": document.getElementById('ed-quota').value, 
                        "å…§å®¹åª’é«”": Array.from(document.querySelectorAll('.act-eq:checked')).map(el => el.value).join(','),
                        "æè¿°": document.getElementById('ed-desc').value, 
                        "å…¨æ—¥æ—©é³¥åƒ¹": document.getElementById('ed-early-price').value, 
                        "æ—©é³¥æˆªæ­¢æ—¥æœŸ": document.getElementById('ed-early-date').value
                    };

                    debugLog('ä¿å­˜æ•¸æ“š:', payload);
                    
                    const res = await fetch(PROXY_URL, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'updateEvent', payload }) 
                    });
                    
                    const result = await res.json();
                    debugLog('ä¿å­˜çµæœ:', result);
                    
                    if(result.status === 'success') { 
                        alert("ğŸ‰ å°ˆæ¥­æ´»å‹•è¦æ ¼å·²æˆåŠŸå­˜æª”ï¼"); 
                        setTimeout(() => location.reload(), 1500);
                    }
                    else { 
                        throw new Error(result.message || 'ä¿å­˜å¤±æ•—'); 
                    }
                } catch(error) {
                    debugLog('ä¿å­˜å¤±æ•—:', error);
                    alert("ä¿å­˜å¤±æ•—: " + error.message); 
                    btn.disabled = false;
                    btn.innerText = "åŒæ­¥ç™¼å¸ƒè‡³é‹å‹•å³¶è³‡æ–™åº« âœ";
                }
            }
        };

        window.onload = init;
    </script>
</body>
</html>
