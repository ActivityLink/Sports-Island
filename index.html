import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Users, 
  Calendar, 
  BarChart3, 
  UserPlus, 
  Search, 
  ChevronRight, 
  Plus, 
  History, 
  Settings,
  X,
  CreditCard,
  User,
  Phone,
  Info
} from 'lucide-react';
import { 
  Chart as ChartJS, 
  CategoryScale, 
  LinearScale, 
  PointElement, 
  LineElement, 
  Title, 
  Tooltip, 
  Legend, 
  ArcElement,
  Filler
} from 'chart.js';
import { Line, Doughnut } from 'react-chartjs-2';

// è¨»å†Š ChartJS çµ„ä»¶
ChartJS.register(
  CategoryScale,
  LinearScale,
  PointElement,
  LineElement,
  Title,
  Tooltip,
  Legend,
  ArcElement,
  Filler
);

/**
 * ç’°å¢ƒè®Šæ•¸èˆ‡è¨­å®š (å°æ¥ GAS å¾Œç«¯)
 */
const LIFF_ID = "2008786875-7COWtgtL";
const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/";

const App = () => {
  // --- åŸºç¤ç‹€æ…‹ ---
  const [loading, setLoading] = useState(true);
  const [msg, setMsg] = useState({ text: '', show: false });
  const [user, setUser] = useState({ uid: '', name: '', pic: '', role: 'ä¸€èˆ¬æˆå“¡', isRegistered: false });
  const [view, setView] = useState('activity'); 
  
  // --- è³‡æ–™ç‹€æ…‹ ---
  const [events, setEvents] = useState([]);
  const [family, setFamily] = useState([]);
  const [history, setHistory] = useState([]);
  const [config, setConfig] = useState({ bankInfo: '', sportCategories: '' });
  const [searchTerm, setSearchTerm] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('å…¨éƒ¨');

  // --- å½ˆçª—ç‹€æ…‹ ---
  const [modal, setModal] = useState({ type: null, data: null }); 

  // --- æç¤ºè¨Šæ¯æ§åˆ¶ ---
  const showToast = (text) => {
    setMsg({ text, show: true });
    setTimeout(() => setMsg({ text: '', show: false }), 3000);
  };

  // --- LIFF åˆå§‹åŒ–èˆ‡èº«ä»½æª¢æŸ¥ (å°æ¥ GAS: checkUser) ---
  useEffect(() => {
    const initLiff = async () => {
      try {
        if (typeof liff !== 'undefined') {
          await liff.init({ liffId: LIFF_ID });
          if (!liff.isLoggedIn()) {
            liff.login();
            return;
          }
          const profile = await liff.getProfile();
          
          // å‘¼å« GAS: action=checkUser
          const res = await fetch(`${PROXY_URL}?action=checkUser&uid=${profile.userId}`);
          const r = await res.json();
          
          if (r.status === 'registered') {
            setUser({
              uid: profile.userId,
              name: r.data.name || profile.displayName,
              pic: profile.pictureUrl,
              role: r.data.type, // GAS å›å‚³çš„è¨»å†Šå‹æ…‹
              isRegistered: true
            });
            // å¦‚æœæ˜¯ç®¡ç†å“¡ï¼Œé è¨­é€²å…¥ç®¡ç†é 
            if (r.data.type === 'ç®¡ç†å“¡') setView('admin');
          } else {
            setUser({
              uid: profile.userId,
              name: profile.displayName,
              pic: profile.pictureUrl,
              role: 'ä¸€èˆ¬æˆå“¡',
              isRegistered: false
            });
            setView('register');
          }
        }
      } catch (err) {
        console.error("LIFF Init Error:", err);
        showToast("ç³»çµ±é€£ç·šç•°å¸¸");
      } finally {
        setLoading(false);
      }
    };
    initLiff();
  }, []);

  // --- æ ¸å¿ƒè³‡æ–™æŠ“å– (å°æ¥ GAS å„é … Action) ---
  useEffect(() => {
    if (view === 'activity') fetchEventsAndConfig();
    if (view === 'member') {
      fetchFamily();
      fetchHistory();
    }
  }, [view]);

  const fetchEventsAndConfig = async () => {
    try {
      // å‘¼å« GAS: action=getEvents (åŒ…å« config)
      const res = await fetch(`${PROXY_URL}?action=getEvents&_t=${Date.now()}`);
      const r = await res.json();
      setEvents(r.data || []);
      if (r.config) setConfig(r.config);
    } catch (e) {
      showToast("ç„¡æ³•è®€å–æ´»å‹•åˆ—è¡¨");
    }
  };

  const fetchFamily = async () => {
    try {
      // å‘¼å« GAS: action=getFamily
      const res = await fetch(`${PROXY_URL}?action=getFamily&uid=${user.uid}`);
      const r = await res.json();
      setFamily(r.data || []);
    } catch (e) {
      console.error("Fetch Family Error:", e);
    }
  };

  const fetchHistory = async () => {
    try {
      // å‘¼å« GAS: action=getHistory
      const res = await fetch(`${PROXY_URL}?action=getHistory&uid=${user.uid}`);
      const r = await res.json();
      setHistory(r.data || []);
    } catch (e) {
      console.error("Fetch History Error:", e);
    }
  };

  // --- é‚è¼¯è™•ç†: è¨»å†Š (å°æ¥ GAS: registerUser) ---
  const handleRegister = async (roleName, displayName, phone) => {
    if (!displayName || !phone) return showToast("è«‹å¡«å¯«å®Œæ•´è³‡æ–™");
    showToast("æ­£åœ¨å»ºç«‹æ‚¨çš„å¸³è™Ÿ...");
    try {
      const res = await fetch(PROXY_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'registerUser',
          payload: { uid: user.uid, name: displayName, phone: phone, type: roleName }
        })
      });
      const r = await res.json();
      if (r.status === 'success') {
        showToast("ğŸ‰ æ­¡è¿åŠ å…¥é‹å‹•å³¶ï¼");
        setTimeout(() => window.location.reload(), 1000);
      }
    } catch (e) {
      showToast("è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  };

  // --- é‚è¼¯è™•ç†: æ–°å¢å­¸å“¡ (å°æ¥ GAS: addStudent) ---
  const handleAddStudent = async (studentData) => {
    showToast("è³‡æ–™å„²å­˜ä¸­...");
    try {
      const res = await fetch(PROXY_URL, {
        method: 'POST',
        body: JSON.stringify({
          action: 'addStudent',
          payload: { ...studentData, uid: user.uid }
        })
      });
      const r = await res.json();
      if (r.status === 'success') {
        showToast("æˆå“¡è³‡æ–™å·²æ›´æ–°");
        setModal({ type: null, data: null });
        fetchFamily();
      }
    } catch (e) {
      showToast("å„²å­˜å¤±æ•—");
    }
  };

  // --- è¨ˆç®—å±¬æ€§: å‹•æ…‹åˆ†é¡ ---
  const categories = useMemo(() => {
    const cats = ['å…¨éƒ¨'];
    if (config.sportCategories) {
      config.sportCategories.split(',').forEach(c => cats.push(c.trim()));
    } else {
      // Fallback
      [...new Set(events.map(e => e['åˆ†é¡']))].forEach(c => { if(c) cats.push(c); });
    }
    return cats;
  }, [events, config]);

  const filteredEvents = events.filter(ev => {
    const matchSearch = ev['æ´»å‹•åç¨±']?.toLowerCase().includes(searchTerm.toLowerCase());
    const matchCat = selectedCategory === 'å…¨éƒ¨' || ev['åˆ†é¡'] === selectedCategory;
    return matchSearch && matchCat;
  });

  if (loading) {
    return (
      <div className="fixed inset-0 bg-[#f0f2f5] flex flex-col items-center justify-center z-[9999]">
        <div className="w-12 h-12 border-[3px] border-[#1877f2] border-t-transparent rounded-full animate-spin"></div>
        <p className="mt-8 text-gray-400 text-sm tracking-[0.3em] uppercase">Sport Island Syncing</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#f0f2f5] text-[#1c1e21] font-sans pb-10">
      {/* å…¨åŸŸæç¤º */}
      {msg.show && (
        <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[10001] bg-[#1c1e21] text-white px-8 py-4 rounded-2xl shadow-2xl animate-in slide-in-from-top-4">
          {msg.text}
        </div>
      )}

      {/* å°è¦½åˆ— */}
      {user.isRegistered && view !== 'register' && (
        <header className="bg-[#1877f2] text-white sticky top-0 z-50 shadow-md">
          <div className="max-w-6xl mx-auto px-4 flex justify-between items-center h-20">
            <div className="flex items-center gap-4">
              <h1 className="text-xl font-medium tracking-tight">SPORTS ISLAND</h1>
              <div className="hidden sm:flex items-center gap-2 bg-white/10 px-3 py-1.5 rounded-full border border-white/20">
                <img src={user.pic} className="w-6 h-6 rounded-full border border-white/30" alt="avatar" />
                <span className="text-sm font-light">{user.name}</span>
              </div>
            </div>
            
            <nav className="flex h-full">
              <button 
                onClick={() => setView('activity')}
                className={`px-4 sm:px-6 flex items-center gap-2 border-b-4 transition-all ${view === 'activity' ? 'border-white text-white' : 'border-transparent text-white/70'}`}
              >
                <Calendar size={18} />
                <span className="hidden sm:inline">æ´»å‹•åˆ—è¡¨</span>
              </button>
              <button 
                onClick={() => setView('member')}
                className={`px-4 sm:px-6 flex items-center gap-2 border-b-4 transition-all ${view === 'member' ? 'border-white text-white' : 'border-transparent text-white/70'}`}
              >
                <Users size={18} />
                <span className="hidden sm:inline">æœƒå“¡ä¸­å¿ƒ</span>
              </button>
              {user.role === 'ç®¡ç†å“¡' && (
                <button 
                  onClick={() => setView('admin')}
                  className={`px-4 sm:px-6 flex items-center gap-2 border-b-4 transition-all ${view === 'admin' ? 'border-white text-white' : 'border-transparent text-white/70'}`}
                >
                  <BarChart3 size={18} />
                  <span className="hidden sm:inline">ç®¡ç†å¾Œå°</span>
                </button>
              )}
            </nav>
          </div>
        </header>
      )}

      <main className="max-w-6xl mx-auto px-4 py-8">
        {/* [è¨»å†Šè¦–åœ–] */}
        {view === 'register' && (
          <RegisterView 
            onRegister={handleRegister} 
            initialName={user.name} 
          />
        )}

        {/* [æ´»å‹•åˆ—è¡¨è¦–åœ–] */}
        {view === 'activity' && (
          <div className="animate-in fade-in duration-500">
            <div className="rounded-3xl overflow-hidden mb-10 shadow-lg relative h-[200px] sm:h-[300px] group">
              <img 
                src="https://aiwe.cc/wp-content/uploads/2025/12/3486bc19dc6317e16bf4f1449ec52ae4.jpg" 
                className="w-full h-full object-cover group-hover:scale-105 transition-transform duration-700" 
                alt="Banner"
              />
              <div className="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent flex items-end p-6 sm:p-10">
                <div className="text-white">
                  <h2 className="text-2xl sm:text-4xl mb-2 font-medium">æ¢ç´¢æ‚¨çš„é‹å‹•ç†±æƒ…</h2>
                  <p className="text-white/80 text-sm sm:text-base">å°ˆæ¥­èª²ç¨‹ã€å„ªè³ªå¸«è³‡ï¼Œèˆ‡æˆ‘å€‘ä¸€èµ·æ®ç‘æ±—æ°´</p>
                </div>
              </div>
            </div>

            <div className="flex flex-col md:flex-row gap-4 mb-8">
              <div className="relative flex-1">
                <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400" size={20} />
                <input 
                  type="text" 
                  placeholder="æœå°‹æ´»å‹•åç¨±..."
                  className="w-full pl-12 pr-4 py-4 rounded-2xl border-none shadow-sm focus:ring-2 focus:ring-[#1877f2] outline-none"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
              </div>
              <div className="flex gap-2 overflow-x-auto no-scrollbar py-1">
                {categories.map(cat => (
                  <button
                    key={cat}
                    onClick={() => setSelectedCategory(cat)}
                    className={`px-6 py-4 rounded-2xl whitespace-nowrap transition-all font-medium ${selectedCategory === cat ? 'bg-[#1877f2] text-white shadow-lg' : 'bg-white text-gray-500 hover:bg-gray-50'}`}
                  >
                    {cat}
                  </button>
                ))}
              </div>
            </div>

            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
              {filteredEvents.map((ev, idx) => (
                <div 
                  key={idx} 
                  className="bg-white rounded-[32px] overflow-hidden shadow-sm hover:shadow-xl transition-all group flex flex-col"
                >
                  <div className="relative h-52 overflow-hidden">
                    <img 
                      src={ev['åœ–ç‰‡URL'] || 'https://placehold.co/600x400'} 
                      className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" 
                      alt={ev['æ´»å‹•åç¨±']}
                    />
                    <div className="absolute top-4 left-4 bg-white/95 backdrop-blur px-3 py-1.5 rounded-full text-xs text-[#1877f2] font-semibold uppercase tracking-wider shadow-sm">
                      {ev['åˆ†é¡']}
                    </div>
                  </div>
                  <div className="p-6 flex flex-col flex-1">
                    <h3 className="text-lg font-medium mb-3 line-clamp-2 leading-snug">{ev['æ´»å‹•åç¨±']}</h3>
                    <div className="flex items-center gap-2 text-gray-400 text-sm mb-6">
                      <Calendar size={14} />
                      <span>{ev['æ—¥æœŸ'] || 'é€±ä¸€è‡³é€±äº”'}</span>
                    </div>
                    <div className="mt-auto flex items-center justify-between pt-4 border-t border-gray-50">
                      <div className="text-[#1877f2] font-semibold text-lg">
                        $ {ev['è²»ç”¨'] || '0'}
                      </div>
                      <button 
                        onClick={() => setModal({ type: 'detail', data: ev })}
                        className="flex items-center gap-1 text-sm text-gray-400 hover:text-[#1877f2] transition-colors"
                      >
                        è©³ç´°å…§å®¹ <ChevronRight size={16} />
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* [æœƒå“¡ä¸­å¿ƒè¦–åœ–] */}
        {view === 'member' && (
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-10 animate-in fade-in duration-500">
            <div className="lg:col-span-7 space-y-8">
              <div className="flex justify-between items-center">
                <div>
                  <h2 className="text-2xl font-medium mb-1">æˆå“¡ç®¡ç†</h2>
                  <p className="text-sm text-gray-400">ç®¡ç†æ‚¨çš„å®¶åº­æˆå“¡æˆ–å ±åå°è±¡</p>
                </div>
                <button 
                  onClick={() => setModal({ type: 'addMember', data: null })}
                  className="bg-white hover:bg-gray-50 text-[#1877f2] border border-[#1877f2]/20 px-5 py-2.5 rounded-2xl flex items-center gap-2 transition-all shadow-sm font-medium"
                >
                  <Plus size={18} /> æ–°å¢æˆå“¡
                </button>
              </div>
              
              <div className="space-y-4">
                {family.length > 0 ? family.map((m, i) => (
                  <div key={i} className="bg-white p-5 rounded-[24px] flex items-center gap-5 shadow-sm border border-transparent hover:border-[#1877f2]/10 transition-all">
                    <div className="w-14 h-14 bg-[#e7f3ff] rounded-2xl flex items-center justify-center text-[#1877f2] text-xl font-bold italic">
                      {m.å§“å ? m.å§“å.charAt(0) : '?'}
                    </div>
                    <div className="flex-1">
                      <h4 className="font-medium text-lg text-gray-800">{m.å§“å}</h4>
                      <p className="text-sm text-gray-400">{m.å¹´ç´š || 'ä¸€èˆ¬å­¸å“¡'} â€¢ {m.ç”Ÿæ—¥ || 'æœªå¡«å¯«ç”Ÿæ—¥'}</p>
                    </div>
                    <button className="p-2 text-gray-300 hover:text-[#1877f2]"><ChevronRight /></button>
                  </div>
                )) : (
                  <div className="bg-white/50 border-2 border-dashed border-gray-200 rounded-[32px] p-16 text-center">
                    <Users className="mx-auto text-gray-200 mb-4" size={48} />
                    <p className="text-gray-400">ç›®å‰å°šæœªå»ºç«‹æˆå“¡è³‡æ–™</p>
                  </div>
                )}
              </div>
            </div>

            <div className="lg:col-span-5 space-y-8">
              <div className="flex items-center gap-2">
                <History className="text-[#1877f2]" size={24} />
                <h2 className="text-2xl font-medium">å ±åç´€éŒ„</h2>
              </div>
              <div className="space-y-4">
                {history.length > 0 ? history.map((h, i) => (
                  <div key={i} className="bg-white p-6 rounded-[28px] border-l-[6px] border-[#1877f2] shadow-sm relative overflow-hidden">
                    <div className={`absolute top-4 right-4 text-xs px-3 py-1 rounded-full font-medium ${h.å°å¸³ç‹€æ…‹ === 'å ±åæˆåŠŸ' ? 'bg-green-100 text-green-600' : 'bg-orange-100 text-orange-600'}`}>
                      {h.å°å¸³ç‹€æ…‹}
                    </div>
                    <h4 className="text-lg font-medium pr-16 mb-3 line-clamp-1">{h.æ´»å‹•åç¨±}</h4>
                    <div className="space-y-1.5 text-sm text-gray-400">
                      <div className="flex items-center gap-2"><User size={14} className="text-gray-300" /> {h.å­¸å“¡å§“å}</div>
                      <div className="flex items-center gap-2"><CreditCard size={14} className="text-gray-300" /> NT$ {h.æ‡‰ä»˜é‡‘é¡}</div>
                    </div>
                  </div>
                )) : (
                  <div className="text-center py-20 bg-white/30 rounded-[32px] border border-gray-100">
                    <p className="text-gray-400">å°šç„¡åƒåŠ ç´€éŒ„</p>
                  </div>
                )}
              </div>
            </div>
          </div>
        )}

        {/* [ç®¡ç†å“¡è¦–åœ–] */}
        {view === 'admin' && <AdminDashboard PROXY_URL={PROXY_URL} showToast={showToast} />}
      </main>

      {/* æ¨¡æ…‹å½ˆçª— (Modals) */}
      {modal.type && (
        <div className="fixed inset-0 z-[10002] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-black/40 backdrop-blur-sm" onClick={() => setModal({ type: null, data: null })}></div>
          <div className="bg-white w-full max-w-xl rounded-[40px] shadow-2xl relative z-10 overflow-hidden animate-in zoom-in-95 duration-200">
            
            {modal.type === 'detail' && (
              <>
                <div className="h-60 relative">
                  <img src={modal.data['åœ–ç‰‡URL']} className="w-full h-full object-cover" alt="" />
                  <button 
                    onClick={() => setModal({ type: null, data: null })}
                    className="absolute top-6 right-6 w-10 h-10 bg-black/20 hover:bg-black/40 text-white rounded-full flex items-center justify-center backdrop-blur transition-all"
                  >
                    <X size={20} />
                  </button>
                </div>
                <div className="p-8">
                  <div className="flex gap-2 mb-4">
                    <span className="text-xs bg-[#e7f3ff] text-[#1877f2] px-3 py-1 rounded-full font-semibold uppercase">{modal.data['åˆ†é¡']}</span>
                    <span className="text-xs bg-gray-100 text-gray-500 px-3 py-1 rounded-full font-medium">é™é¡ {modal.data['åé¡'] || 'ç„¡'} äºº</span>
                  </div>
                  <h3 className="text-2xl font-medium mb-6 leading-tight">{modal.data['æ´»å‹•åç¨±']}</h3>
                  
                  <div className="space-y-4 mb-8 text-gray-600">
                    <div className="flex gap-4">
                      <Calendar className="text-[#1877f2] shrink-0" size={20} />
                      <div>
                        <p className="font-semibold text-gray-800">æ´»å‹•æ—¥æœŸèˆ‡æ™‚é–“</p>
                        <p className="text-sm">{modal.data['æ—¥æœŸ'] || 'è©³æƒ…è«‹æ´½å®˜æ–¹'} | {modal.data['æ™‚é–“'] || '09:00 - 17:00'}</p>
                      </div>
                    </div>
                    <div className="flex gap-4">
                      <Settings className="text-[#1877f2] shrink-0" size={20} />
                      <div>
                        <p className="font-semibold text-gray-800">æ´»å‹•èªªæ˜</p>
                        <p className="text-sm leading-relaxed">{modal.data['å‚™è¨»'] || 'æœ¬æ´»å‹•ç‚ºå°ˆæ¥­å¸«è³‡æŒ‡å°ï¼Œè«‹ç©¿è‘—è¼•ä¾¿é‹å‹•æœé£¾èˆ‡é£²æ°´ã€‚'}</p>
                      </div>
                    </div>
                    {config.bankInfo && (
                      <div className="flex gap-4 p-4 bg-gray-50 rounded-2xl border border-gray-100">
                        <Info className="text-orange-400 shrink-0" size={20} />
                        <div>
                          <p className="font-semibold text-gray-800 text-sm">ç¹³è²»è³‡è¨Š</p>
                          <p className="text-xs text-gray-500 mt-0.5 whitespace-pre-line">{config.bankInfo}</p>
                        </div>
                      </div>
                    )}
                  </div>

                  <button 
                    className="w-full bg-[#1877f2] text-white py-5 rounded-3xl font-medium shadow-xl hover:shadow-[#1877f2]/30 transition-all flex items-center justify-center gap-2"
                    onClick={() => {
                      setModal({ type: null, data: null });
                      showToast("å ±åç³»çµ±ç›®å‰åƒ…ä¾›æª¢è¦–ï¼ŒåŠŸèƒ½é–‹ç™¼ä¸­");
                    }}
                  >
                    ç«‹å³å ±å (NT$ {modal.data['è²»ç”¨'] || 0})
                  </button>
                </div>
              </>
            )}

            {modal.type === 'addMember' && (
              <div className="p-10">
                <div className="flex justify-between items-center mb-8">
                  <h3 className="text-2xl font-medium">æ–°å¢æˆå“¡è³‡æ–™</h3>
                  <X className="cursor-pointer text-gray-400 hover:text-gray-600" onClick={() => setModal({ type: null, data: null })} />
                </div>
                <form className="space-y-6" onSubmit={(e) => {
                  e.preventDefault();
                  const formData = new FormData(e.target);
                  handleAddStudent({
                    å§“å: formData.get('name'),
                    ç”Ÿæ—¥: formData.get('birthday'),
                    å¹´ç´š: formData.get('grade'),
                    èº«åˆ†è­‰è™Ÿ: formData.get('id')
                  });
                }}>
                  <div>
                    <label className="block text-sm font-medium text-gray-400 mb-2 ml-1">çœŸå¯¦å§“å</label>
                    <input name="name" required type="text" placeholder="ä¾‹ï¼šç‹å°æ˜" className="w-full bg-gray-50 border-none rounded-2xl p-4 outline-none focus:ring-2 focus:ring-[#1877f2]" />
                  </div>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-400 mb-2 ml-1">å‡ºç”Ÿæ—¥æœŸ</label>
                      <input name="birthday" required type="date" className="w-full bg-gray-50 border-none rounded-2xl p-4 outline-none focus:ring-2 focus:ring-[#1877f2]" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-400 mb-2 ml-1">å°±è®€å¹´ç´š</label>
                      <input name="grade" type="text" placeholder="ä¾‹ï¼šå°å­¸ä¸‰å¹´ç´š" className="w-full bg-gray-50 border-none rounded-2xl p-4 outline-none focus:ring-2 focus:ring-[#1877f2]" />
                    </div>
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-400 mb-2 ml-1">èº«åˆ†è­‰/å±…ç•™è­‰å¾Œå››ç¢¼</label>
                    <input name="id" required type="text" placeholder="ä¿éšªèˆ‡èº«åˆ†æ ¸å°ä½¿ç”¨" className="w-full bg-gray-50 border-none rounded-2xl p-4 outline-none focus:ring-2 focus:ring-[#1877f2]" />
                  </div>
                  <button 
                    type="submit"
                    className="w-full bg-[#1877f2] text-white py-5 rounded-3xl font-medium mt-4 shadow-lg shadow-[#1877f2]/20 hover:opacity-90 transition-opacity"
                  >
                    ç¢ºèªå„²å­˜
                  </button>
                </form>
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

/**
 * è¨»å†Šè¦–åœ–çµ„ä»¶
 */
const RegisterView = ({ onRegister, initialName }) => {
  const [role, setRole] = useState('ä¸€èˆ¬æˆå“¡');
  const [name, setName] = useState(initialName || '');
  const [phone, setPhone] = useState('');

  const roles = [
    { id: 'ä¸€èˆ¬æˆå“¡', title: 'ä¸€èˆ¬æˆå“¡', desc: 'å ±åé‹å‹•æ´»å‹•èˆ‡ç®¡ç†å€‹äººè³‡æ–™', icon: 'ğŸƒ' },
    { id: 'æ•™ç·´', title: 'å°ˆæ¥­æ•™ç·´', desc: 'æŒ‡å°èª²ç¨‹èˆ‡æŸ¥çœ‹å­¸å“¡è³‡è¨Š', icon: 'ğŸ¾' },
    { id: 'å­¸æ ¡', title: 'å­¸æ ¡å–®ä½', desc: 'åœ˜é«”å ±åèˆ‡æ ¡åœ’åˆç´„æ´»å‹•', icon: 'ğŸ«' },
    { id: 'æ©Ÿé—œå–®ä½', title: 'æ©Ÿé—œå–®ä½', desc: 'æ”¿åºœæˆ–æ°‘é–“æ©Ÿæ§‹åˆä½œç®¡ç†', icon: 'ğŸ¢' },
    { id: 'ç®¡ç†å“¡', title: 'ç³»çµ±ç®¡ç†å“¡', desc: 'æ¥­è€…å°ˆç”¨ï¼šç®¡ç†æ´»å‹•èˆ‡æ•¸æ“š', icon: 'âš™ï¸' }
  ];

  return (
    <div className="max-w-2xl mx-auto animate-in fade-in zoom-in-95 duration-700">
      <div className="bg-white rounded-[48px] shadow-xl p-8 sm:p-16 text-center border border-gray-50">
        <div className="w-20 h-20 bg-[#e7f3ff] rounded-[30px] flex items-center justify-center mx-auto mb-8 text-4xl">ğŸ…</div>
        <h2 className="text-3xl font-medium mb-4">é–‹å§‹æ‚¨çš„é‹å‹•ä¹‹æ—…</h2>
        <p className="text-gray-400 mb-12">è«‹è¨­å®šæ‚¨çš„å¸³è™Ÿèº«ä»½ï¼Œé€™å°‡æ±ºå®šæ‚¨å¾ŒçºŒçš„åŠŸèƒ½æ¬Šé™ã€‚</p>
        
        <div className="text-left space-y-8">
          <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-medium text-gray-400 mb-3 ml-2">é¡¯ç¤ºå§“å</label>
              <input 
                type="text" 
                value={name}
                onChange={(e) => setName(e.target.value)}
                className="w-full bg-gray-50 border-none rounded-2xl p-5 outline-none focus:ring-2 focus:ring-[#1877f2] text-lg font-medium"
                placeholder="å€‹äººå§“åæˆ–å–®ä½åç¨±"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-400 mb-3 ml-2">è¯çµ¡é›»è©±</label>
              <input 
                type="tel" 
                value={phone}
                onChange={(e) => setPhone(e.target.value)}
                className="w-full bg-gray-50 border-none rounded-2xl p-5 outline-none focus:ring-2 focus:ring-[#1877f2] text-lg font-medium"
                placeholder="ä¾‹ï¼š0912345678"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-400 mb-3 ml-2">é¸æ“‡èº«ä»½è§’è‰²</label>
            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
              {roles.map(r => (
                <div 
                  key={r.id}
                  onClick={() => setRole(r.id)}
                  className={`p-6 rounded-[28px] border-2 transition-all cursor-pointer flex flex-col items-start gap-1 ${role === r.id ? 'border-[#1877f2] bg-[#f0f7ff]' : 'border-gray-50 hover:border-gray-100 hover:bg-gray-50'}`}
                >
                  <span className="text-2xl mb-2">{r.icon}</span>
                  <span className={`font-semibold ${role === r.id ? 'text-[#1877f2]' : 'text-gray-700'}`}>{r.title}</span>
                  <span className="text-xs text-gray-400 leading-relaxed">{r.desc}</span>
                </div>
              ))}
            </div>
          </div>

          <button 
            onClick={() => onRegister(role, name, phone)}
            className="w-full bg-[#1877f2] text-white py-6 rounded-3xl text-xl font-medium shadow-xl shadow-[#1877f2]/20 hover:opacity-95 transition-all mt-6"
          >
            å®Œæˆè¨»å†Šä¸¦é€²å…¥ç³»çµ± âœ
          </button>
        </div>
      </div>
    </div>
  );
};

/**
 * ç®¡ç†å“¡å¾Œå°çµ„ä»¶
 */
const AdminDashboard = ({ PROXY_URL, showToast }) => {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [stats, setStats] = useState({ revenue: 0, regs: 0, members: 0, events: 0 });

  useEffect(() => {
    const fetchStats = async () => {
      try {
        const [evtRes, regRes, stuRes] = await Promise.all([
          fetch(`${PROXY_URL}?action=getEvents`),
          fetch(`${PROXY_URL}?action=adminGetAllRegs`),
          fetch(`${PROXY_URL}?action=adminGetAllStudents`)
        ]);
        const evts = (await evtRes.json()).data || [];
        const regs = (await regRes.json()).data || [];
        const stus = (await stuRes.json()).data || [];

        let totalRev = 0;
        regs.forEach(r => { if(r.å°å¸³ç‹€æ…‹ === "å ±åæˆåŠŸ") totalRev += Number(r.æ‡‰ä»˜é‡‘é¡ || 0); });

        setStats({
          revenue: totalRev,
          regs: regs.length,
          members: stus.length,
          events: evts.length
        });
      } catch (e) {
        console.error(e);
      }
    };
    fetchStats();
  }, [PROXY_URL]);

  const lineData = {
    labels: ['10æœˆ', '11æœˆ', '12æœˆ'],
    datasets: [{
      label: 'ç‡Ÿæ”¶é‡‘é¡',
      data: [42000, 75000, stats.revenue > 0 ? stats.revenue : 120000],
      borderColor: '#1877f2',
      backgroundColor: (context) => {
        const ctx = context.chart.ctx;
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(24, 119, 242, 0.2)');
        gradient.addColorStop(1, 'rgba(24, 119, 242, 0)');
        return gradient;
      },
      fill: true,
      tension: 0.4,
      pointRadius: 6,
      pointBackgroundColor: '#fff',
      pointBorderWidth: 3
    }]
  };

  const donutData = {
    labels: ['ç±ƒçƒ', 'æºœå†°', 'æ¸¸æ³³'],
    datasets: [{
      data: [40, 20, 40],
      backgroundColor: ['#1877f2', '#ff9f43', '#10ac84'],
      hoverOffset: 15,
      borderWidth: 0
    }]
  };

  return (
    <div className="space-y-10 animate-in fade-in duration-500">
      <div className="flex gap-2 overflow-x-auto no-scrollbar bg-white p-2.5 rounded-[28px] shadow-sm border border-gray-100">
        {[
          { id: 'dashboard', label: 'ç‡Ÿé‹ç¸½è¦½', icon: <BarChart3 size={18}/> },
          { id: 'events', label: 'æ´»å‹•åº«ç®¡ç†', icon: <Calendar size={18}/> },
          { id: 'crm', label: 'æœƒå“¡æ¸…å–®', icon: <Users size={18}/> },
          { id: 'accounting', label: 'å¸³å‹™æ ¸å°', icon: <CreditCard size={18}/> }
        ].map(tab => (
          <button
            key={tab.id}
            onClick={() => setActiveTab(tab.id)}
            className={`px-8 py-4 rounded-2xl flex items-center gap-2 transition-all whitespace-nowrap font-medium ${activeTab === tab.id ? 'bg-[#1877f2] text-white shadow-lg shadow-[#1877f2]/20' : 'text-gray-500 hover:bg-gray-50'}`}
          >
            {tab.icon} {tab.label}
          </button>
        ))}
      </div>

      {activeTab === 'dashboard' && (
        <>
          <div className="grid grid-cols-2 lg:grid-cols-4 gap-6">
            <StatCard label="ç´¯ç©ç‡Ÿæ”¶" value={`$ ${stats.revenue.toLocaleString()}`} color="#1877f2" />
            <StatCard label="å ±åç¸½æ•¸" value={stats.regs} color="#1877f2" />
            <StatCard label="è¨»å†Šæœƒå“¡" value={stats.members} color="#1877f2" />
            <StatCard label="ä¸Šæ¶æ´»å‹•" value={stats.events} color="#1877f2" />
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div className="lg:col-span-8 bg-white p-8 rounded-[40px] shadow-sm border border-gray-50">
              <h3 className="text-lg font-medium mb-10 ml-2">æœˆåº¦ç‡Ÿæ”¶è¶¨å‹¢åœ–</h3>
              <div className="h-[350px]">
                <Line 
                  data={lineData} 
                  options={{ 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    plugins: { legend: { display: false } }, 
                    scales: { 
                      y: { border: { display: false }, grid: { color: '#f8fafc' } }, 
                      x: { grid: { display: false } } 
                    } 
                  }} 
                />
              </div>
            </div>
            <div className="lg:col-span-4 bg-white p-8 rounded-[40px] shadow-sm border border-gray-50">
              <h3 className="text-lg font-medium mb-10 text-center">å„é¡æ´»å‹•ç†±åº¦</h3>
              <div className="h-[350px]">
                <Doughnut 
                  data={donutData} 
                  options={{ 
                    responsive: true, 
                    maintainAspectRatio: false, 
                    cutout: '72%',
                    plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } } }
                  }} 
                />
              </div>
            </div>
          </div>
        </>
      )}

      {activeTab !== 'dashboard' && (
        <div className="bg-white p-20 rounded-[48px] shadow-sm text-center border border-gray-50">
          <div className="w-24 h-24 bg-[#f8fafc] rounded-full flex items-center justify-center mx-auto mb-8">
            <Settings className="text-gray-200 animate-spin-slow" size={40} />
          </div>
          <h3 className="text-2xl font-medium mb-3 text-gray-800">é€²éšç®¡ç†æ¨¡çµ„å„ªåŒ–ä¸­</h3>
          <p className="text-gray-400 max-w-sm mx-auto leading-relaxed">
            ç‚ºäº†æä¾›æ›´ç²¾ç¢ºçš„è²¡å‹™èˆ‡å­¸å“¡ç®¡ç†ï¼Œç³»çµ±æ­£é€²è¡Œå¾Œå°å‡ç´šã€‚ç›®å‰æ‚¨å¯ä»¥é€é Google è©¦ç®—è¡¨ç›´æ¥é€²è¡Œè³‡æ–™ç·¨è¼¯ã€‚
          </p>
          <button className="mt-10 text-[#1877f2] font-medium border-b border-[#1877f2]/30 hover:border-[#1877f2] transition-all">
            æŸ¥çœ‹æ“ä½œæŒ‡å¼•
          </button>
        </div>
      )}
    </div>
  );
};

const StatCard = ({ label, value, color }) => (
  <div className="bg-white p-8 rounded-[32px] shadow-sm hover:shadow-md transition-shadow border border-transparent hover:border-gray-100">
    <p className="text-xs text-gray-400 mb-2 uppercase tracking-[0.1em] font-semibold">{label}</p>
    <p className="text-3xl font-medium tracking-tight" style={{ color: color }}>{value}</p>
  </div>
);

export default App;
