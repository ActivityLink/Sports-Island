// ä¿®æ”¹ saveEventToSheet å‡½å¼ï¼Œç¢ºä¿æ­£ç¢ºçš„æ¬„ä½é †åº
async function saveEventToSheet() {
    if (state.isProcessing) return; 
    state.isProcessing = true;
    
    const btn = document.getElementById('btn-save-event');
    const originalText = btn.innerText;
    btn.innerText = 'åŒæ­¥ä¸­...';
    btn.disabled = true;
    
    try {
        // æ”¶é›†æ¢¯æ¬¡è³‡æ–™
        const sessions = [];
        document.querySelectorAll('.session-row').forEach(row => {
            const inputs = row.querySelectorAll('input');
            if (inputs[0].value) {
                sessions.push({ s: inputs[0].value, e: inputs[1].value });
            }
        });
        
        // ç¢ºä¿æ¬„ä½å®Œå…¨å°æ‡‰ Google Sheets çš„ 19 æ¬„é †åº
        const payload = { 
            "æ´»å‹•ID": state.currentEditId || ("EVT-" + Date.now() + Math.random().toString(36).substr(2, 5)),
            "æ´»å‹•å‹æ…‹": document.getElementById('edit-type').value,
            "åˆ†é¡": document.getElementById('edit-category').value,
            "æ´»å‹•åç¨±": document.getElementById('edit-name').value.trim(),
            "æ¢¯æ¬¡è³‡æ–™": sessions.length > 0 ? JSON.stringify(sessions) : "[]",
            "é–‹å§‹æ—¥æœŸ": document.getElementById('edit-start').value,
            "çµæŸæ—¥æœŸ": document.getElementById('edit-end').value,
            "å…¨æ—¥åƒ¹": parseFloat(document.getElementById('edit-price').value) || 0,
            "å…¨æ—¥æ‰£é™¤": parseFloat(document.getElementById('edit-full-deduct').value) || 0,
            "åŠæ—¥æ‰£é™¤": parseFloat(document.getElementById('edit-half-deduct').value) || 0,
            "ç¸½åé¡": parseInt(document.getElementById('edit-quota').value) || 0,
            "æè¿°": document.getElementById('edit-desc').value.trim(),
            "å…§å®¹åª’é«”": document.getElementById('edit-media').value.trim(),
            "åœ–ç‰‡URL": document.getElementById('edit-img').value.trim(),
            "ç‹€æ…‹": document.getElementById('edit-status').value,
            "åŠæ—¥åƒ¹": parseFloat(document.getElementById('edit-half-price').value) || 0,
            "å…¨æ—¥æ—©é³¥åƒ¹": parseFloat(document.getElementById('edit-early-price').value) || 0,
            "æ—©é³¥æˆªæ­¢æ—¥æœŸ": document.getElementById('edit-early-deadline').value || "",
            "åŠæ—¥æ—©é³¥åƒ¹": parseFloat(document.getElementById('edit-half-early-price').value) || 0
        };
        
        console.log('Sending payload:', payload);
        
        const response = await fetch(PROXY_URL, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                action: 'updateEvent', 
                payload: payload 
            })
        });
        
        const result = await response.json();
        console.log('Response:', result);
        
        if (result.status === 'success') {
            showMsg("âœ… è³‡æ–™å·²æˆåŠŸåŒæ­¥è‡³é›²ç«¯è³‡æ–™åº«ï¼");
            // é‡æ–°è¼‰å…¥è³‡æ–™
            await fetchData();
            // è¿”å›åˆ—è¡¨
            showAdminSubPage('list');
        } else {
            showMsg(`âŒ å„²å­˜å¤±æ•—: ${result.message || 'æœªçŸ¥éŒ¯èª¤'}`);
        }
        
    } catch (error) {
        console.error('Save error:', error);
        showMsg(`âŒ ç¶²è·¯éŒ¯èª¤: ${error.message}`);
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
        state.isProcessing = false;
    }
}

// ä¿®æ”¹ saveParamsToSheet å‡½å¼
async function saveParamsToSheet() {
    const btn = document.querySelector('#admin-page-params .btn-primary');
    if (!btn) return;
    
    const originalText = btn.innerText;
    btn.innerText = 'åŒæ­¥ä¸­...';
    btn.disabled = true;
    
    try {
        const response = await fetch(PROXY_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'updateConfig', 
                payload: { 
                    bankInfo: document.getElementById('param-bank-info').value.trim(),
                    sportCategories: document.getElementById('param-sport-cats').value.trim()
                } 
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showMsg("âœ… ç³»çµ±è¨­å®šå·²åŒæ­¥æˆåŠŸï¼");
            // æ›´æ–°æœ¬åœ°é…ç½®
            if (result.config) {
                state.config = result.config;
            }
            fetchData();
        } else {
            showMsg(`âŒ è¨­å®šåŒæ­¥å¤±æ•—: ${result.message}`);
        }
    } catch (error) {
        console.error('Save params error:', error);
        showMsg('âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹ç¨å¾Œé‡è©¦');
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
}

// ä¿®æ”¹ saveStudentToSheet å‡½å¼
async function saveStudentToSheet() {
    const uid = document.getElementById('stu-id').value.trim();
    if (!uid) {
        showMsg("âŒ è«‹å¡«å¯«èº«åˆ†è­‰å­—è™Ÿ");
        return;
    }
    
    const btn = document.querySelector('#member-profile-view .btn-primary');
    const originalText = btn.innerText;
    btn.innerText = 'å„²å­˜ä¸­...';
    btn.disabled = true;
    
    try {
        state.userUid = uid;
        localStorage.setItem('MI_USER_UID', uid);
        
        const student = {
            id: "STU-" + Date.now() + Math.random().toString(36).substr(2, 5),
            parentUid: "WEB_USER",
            name: document.getElementById('stu-name').value.trim(),
            gender: "ç”·", // å¯ä»¥æ ¹æ“šéœ€è¦å¢åŠ æ€§åˆ¥é¸æ“‡
            birthday: document.getElementById('stu-birthday').value,
            idNumber: uid,
            identity: document.getElementById('stu-identity').value,
            height: parseFloat(document.getElementById('stu-height').value) || 0,
            weight: parseFloat(document.getElementById('stu-weight').value) || 0,
            footSize: parseFloat(document.getElementById('stu-foot').value) || 0,
            school: document.getElementById('stu-school').value.trim(),
            grade: document.getElementById('stu-grade').value.trim(),
            health: document.getElementById('stu-health').value.trim(),
            updated: new Date().toISOString()
        };
        
        const response = await fetch(PROXY_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                action: 'submitRegistration', 
                payload: { student: student } 
            })
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showMsg("âœ… å€‹äººæª”æ¡ˆå·²æˆåŠŸå„²å­˜ï¼");
            state.profile = student;
        } else {
            showMsg(`âŒ å„²å­˜å¤±æ•—: ${result.message}`);
        }
    } catch (error) {
        console.error('Save student error:', error);
        showMsg('âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·š');
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
}

// ä¿®æ”¹ finalSubmitBooking å‡½å¼
async function finalSubmitBooking(eid) {
    if (state.isProcessing) return;
    if (!selectedReg.type || selectedReg.price <= 0) {
        showMsg("âŒ è«‹é¸æ“‡å ±åé¡å‹");
        return;
    }
    
    state.isProcessing = true;
    const btn = document.querySelector('#payment-box .btn-primary');
    const originalText = btn.innerText;
    btn.innerText = 'æäº¤ä¸­...';
    btn.disabled = true;
    
    try {
        const sessionDate = document.getElementById('reg-session-date')?.value || "";
        const event = state.events.find(e => String(e['æ´»å‹•ID']) === String(eid));
        
        const payload = {
            action: 'submitRegistration',
            payload: {
                studentId: state.userUid,
                eventId: eid,
                eventName: event ? event['æ´»å‹•åç¨±'] : '',
                type: selectedReg.type,
                session: sessionDate,
                amount: selectedReg.price,
                status: 'å¾…ä»˜æ¬¾',
                timestamp: new Date().toLocaleString('zh-TW'),
                fullTimestamp: new Date().toISOString()
            }
        };
        
        const response = await fetch(PROXY_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();
        
        if (result.status === 'success') {
            showMsg("ğŸ‰ å ±åæˆåŠŸï¼è«‹æŸ¥çœ‹æœƒå“¡å°ˆå€çš„å ±åç´€éŒ„");
            setTimeout(() => {
                switchMainTab('member');
                switchMemberSubView('history');
            }, 1500);
        } else {
            showMsg(`âŒ å ±åå¤±æ•—: ${result.message || 'è«‹ç¨å¾Œé‡è©¦'}`);
        }
    } catch (error) {
        console.error('Booking error:', error);
        showMsg('âŒ ç¶²è·¯éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥é€£ç·šå¾Œé‡è©¦');
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
        state.isProcessing = false;
    }
}

// æ–°å¢ï¼šæª¢æŸ¥ Proxy é€£ç·šç‹€æ…‹
async function checkProxyConnection() {
    try {
        const response = await fetch(PROXY_URL + "?action=ping&_t=" + Date.now());
        const result = await response.json();
        console.log('Proxy connection:', result);
        return result.status === 'success';
    } catch (error) {
        console.error('Proxy connection failed:', error);
        return false;
    }
}

// åœ¨ fetchData é–‹é ­åŠ å…¥é€£ç·šæª¢æŸ¥
async function fetchData() {
    // å…ˆæª¢æŸ¥é€£ç·š
    const isConnected = await checkProxyConnection();
    if (!isConnected) {
        showMsg("âš ï¸ ç„¡æ³•é€£ç·šåˆ°ä¼ºæœå™¨ï¼Œè«‹æª¢æŸ¥ç¶²è·¯");
        document.getElementById('loading-text').innerText = 'Connection Error';
        return;
    }
    
    try {
        const res = await fetch(PROXY_URL + "?action=getEvents&_t=" + Date.now());
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const result = await res.json();
        if (result.status === 'success') {
            state.events = result.data || [];
            state.config = result.config || { 
                sportCategories: "ç±ƒçƒ,è¶³çƒ,æºœå†°,ç¾½çƒ,é«”æ“,ç¶²çƒ,è›‡æ¿", 
                bankInfo: "è«‹åœ¨ç®¡ç†ä¸­å¿ƒè¨­å®šåŒ¯æ¬¾å¸³è™Ÿ" 
            };
            
            // æ›´æ–°è¨­å®šæ¬„ä½
            const bankEl = document.getElementById('param-bank-info');
            const catEl = document.getElementById('param-sport-cats');
            if (bankEl) bankEl.value = state.config.bankInfo || "";
            if (catEl) {
                catEl.value = state.config.sportCategories || "";
                renderAdminCategorySelect();
            }
            
            renderClientCatFilter();
            renderActivityList();
            
            // å¦‚æœç•¶å‰åœ¨ç®¡ç†é é¢ï¼Œé‡æ–°æ¸²æŸ“åˆ—è¡¨
            const viewAdmin = document.getElementById('view-admin');
            if (viewAdmin && viewAdmin.classList.contains('active')) {
                renderAdminList();
            }
        } else {
            showMsg("âŒ è¼‰å…¥è³‡æ–™å¤±æ•—");
        }
    } catch (e) { 
        console.error("Fetch Error:", e);
        showMsg("âŒ è¼‰å…¥è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤");
    } finally { 
        const l = document.getElementById('loading');
        if (l) l.classList.add('hidden'); 
    }
}

// ä¿®æ”¹ loadProfileFromCloud å‡½å¼
async function loadProfileFromCloud() {
    if (!state.userUid) {
        showMsg("âš ï¸ è«‹å…ˆå¡«å¯«å€‹è³‡æª”æ¡ˆ");
        return;
    }
    
    try {
        const res = await fetch(PROXY_URL + "?action=getProfile&uid=" + encodeURIComponent(state.userUid));
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        
        const r = await res.json();
        if (r.status === 'success' && r.data) {
            state.profile = r.data;
            const d = r.data;
            
            // å®‰å…¨åœ°æ›´æ–°è¡¨å–®æ¬„ä½
            const fields = {
                'stu-name': d.å§“å,
                'stu-identity': d.èº«åˆ† || 'å­¸å“¡',
                'stu-id': d.èº«åˆ†è­‰å­—è™Ÿ || state.userUid,
                'stu-birthday': d.ç”Ÿæ—¥,
                'stu-height': d.èº«é«˜,
                'stu-weight': d.é«”é‡,
                'stu-foot': d.è…³é•·,
                'stu-school': d.å­¸æ ¡,
                'stu-grade': d.å¹´ç´š,
                'stu-health': d.å¥åº·ç‹€æ³ || d.health || ''
            };
            
            Object.entries(fields).forEach(([id, value]) => {
                const el = document.getElementById(id);
                if (el) el.value = value || '';
            });
            
            toggleIdentity();
        } else if (r.status === 'not_found') {
            // ä½¿ç”¨è€…ä¸å­˜åœ¨ï¼Œæ¸…é™¤æœ¬åœ°è³‡æ–™
            state.profile = null;
            showMsg("â„¹ï¸ æœªæ‰¾åˆ°æœƒå“¡è³‡æ–™ï¼Œè«‹å»ºç«‹æ–°æª”æ¡ˆ");
        }
    } catch (error) {
        console.error('Load profile error:', error);
        showMsg("âŒ è¼‰å…¥æœƒå“¡è³‡æ–™å¤±æ•—");
    }
}

// åœ¨ HTML çš„ <script> é–‹é ­æ·»åŠ éŒ¯èª¤è™•ç†
window.addEventListener('error', function(event) {
    console.error('Global error:', event.error);
    showMsg(`âš ï¸ ç³»çµ±éŒ¯èª¤: ${event.message}`);
});

// ç¢ºä¿æ‰€æœ‰æŒ‰éˆ•éƒ½æœ‰æ­£ç¢ºçš„äº‹ä»¶ç¶å®š
document.addEventListener('DOMContentLoaded', function() {
    console.log('SPORTS ISLAND System Initialized');
});
