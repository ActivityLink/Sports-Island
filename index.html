/**
 * 運動島 SPORTS ISLAND - 後端核心
 * 檔案位置：Google Apps Script 編輯器 (通常名為 Code.gs)
 * 欄位規則：Events (19 欄位) / Students (16 欄位)
 */

const SS_ID = "1Q2pyb7ljtWg3n_R8KSeyHrFLt6Ra4nXUmqhTZhUWZJg";
const SS = SpreadsheetApp.openById(SS_ID);

/**
 * 處理 GET 請求：讀取資料
 */
function doGet(e) {
  const action = e.parameter.action;
  const uid = e.parameter.uid;
  
  try {
    if (action === 'getEvents') {
      return createJsonResponse({
        status: 'success',
        data: getSheetData("Events"),
        config: getSystemConfig()
      });
    }
    if (action === 'getProfile') {
      return createJsonResponse({ status: 'success', data: getProfileByUid(uid) });
    }
    if (action === 'getHistory') {
      return createJsonResponse({ status: 'success', data: getHistoryByUid(uid) });
    }
    return createJsonResponse({ status: 'online', message: 'Ready' });
  } catch (err) {
    return createJsonResponse({ status: 'error', message: err.toString() });
  }
}

/**
 * 處理 POST 請求：寫入資料
 */
function doPost(e) {
  let postData;
  try { postData = JSON.parse(e.postData.contents); } 
  catch (err) { return createJsonResponse({ status: 'error', message: 'JSON 解析失敗' }); }

  const action = postData.action;
  const payload = postData.payload;

  try {
    if (action === 'updateEvent') return createJsonResponse(updateEventLogic(payload));
    if (action === 'submitRegistration') return createJsonResponse(submitRegistrationLogic(payload));
    if (action === 'updateConfig') return createJsonResponse(updateConfigLogic(payload));
    return createJsonResponse({ status: 'error', message: '未知操作' });
  } catch (err) {
    return createJsonResponse({ status: 'error', message: err.toString() });
  }
}

/**
 * 更新活動 - 嚴格物理對齊 A-S 欄 (19 欄)
 */
function updateEventLogic(ev) {
  const sheet = SS.getSheetByName("Events");
  const targetId = String(ev.活動ID);
  const data = sheet.getDataRange().getValues();
  let rowIndex = -1;

  for (let i = 1; i < data.length; i++) {
    if (String(data[i][0]) === targetId) { rowIndex = i + 1; break; }
  }

  // 100% 根據您提供的物理順序對齊
  const rowData = [
    targetId,            // A: 活動ID
    ev.活動型態,         // B: 活動型態
    ev.分類,             // C: 分類
    ev.活動名稱,         // D: 活動名稱
    ev.梯次資料 || "[]", // E: 梯次資料
    ev.開始日期,         // F: 開始日期
    ev.結束日期,         // G: 結束日期
    ev.全日價,           // H: 全日價 (例如: 7500)
    ev.全日扣除 || 0,    // I: 全日扣除
    ev.半日扣除 || 0,    // J: 半日扣除
    ev.總名額,           // K: 總名額
    ev.描述,             // L: 描述
    ev.內容媒體 || "",   // M: 內容媒體
    ev.圖片URL,          // N: 圖片URL
    ev.狀態,             // O: 狀態
    ev.半日價 || 0,      // P: 半日價
    ev.全日早鳥價 || 0,  // Q: 全日早鳥價 (例如: 4980) -> 對應試算表標題必須是「全日早鳥價」
    ev.早鳥截止日期,     // R: 早鳥截止日期
    ev.半日早鳥價 || 0   // S: 半日早鳥價
  ];

  if (rowIndex > 0) {
    sheet.getRange(rowIndex, 1, 1, rowData.length).setValues([rowData]);
  } else {
    sheet.appendRow(rowData);
  }
  
  SpreadsheetApp.flush(); // 強制同步
  return { status: 'success' };
}

/**
 * 提交報名與同步學員個資 - 16 欄位
 */
function submitRegistrationLogic(payload) {
  const stu = payload.student;
  const idNum = String(stu.idNumber);
  const stuSheet = SS.getSheetByName("Students");
  const stuData = stuSheet.getDataRange().getValues();
  let stuRowIndex = -1;

  for (let i = 1; i < stuData.length; i++) {
    if (String(stuData[i][5]) === idNum) { stuRowIndex = i + 1; break; }
  }

  const stuRow = [
    stu.id, stu.parentUid, stu.name, stu.gender, stu.birthday, 
    idNum, stu.identity, stu.height, stu.weight, stu.footSize, 
    stu.school, stu.grade, stu.health, "N/A", "N/A", new Date()
  ];

  if (stuRowIndex > 0) stuSheet.getRange(stuRowIndex, 1, 1, stuRow.length).setValues([stuRow]);
  else stuSheet.appendRow(stuRow);

  if (payload.eventId && payload.eventId !== "SYNC") {
    const regSheet = SS.getSheetByName("Registrations") || SS.insertSheet("Registrations");
    regSheet.appendRow([
      "REG-"+Date.now(), idNum, stu.name, payload.eventId, payload.eventName || "課程",
      payload.type, payload.session, payload.amount, new Date(), "未核帳"
    ]);
  }

  SpreadsheetApp.flush();
  return { status: 'success' };
}

// 輔助函式
function getSheetData(name) {
  const sheet = SS.getSheetByName(name);
  if (!sheet) return [];
  const values = sheet.getDataRange().getValues();
  if (values.length <= 1) return [];
  const headers = values[0];
  return values.slice(1).map(row => {
    let obj = {};
    headers.forEach((h, i) => {
      let val = row[i];
      if (val instanceof Date) val = Utilities.formatDate(val, "GMT+8", "yyyy-MM-dd");
      obj[h] = val;
    });
    return obj;
  });
}

function getProfileByUid(uid) { return getSheetData("Students").find(s => String(s.身分證字號) === String(uid)) || null; }
function getHistoryByUid(uid) {
  const sheet = SS.getSheetByName("Registrations"); if (!sheet) return [];
  const values = sheet.getDataRange().getValues();
  return values.slice(1).filter(row => String(row[1]) === String(uid)).map(row => ({
    eventName: row[4], 應付金額: row[7], 報名時間: Utilities.formatDate(new Date(row[8]), "GMT+8", "yyyy-MM-dd HH:mm")
  }));
}
function getSystemConfig() {
  const sheet = SS.getSheetByName("SystemConfig"); const config = { bankInfo: "", sportCategories: "" };
  if (!sheet) return config;
  sheet.getDataRange().getValues().slice(1).forEach(r => { 
    if(String(r[0]).trim()==="bankInfo") config.bankInfo=r[1]; 
    if(String(r[0]).trim()==="sportCategories") config.sportCategories=r[1]; 
  });
  return config;
}
function updateConfigLogic(p) {
  const sheet = SS.getSheetByName("SystemConfig") || SS.insertSheet("SystemConfig");
  const up = (k, v) => {
    let d = sheet.getDataRange().getValues(); let f = false;
    for (let i = 1; i < d.length; i++) { if (String(d[i][0]).trim() === k) { sheet.getRange(i+1, 2).setValue(v); f = true; break; } }
    if (!f) sheet.appendRow([k, v, new Date()]);
  };
  up("bankInfo", p.bankInfo); up("sportCategories", p.sportCategories);
  SpreadsheetApp.flush();
  return { status: 'success' };
}
function createJsonResponse(data) { return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); }
