<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" href="data:,">
    <title>é‹å‹•å³¶ MOVEMENT ISLAND - å°ˆæ¥­é ç´„ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; color: #0f172a; -webkit-tap-highlight-color: transparent; font-size: 14px; }
        
        .btn-mega { width: 100%; font-weight: 900; display: flex; align-items: center; justify-content: center; transition: all 0.2s; font-size: 14px; padding: 12px 8px; border-radius: 12px; border: none; cursor: pointer; }
        .btn-primary { background-color: #1a73e8; color: white; box-shadow: 0 4px 6px -1px rgba(26, 115, 232, 0.2); }
        .btn-secondary { background-color: white; color: #1a73e8; border: 2.5px solid #1a73e8; }
        
        .input-giant { width: 100%; border: none !important; border-bottom: 2px solid #e2e8f0 !important; outline: none !important; padding: 10px 0 !important; font-weight: 700; background-color: transparent !important; font-size: 16px; border-radius: 0 !important; }
        .input-giant:focus { border-color: #1a73e8 !important; }
        
        .main-tab { flex: 1; text-align: center; padding: 14px 0; font-weight: 900; font-size: 15px; color: rgba(255,255,255,0.6); border-bottom: 4px solid transparent; cursor: pointer; }
        .main-tab.active { color: white !important; border-bottom-color: white !important; }
        
        .info-card { background: white; border-radius: 20px; border: 1px solid #e2e8f0; margin-bottom: 16px; padding: 20px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; }
        .info-card:active { transform: scale(0.98); }
        .tag-label { color: #64748b; font-weight: 900; margin-bottom: 4px; display: block; font-size: 11px; text-transform: uppercase; }
        
        .section-view { display: none; }
        .section-view.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #msg-box { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; width: 85%; max-width: 320px; display: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æœƒå“¡å°ˆå€ç‰¹æ®Šæ¨£å¼ */
        .member-menu-card { display: flex; align-items: center; gap: 16px; padding: 24px; border-radius: 24px; background: white; border: 1px solid #e2e8f0; margin-bottom: 16px; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
        .icon-box { width: 48px; height: 48px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
        
        .history-item { border-left: 4px solid #1a73e8; padding: 12px; background: #f8fafc; border-radius: 0 12px 12px 0; margin-bottom: 12px; }
    </style>
</head>
<body class="bg-slate-50">

    <div id="msg-box" class="bg-slate-900 text-white p-4 rounded-2xl shadow-2xl text-center font-bold text-sm"></div>

    <header class="bg-[#1a73e8] text-white pt-8 pb-2 px-4 text-center sticky top-0 z-50 shadow-lg">
        <h1 class="text-2xl font-black italic tracking-tighter uppercase leading-none">MOVEMENT ISLAND</h1>
        <div class="flex mt-6">
            <div onclick="switchMainTab('activity')" id="tab-activity" class="main-tab active">æ´»å‹•å°ˆå€</div>
            <div onclick="switchMainTab('member')" id="tab-member" class="main-tab">æœƒå“¡å°ˆå€</div>
            <div onclick="switchMainTab('admin')" id="tab-admin" class="main-tab hidden">ç®¡ç†ä¸­å¿ƒ</div>
        </div>
    </header>

    <main id="app" class="mobile-container p-4 mx-auto max-w-[480px]">
        <div id="loading" class="py-40 text-center">
            <div class="inline-block w-12 h-12 border-4 border-[#1a73e8] border-t-transparent rounded-full animate-spin"></div>
            <p id="loading-text" class="mt-6 font-black text-slate-400 text-xs tracking-widest uppercase">Syncing Cloud Data...</p>
        </div>

        <!-- è¦–åœ–ï¼šæ´»å‹•å°ˆå€ -->
        <div id="view-activity" class="section-view">
            <div id="client-cat-filter" class="flex overflow-x-auto pb-4 no-scrollbar"></div>
            <div id="event-list" class="space-y-6"></div>
        </div>

        <!-- è¦–åœ–ï¼šæœƒå“¡å°ˆå€ (é‡æ§‹é¸å–®çµæ§‹) -->
        <div id="view-member" class="section-view">
            
            <!-- é¸å–®å…¥å£ -->
            <div id="member-home">
                <div class="mb-8">
                    <h2 class="text-2xl font-black text-slate-800">æ‚¨å¥½, å®¶é•·</h2>
                    <p class="text-slate-400 font-bold text-xs uppercase tracking-widest">Member Service Center</p>
                </div>

                <div onclick="showMemberSub('profile')" class="member-menu-card">
                    <div class="icon-box bg-blue-100 text-blue-600">ğŸ“</div>
                    <div>
                        <h3 class="font-black text-lg text-slate-800">æœƒå“¡æª”æ¡ˆå¤¾</h3>
                        <p class="text-xs text-slate-400 font-medium">æŸ¥çœ‹èˆ‡ç·¨è¼¯å­¸å“¡å€‹è³‡ã€å¥åº·ç‹€æ³</p>
                    </div>
                </div>

                <div onclick="showMemberSub('history')" class="member-menu-card">
                    <div class="icon-box bg-orange-100 text-orange-600">ğŸ“œ</div>
                    <div>
                        <h3 class="font-black text-lg text-slate-800">èª²ç¨‹æ­·å²å€</h3>
                        <p class="text-xs text-slate-400 font-medium">è¨˜è¼‰éå¾€æ‰€æœ‰æ´»å‹•å ±åèˆ‡è³¼è²·ç´€éŒ„</p>
                    </div>
                </div>
            </div>

            <!-- å­é é¢ï¼šæœƒå“¡æª”æ¡ˆç·¨è¼¯ -->
            <div id="member-profile" class="hidden">
                <div class="flex items-center gap-2 mb-6" onclick="showMemberSub('home')">
                    <span class="text-xl">â¬…ï¸</span>
                    <span class="font-black text-slate-400 uppercase text-xs tracking-widest cursor-pointer">è¿”å›é¸å–®</span>
                </div>
                <div class="info-card !cursor-default border-t-8 border-[#1a73e8]">
                    <h2 class="text-xl font-black mb-8 text-[#1a73e8] italic border-b pb-2">Student Profile</h2>
                    <div class="space-y-6">
                        <div><label class="tag-label">å§“å</label><input type="text" id="stu-name" class="input-giant"></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="tag-label">æ€§åˆ¥</label><select id="stu-gender" class="input-giant font-bold"><option value="ç”·">ç”·</option><option value="å¥³">å¥³</option></select></div>
                            <div><label class="tag-label">ç”Ÿæ—¥</label><input type="date" id="stu-birthday" class="input-giant" onchange="autoDetectGrade()"></div>
                        </div>
                        <div><label class="tag-label">èº«åˆ†è­‰å­—è™Ÿ (ä¸å¯ä¿®æ”¹)</label><input type="text" id="stu-id" class="input-giant uppercase bg-slate-50" placeholder="è«‹å…ˆè¼¸å…¥æ­£ç¢ºèº«åˆ†è­‰"></div>
                        <div class="grid grid-cols-3 gap-4">
                            <div><label class="tag-label">èº«é«˜ cm</label><input type="number" id="stu-height" class="input-giant"></div>
                            <div><label class="tag-label">é«”é‡ kg</label><input type="number" id="stu-weight" class="input-giant"></div>
                            <div><label class="tag-label">è…³é•· cm</label><input type="number" id="stu-foot" class="input-giant"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="tag-label">å­¸æ ¡</label><input type="text" id="stu-school" class="input-giant"></div>
                            <div><label class="tag-label">å¹´ç´š</label><input type="text" id="stu-grade" class="input-giant bg-slate-50" readonly></div>
                        </div>
                        <button onclick="saveStudentToSheet()" id="btn-save-stu" class="btn-mega btn-primary mt-6 shadow-xl uppercase">Save Changes âœ</button>
                    </div>
                </div>
            </div>

            <!-- å­é é¢ï¼šèª²ç¨‹æ­·å²ç´€éŒ„ -->
            <div id="member-history" class="hidden">
                <div class="flex items-center gap-2 mb-6" onclick="showMemberSub('home')">
                    <span class="text-xl">â¬…ï¸</span>
                    <span class="font-black text-slate-400 uppercase text-xs tracking-widest cursor-pointer">è¿”å›é¸å–®</span>
                </div>
                <div id="history-list" class="space-y-4">
                    <!-- å‹•æ…‹è¼‰å…¥æ­·å² -->
                </div>
            </div>
        </div>

        <!-- ç®¡ç†å¾Œå° -->
        <div id="view-admin" class="section-view">
            <!-- ä¿æŒåŸæœ‰çš„å¾Œå°ç®¡ç†é‚è¼¯ -->
            <div class="flex justify-around bg-white rounded-2xl mb-8 shadow-sm border overflow-hidden text-xs font-black">
                <div onclick="showAdminSubPage('list')" id="sub-tab-list" class="flex-1 text-center py-4 cursor-pointer border-r active">æ´»å‹•åº«</div>
                <div onclick="showAdminSubPage('params')" id="sub-tab-params" class="flex-1 text-center py-4 cursor-pointer">å…¨ç«™è¨­å®š</div>
            </div>
            <div id="admin-page-list">
                <div id="admin-event-grid" class="space-y-4"></div>
            </div>
            <div id="admin-page-params" class="hidden">
                <div class="info-card">
                    <label class="tag-label">åŒ¯æ¬¾å¸³è™Ÿ</label>
                    <textarea id="param-bank-info" rows="4" class="input-giant !h-auto text-sm font-bold"></textarea>
                    <button onclick="saveParamsToSheet()" class="btn-mega btn-primary mt-4">åŒæ­¥è¨­å®š</button>
                </div>
            </div>
        </div>
    </main>

    <script>
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        let state = { events: [], config: {}, currentEditId: null, userUid: "" };

        window.onload = function() {
            // å˜—è©¦å¾æœ¬åœ°å–å¾—ä¸Šæ¬¡è¼¸å…¥éçš„ ID
            state.userUid = localStorage.getItem('MI_USER_UID') || "";
            fetchData();
        };

        async function fetchData() {
            try {
                const res = await fetch(PROXY_URL + "?action=getEvents");
                const result = await res.json();
                if (result.status === 'success') {
                    state.events = result.data || [];
                    state.config = result.config || {};
                    document.getElementById('loading').classList.add('hidden');
                    renderActivityList();
                }
            } catch (e) { console.error(e); }
        }

        // æœƒå“¡å°ˆå€å­é é¢åˆ‡æ›
        function showMemberSub(sub) {
            document.getElementById('member-home').classList.add('hidden');
            document.getElementById('member-profile').classList.add('hidden');
            document.getElementById('member-history').classList.add('hidden');
            
            if (sub === 'home') document.getElementById('member-home').classList.remove('hidden');
            if (sub === 'profile') {
                document.getElementById('member-profile').classList.remove('hidden');
                loadUserProfile();
            }
            if (sub === 'history') {
                document.getElementById('member-history').classList.remove('hidden');
                loadUserHistory();
            }
        }

        // è®€å–å€‹è³‡
        async function loadUserProfile() {
            if (!state.userUid) return;
            const res = await fetch(PROXY_URL + "?action=getProfile&uid=" + state.userUid);
            const result = await res.json();
            if (result.data) {
                const s = result.data;
                document.getElementById('stu-name').value = s.å§“å || "";
                document.getElementById('stu-gender').value = s.æ€§åˆ¥ || "ç”·";
                document.getElementById('stu-birthday').value = s.ç”Ÿæ—¥ || "";
                document.getElementById('stu-id').value = s.èº«åˆ†è­‰å­—è™Ÿ || "";
                document.getElementById('stu-height').value = s.èº«é«˜ || "";
                document.getElementById('stu-weight').value = s.é«”é‡ || "";
                document.getElementById('stu-foot').value = s.è…³é•· || "";
                document.getElementById('stu-school').value = s.å­¸æ ¡ || "";
                autoDetectGrade();
            }
        }

        // è®€å–æ­·å²
        async function loadUserHistory() {
            const container = document.getElementById('history-list');
            container.innerHTML = '<p class="text-center py-10 font-bold text-slate-300">æ­£åœ¨è®€å–æ­·å²ç´€éŒ„...</p>';
            
            if (!state.userUid) {
                container.innerHTML = '<p class="text-center py-10 font-bold text-slate-300 italic">è«‹å…ˆå¡«å¯«æª”æ¡ˆå¤¾å…§çš„å€‹è³‡</p>';
                return;
            }

            const res = await fetch(PROXY_URL + "?action=getHistory&uid=" + state.userUid);
            const result = await res.json();
            
            if (result.data && result.data.length > 0) {
                container.innerHTML = result.data.map(h => `
                    <div class="history-item">
                        <div class="flex justify-between items-start">
                            <h4 class="font-black text-slate-800">${h.eventName}</h4>
                            <span class="text-[10px] bg-slate-200 px-2 py-0.5 rounded font-black uppercase">${h.å°å¸³ç‹€æ…‹}</span>
                        </div>
                        <p class="text-xs text-slate-400 mt-1 font-bold">${h.eventDate}</p>
                        <p class="text-sm font-black text-[#1a73e8] mt-2">æ‡‰ä»˜é‡‘é¡: NT$ ${parseInt(h.æ‡‰ä»˜é‡‘é¡||0).toLocaleString()}</p>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-center py-10 font-bold text-slate-300 italic uppercase">No purchase history</p>';
            }
        }

        async function saveStudentToSheet() {
            const uid = document.getElementById('stu-id').value;
            if(!uid) { alert("è«‹å¡«å¯«èº«åˆ†è­‰å­—è™Ÿä»¥ä½œç‚ºç´€éŒ„éµå€¼"); return; }
            state.userUid = uid;
            localStorage.setItem('MI_USER_UID', uid);

            const student = {
                id: "STU-" + Date.now(), parentUid: "WEB_USER",
                name: document.getElementById('stu-name').value,
                gender: document.getElementById('stu-gender').value,
                birthday: document.getElementById('stu-birthday').value,
                idNumber: uid,
                height: document.getElementById('stu-height').value,
                weight: document.getElementById('stu-weight').value,
                footSize: document.getElementById('stu-foot').value,
                school: document.getElementById('stu-school').value,
                grade: document.getElementById('stu-grade').value,
                updated: new Date().toLocaleString()
            };
            
            const res = await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify({ action: 'submitRegistration', payload: { student: student } }) });
            const result = await res.json();
            if(result.status === 'success') { showMsg("âœ… å€‹äººæª”æ¡ˆæ›´æ–°æˆåŠŸï¼"); }
        }

        // --- UI å·¥å…· ---
        function switchMainTab(m) {
            document.querySelectorAll('.main-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-'+m).classList.add('active');
            document.querySelectorAll('.section-view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-'+m).classList.add('active');
            // å›åˆ°æœƒå“¡å°ˆå€æ™‚é‡ç½®å­é é¢
            if(m === 'member') showMemberSub('home');
        }

        function renderActivityList() {
            const list = document.getElementById('event-list');
            list.innerHTML = state.events.map(ev => `
                <div class="info-card p-0 overflow-hidden shadow-lg border-0">
                    <img src="${ev['åœ–ç‰‡URL'] || 'https://placehold.co/600x300'}" class="w-full h-44 object-cover">
                    <div class="p-6 text-center">
                        <h3 class="text-xl font-black text-slate-800">${ev['æ´»å‹•åç¨±']}</h3>
                        <p class="text-slate-400 text-xs font-bold my-4">${ev['é–‹å§‹æ—¥æœŸ']} ~ ${ev['çµæŸæ—¥æœŸ']}</p>
                        <button class="btn-mega btn-primary shadow-lg">ç«‹å³é ç´„</button>
                    </div>
                </div>`).join('');
        }

        function autoDetectGrade() {
            const b = document.getElementById('stu-birthday').value; if(!b) return;
            const age = new Date().getFullYear() - new Date(b).getFullYear();
            document.getElementById('stu-grade').value = age > 6 ? `å°å­¸ (${age-6}å¹´ç´š)` : "å¹¼å…’åœ’";
        }

        function showMsg(t) { const b = document.getElementById('msg-box'); b.innerText = t; b.style.display='block'; setTimeout(()=>b.style.display='none', 4000); }
    </script>
</body>
</html>
