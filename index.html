<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é‹å‹•å³¶ç³»çµ±å…¥å£ - ç®¡ç†ç«¯</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #f4f7f9; 
            color: #333; 
            margin: 0;
            display: flex;
            min-height: 100vh;
        }

        /* --- å·¦å´å›ºå®šå°è¦½åˆ— --- */
        .sidebar {
            width: 260px;
            background-color: #1a2a44;
            color: white;
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            left: 0; top: 0; z-index: 1000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }
        .sidebar-logo {
            padding: 24px 20px;
            font-size: 1.1rem;
            font-weight: 900;
            color: #4a90e2;
            background: #152238;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .nav-group { padding: 10px 0; }
        .nav-label { padding: 10px 20px; font-size: 11px; color: #64748b; text-transform: uppercase; letter-spacing: 1px; font-weight: 700; }
        .nav-item {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            border-left: 4px solid transparent;
            transition: 0.2s;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-item.active {
            background: rgba(74, 144, 226, 0.15);
            color: white;
            border-left-color: #ffd700;
            font-weight: 700;
        }
        /* å­é¸å–®æ¨£å¼ */
        .sub-nav {
            background: #121d2e;
            display: none;
            padding: 5px 0;
        }
        .sub-nav.active { display: block; }
        .sub-item {
            padding: 10px 20px 10px 52px;
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .sub-item:hover { color: white; }
        .sub-item.active { color: #f1c40f; font-weight: 700; }

        /* --- å³å´å…§å®¹å€ --- */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
            min-width: 0;
        }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            .sidebar { width: 100%; height: auto; position: relative; }
            .sidebar-logo, .nav-label { display: none; }
            .main-content { margin-left: 0; padding: 15px; }
            .nav-item { flex: 1; justify-content: center; padding: 12px 5px; font-size: 12px; border-left: none; border-bottom: 3px solid transparent; }
            .nav-item.active { border-bottom-color: #ffd700; }
            .sub-nav { position: absolute; top: 100%; left: 0; width: 100%; z-index: 1100; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        }

        /* --- UI å…ƒä»¶ --- */
        .section-view { display: none; }
        .section-view.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .card { background: white; border: 1px solid #dcdfe6; border-radius: 4px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); margin-bottom: 20px; overflow: hidden; }
        .card-header { padding: 12px 20px; border-bottom: 1px solid #e5e7eb; background: #f9fafb; font-weight: 700; color: #374151; display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 20px; }

        /* è¡¨æ ¼æ¨£å¼ */
        .data-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .data-table th { text-align: left; padding: 12px 10px; background: #f9fafb; border-bottom: 2px solid #e5e7eb; color: #6b7280; font-weight: 700; white-space: nowrap; }
        .data-table td { padding: 12px 10px; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
        .data-table tr:hover { background-color: #fcfcfc; }

        /* è¡¨å–®æ¨£å¼ */
        .form-section { border: 1px solid #eee; padding: 15px; border-radius: 4px; margin-bottom: 20px; background: #fff; }
        .form-title { font-size: 14px; font-weight: 700; color: #1a73e8; margin-bottom: 15px; border-left: 4px solid #1a73e8; padding-left: 10px; }
        .field-label { display: block; font-size: 13px; font-weight: 700; color: #4b5563; margin-bottom: 5px; }
        .input-std { width: 100%; border: 1px solid #dcdfe6; border-radius: 4px; padding: 8px 12px; font-size: 14px; outline: none; }
        .input-std:focus { border-color: #1a73e8; }

        .btn { padding: 8px 16px; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer; border: none; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; }
        .btn-blue { background: #1a73e8; color: white; }
        .btn-blue:hover { background: #1557b0; }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: #374151; }

        .status-badge { padding: 2px 8px; border-radius: 99px; font-size: 11px; font-weight: 700; }
        .badge-green { background: #dcfce7; color: #166534; }
        .badge-gray { background: #f3f4f6; color: #4b5563; }
        
        /* æ¢¯æ¬¡é …ç›®æ¨£å¼ */
        .batch-item { display: grid; grid-template-columns: 2fr 2fr 2fr 40px; gap: 10px; background: #f8fafc; border: 1px solid #e5e7eb; padding: 8px; border-radius: 4px; margin-bottom: 8px; align-items: center; }
    </style>
</head>
<body>

    <!-- å·¦å´å°è¦½åˆ— -->
    <aside id="sidebar" class="sidebar">
        <div class="sidebar-logo">é‹å‹•å³¶ç³»çµ±ç®¡ç†</div>
        
        <div class="nav-group">
            <div class="nav-label">ç”¨æˆ¶é¸å–®</div>
            <div onclick="switchView('activity')" id="nav-activity" class="nav-item active">ğŸ—“ï¸ æ´»å‹•é ç´„</div>
            <div onclick="switchView('member')" id="nav-member" class="nav-item">ğŸ‘¤ æˆ‘çš„å°ˆå€</div>
        </div>

        <div id="admin-nav-group" class="nav-group border-t border-white/5 mt-4">
            <div class="nav-label">ç®¡ç†å¾Œå°</div>
            <div onclick="toggleAdminNav()" id="nav-admin" class="nav-item">âš™ï¸ ç³»çµ±æ ¸å¿ƒç®¡ç†</div>
            <div id="sub-menu-admin" class="sub-nav">
                <div onclick="switchAdminView('dashboard')" id="sub-dashboard" class="sub-item">æ•¸æ“šç¸½è¦½</div>
                <div onclick="switchAdminView('audit')" id="sub-audit" class="sub-item">å ±åå¯©æ ¸</div>
                <div onclick="switchAdminView('events')" id="sub-events" class="sub-item">èª²ç¨‹ç®¡ç†</div>
                <div onclick="switchAdminView('members')" id="sub-members" class="sub-item">æœƒå“¡åå†Š</div>
                <div onclick="switchAdminView('config')" id="sub-config" class="sub-item">åƒæ•¸è¨­å®š (åƒæ•¸å€)</div>
            </div>
        </div>

        <div class="mt-auto p-4 border-t border-white/10 text-center">
            <button onclick="liff.logout(); location.reload();" class="text-xs text-white/30 hover:text-white underline">ç™»å‡ºç³»çµ±</button>
        </div>
    </aside>

    <!-- å³å´å…§å®¹å€ -->
    <main class="main-content">
        
        <!-- è¼‰å…¥ä¸­ -->
        <div id="view-loading" class="text-center py-40 text-gray-400">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full mb-4"></div>
            <p>æ­£åœ¨åŒæ­¥å³¶å…§è³‡æ–™...</p>
        </div>

        <!-- [ä½¿ç”¨è€…] æ´»å‹•é ç´„åˆ—è¡¨ -->
        <div id="view-activity" class="section-view">
            <div class="mb-8 rounded overflow-hidden shadow-sm border"><img src="https://aiwe.cc/wp-content/uploads/2025/12/3486bc19dc6317e16bf4f1449ec52ae4.jpg" class="w-full h-44 object-cover" alt="Banner"></div>
            <div id="activity-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>

        <!-- [ä½¿ç”¨è€…] æˆ‘çš„æˆå“¡å°ˆå€ -->
        <div id="view-member" class="section-view">
            <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold">å®¶åº­æˆå“¡ç®¡ç†</h2><button onclick="safeNavigate('register.html?mode=add')" class="btn btn-blue text-xs">+ æ–°å¢æˆå“¡</button></div>
            <div id="family-grid" class="space-y-3"></div>
        </div>

        <!-- [ç®¡ç†ç«¯] æ•¸æ“šçœ‹æ¿ -->
        <div id="view-admin-dashboard" class="section-view">
            <h2 class="text-xl font-bold mb-6">ç³»çµ±ç‡Ÿé‹æ•¸æ“š</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="card border-l-4 border-l-blue-600 p-5"><p class="text-xs text-slate-400 font-bold">ç´¯è¨ˆé ç´„ç¸½æ¬¡æ•¸</p><div id="stat-total" class="text-3xl font-black mt-1">--</div></div>
                <div class="card border-l-4 border-l-green-600 p-5"><p class="text-xs text-slate-400 font-bold">ä»Šæ—¥æ–°å¢é ç´„</p><div id="stat-today" class="text-3xl font-black mt-1">--</div></div>
            </div>
        </div>

        <!-- [ç®¡ç†ç«¯] å ±åå¯©æ ¸æ¸…å–® (æ¢å¾©å‚³çµ±è¡¨æ ¼) -->
        <div id="view-admin-audit" class="section-view">
            <h2 class="text-xl font-bold mb-6">å ±åé ç´„å¯©æ ¸</h2>
            <div class="card">
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead><tr><th>å­¸å“¡</th><th>æ´»å‹•åç¨±</th><th>é‡‘é¡</th><th>å¾Œäº”ç¢¼</th><th>ç‹€æ…‹</th><th class="text-right">æ“ä½œ</th></tr></thead>
                        <tbody id="admin-audit-list-body">
                            <tr><td colspan="6" class="text-center py-10 text-slate-400 italic">æ­£åœ¨è¼‰å…¥å¾…å¯©æ ¸åå–®...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- [ç®¡ç†ç«¯] èª²ç¨‹æ´»å‹•ç®¡ç† (æ–°å¢èˆ‡ç·¨è¼¯) -->
        <div id="view-admin-events" class="section-view">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">èª²ç¨‹ç®¡ç†åˆ—è¡¨</h2>
                <button onclick="AdminEventManager.openEditor()" class="btn btn-blue text-xs">+ ç™¼ä½ˆå–®æ—¥æ´»å‹•</button>
            </div>
            <div class="card">
                <div class="overflow-x-auto">
                    <table class="data-table">
                        <thead><tr><th>åç¨±</th><th>æ—¥æœŸ/æ™‚é–“</th><th>åé¡</th><th>å­¸è²»</th><th>ç‹€æ…‹</th><th class="text-right">æ“ä½œ</th></tr></thead>
                        <tbody id="admin-event-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- [ç®¡ç†ç«¯] èª²ç¨‹ç·¨è¼¯å™¨ (å–®æ—¥å°ˆå±¬ï¼Œç„¡ JSON) -->
        <div id="view-admin-event-form" class="section-view">
            <div class="flex items-center gap-4 mb-6"><button onclick="switchAdminView('events')" class="btn btn-outline text-xs">â¬… è¿”å›åˆ—è¡¨</button><h2 id="form-title" class="text-xl font-bold">è¨­å®šæ´»å‹•å…§å®¹</h2></div>
            <div class="card p-6">
                <div class="form-section">
                    <div class="form-title">1. å–®æ—¥æ´»å‹•åŸºç¤è³‡è¨Š</div>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2"><label class="field-label">æ´»å‹•å®Œæ•´åç¨±</label><input type="text" id="ev-name" class="input-std"></div>
                        <div><label class="field-label">æ´»å‹•æ—¥æœŸ</label><input type="date" id="ev-date" class="input-std"></div>
                        <div class="flex gap-2">
                            <div class="flex-1"><label class="field-label">é–‹å§‹æ™‚é–“</label><input type="time" id="ev-time-s" class="input-std"></div>
                            <div class="flex-1"><label class="field-label">çµæŸæ™‚é–“</label><input type="time" id="ev-time-e" class="input-std"></div>
                        </div>
                        <div><label class="field-label">äººæ•¸ä¸Šé™</label><input type="number" id="ev-capacity" class="input-std"></div>
                        <div><label class="field-label">æ´»å‹•åˆ†é¡</label><select id="ev-category" class="input-std"></select></div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-title">2. åƒ¹æ ¼èˆ‡æ—©é³¥è¨­å®š</div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="field-label">å–®æ—¥åŸåƒ¹å­¸è²»</label><input type="number" id="ev-price" class="input-std"></div>
                        <div><label class="field-label">è«‹å‡æ‰£æŠµé‡‘é¡</label><input type="number" id="ev-deduct" class="input-std"></div>
                        <div class="col-span-2 mt-4 pt-4 border-t border-dashed">
                            <label class="flex items-center gap-2 mb-3 cursor-pointer"><input type="checkbox" id="ev-early-enable"> <b>å•Ÿç”¨æ—©é³¥å„ªæƒ </b></label>
                            <div class="grid grid-cols-2 gap-4">
                                <div><label class="field-label">æ—©é³¥å„ªå¾…åƒ¹æ ¼</label><input type="number" id="ev-early-price" class="input-std"></div>
                                <div><label class="field-label">æˆªæ­¢æ—¥æœŸ</label><input type="datetime-local" id="ev-early-deadline" class="input-std"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <div class="form-title">3. è³‡æ ¼å¯©æ ¸é–€æª»</div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="field-label">å¹´ç´šé™åˆ¶ (å¯å¤šé¸)</label>
                            <div id="grade-options" class="grid grid-cols-2 gap-1 mt-2">
                                <label class="text-xs flex items-center gap-1 font-normal"><input type="checkbox" value="å¹¼å…’çµ„"> å¹¼å…’çµ„</label>
                                <label class="text-xs flex items-center gap-1 font-normal"><input type="checkbox" value="ä½å¹´ç´š"> ä½å¹´ç´š</label>
                                <label class="text-xs flex items-center gap-1 font-normal"><input type="checkbox" value="ä¸­å¹´ç´š"> ä¸­å¹´ç´š</label>
                                <label class="text-xs flex items-center gap-1 font-normal"><input type="checkbox" value="é«˜å¹´ç´š"> é«˜å¹´ç´š</label>
                            </div>
                        </div>
                        <div>
                            <label class="field-label">ç­‰ç´šé™åˆ¶</label>
                            <select id="ev-level-req" class="input-std">
                                <option value="ç„¡">ç„¡é™åˆ¶</option>
                                <option value="åˆç´š">éœ€å®Œæˆåˆç´šç­</option>
                                <option value="ä¸­ç´š">éœ€å®Œæˆä¸­ç´šç­</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="mt-8 flex justify-end gap-3"><button onclick="switchAdminView('events')" class="btn btn-outline px-10">å–æ¶ˆ</button><button onclick="AdminEventManager.save()" id="btn-save-event" class="btn btn-blue px-16 font-bold">å„²å­˜å­˜æª” ğŸ’¾</button></div>
            </div>
        </div>

        <!-- [ç®¡ç†ç«¯] å…¨é«”æœƒå“¡åå†Š -->
        <div id="view-admin-members" class="section-view">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold">å…¨é«”æœƒå“¡åå†Š</h2>
                <input type="text" class="input-std w-64 text-xs" placeholder="æœå°‹å§“åã€é›»è©±..." oninput="AdminMemberManager.filter(this.value)">
            </div>
            <div class="card overflow-x-auto">
                <table class="data-table">
                    <thead><tr><th>å§“å</th><th>é›»è©±</th><th>å¹´ç´š</th><th>ç­‰ç´š</th><th>æ“ä½œ</th></tr></thead>
                    <tbody id="admin-member-table-body"></tbody>
                </table>
            </div>
        </div>

        <!-- [ç®¡ç†ç«¯] åƒæ•¸è¨­å®š (åƒæ•¸å€) -->
        <div id="view-admin-config" class="section-view">
            <h2 class="text-xl font-bold mb-6">æ ¸å¿ƒåƒæ•¸ç®¡ç† (åƒæ•¸å€)</h2>
            <div class="card"><div class="card-header">é¦–é å¤§å…¬å‘Š</div><div class="card-body"><textarea id="cfg-announcement" rows="3" class="input-std"></textarea></div></div>
            <div class="card">
                <div class="card-header">è¨­å‚™ç§Ÿç”¨è³‡æ–™åº«</div>
                <div class="card-body">
                    <div id="admin-rent-list" class="space-y-2 mb-4"></div>
                    <div class="flex gap-2"><input type="text" id="new-rent-name" class="input-std" placeholder="åç¨±"><input type="number" id="new-rent-price" class="input-std" placeholder="ç§Ÿé‡‘"><button onclick="ConfigManager.addItem()" class="btn btn-blue">æ–°å¢</button></div>
                </div>
            </div>
            <button onclick="ConfigManager.saveAll()" class="btn btn-blue w-full py-4 font-bold">åŒæ­¥æ›´æ–°é›²ç«¯è¨­å®š âœ</button>
        </div>

    </main>

    <script>
        const LIFF_ID = "2008786875-7COWtgtL";
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        let state = { uid: null, events: [], adminMembers: [], config: {}, role: 'ä¸€èˆ¬ç”¨æˆ¶', currentEditingId: null, tempRentals: [] };

        const App = {
            async init() {
                try {
                    await liff.init({ liffId: LIFF_ID });
                    if (!liff.isLoggedIn() && liff.isInClient()) { liff.login(); return; }
                    let profile = { userId: "DEBUG_USER" };
                    if (liff.isLoggedIn()) profile = await liff.getProfile();
                    state.uid = profile.userId;
                    await this.loadInitialData();
                } catch (e) { await this.loadInitialData(); }
            },
            async loadInitialData() {
                const res = await fetch(`${PROXY_URL}?action=checkUser&uid=${state.uid}`);
                const r = await res.json();
                state.role = r.role || 'ä¸€èˆ¬ç”¨æˆ¶';
                // é–‹ç™¼éšæ®µç›´æ¥é–‹å•Ÿç®¡ç†ä»‹é¢ä»¥ä¾¿æ‚¨çœ‹åˆ°
                switchAdminView('dashboard');
                await this.refreshData();
                document.getElementById('view-loading').style.display='none';
            },
            async refreshData() {
                const res = await fetch(`${PROXY_URL}?action=getEvents&_t=${Date.now()}`);
                const r = await res.json();
                state.events = r.data || [];
                state.config = r.config || {};
                renderActivityList();
            }
        };

        const AdminEventManager = {
            openEditor(id = null) {
                state.currentEditingId = id;
                document.getElementById('form-title').innerText = id ? 'ç·¨è¼¯æ´»å‹•' : 'ç™¼ä½ˆå–®æ—¥æ´»å‹•';
                document.getElementById('ev-category').innerHTML = (state.config.sportCategories || "è¶³çƒ").split(',').map(c => `<option value="${c}">${c}</option>`).join('');
                if (!id) document.querySelectorAll('#view-admin-event-form input:not([type="checkbox"]), #view-admin-event-form textarea').forEach(i => i.value = '');
                showSection('view-admin-event-form');
            },
            async save() {
                const btn = document.getElementById('btn-save-event');
                btn.disabled = true; btn.innerText = "è³‡æ–™åŒæ­¥ä¸­...";
                const grades = Array.from(document.querySelectorAll('#grade-options input:checked')).map(i => i.value).join(',');
                const payload = {
                    action: 'updateEvent',
                    payload: {
                        'æ´»å‹•ID': state.currentEditingId || 'EV'+Date.now(),
                        'æ´»å‹•åç¨±': document.getElementById('ev-name').value,
                        'é–‹å§‹æ—¥æœŸ': document.getElementById('ev-date').value,
                        'å…¨æ—¥åƒ¹': document.getElementById('ev-price').value,
                        'å…¨æ—¥æ—©é³¥åƒ¹': document.getElementById('ev-early-enable').checked ? document.getElementById('ev-early-price').value : '',
                        'æ¢¯æ¬¡è³‡æ–™': document.getElementById('ev-time-s').value + '-' + document.getElementById('ev-time-e').value,
                        'å…§å®¹åª’é«”': document.getElementById('ev-capacity').value,
                        'åˆ†é¡': grades, 'æ¨™ç±¤': document.getElementById('ev-level-req').value,
                        'æ´»å‹•å‹æ…‹': 'å–®æ—¥å‹', 'ç‹€æ…‹': 'ä¸Šæ¶'
                    }
                };
                await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert("âœ… åŒæ­¥æˆåŠŸï¼");
                await App.refreshData();
                switchAdminView('events');
                btn.disabled = false; btn.innerText = "å„²å­˜å­˜æª” ğŸ’¾";
            }
        };

        const AdminMemberManager = {
            async load() {
                const res = await fetch(`${PROXY_URL}?action=getAdminMembers`);
                const r = await res.json();
                state.adminMembers = r.data || [];
                this.render(state.adminMembers);
            },
            render(data) {
                document.getElementById('admin-member-table-body').innerHTML = data.map(m => `<tr><td class="font-bold">${m.å§“å}</td><td>${m.è¯ç¹«é›»è©±}</td><td>${m.å¹´ç´š}</td><td>${m.ç­‰ç´š||'åˆç´š'}</td><td><button onclick="safeNavigate('register.html?edit=${m.å­¸å“¡ID}')" class="text-blue-600 underline">è©³æƒ…</button></td></tr>`).join('');
            },
            filter(q) { this.render(state.adminMembers.filter(m => m.å§“å.includes(q) || m.è¯ç¹«é›»è©±.includes(q))); }
        };

        const ConfigManager = {
            render() {
                document.getElementById('cfg-announcement').value = state.config.announcement || "";
                let rentals = []; try { rentals = JSON.parse(state.config.rentalItems || "[]"); } catch(e){}
                state.tempRentals = rentals; this.renderList();
            },
            addItem() {
                const n = document.getElementById('new-rent-name').value, p = document.getElementById('new-rent-price').value;
                if(n && p) { state.tempRentals.push({name:n, price:Number(p)}); this.renderList(); }
            },
            renderList() { document.getElementById('admin-rent-list').innerHTML = state.tempRentals.map((it, i) => `<div class="flex justify-between items-center bg-gray-50 p-2 border rounded text-xs mb-1"><span><b>${it.name}</b> ($${it.price})</span><button onclick="ConfigManager.removeItem(${i})" class="text-red-500 font-bold">âœ•</button></div>`).join(''); },
            removeItem(i) { state.tempRentals.splice(i, 1); this.renderList(); },
            async saveAll() {
                const payload = { action: 'updateConfig', payload: { announcement: document.getElementById('cfg-announcement').value, rentalItems: JSON.stringify(state.tempRentals) }};
                await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify(payload) });
                alert("âœ… åƒæ•¸å·²åŒæ­¥");
            }
        };

        function switchView(v) {
            document.querySelectorAll('.nav-item, .sub-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-' + v)?.classList.add('active');
            document.getElementById('sub-menu-admin').classList.remove('active');
            showSection('view-' + v);
            if(v==='member') loadUserMembers();
        }
        function toggleAdminNav() { document.getElementById('sub-menu-admin').classList.toggle('active'); }
        function switchAdminView(v) {
            document.querySelectorAll('.nav-item, .sub-item').forEach(el => el.classList.remove('active'));
            document.getElementById('nav-admin').classList.add('active');
            document.getElementById('sub-' + v).classList.add('active');
            if(v==='events') renderAdminEventList();
            if(v==='members') AdminMemberManager.load();
            if(v==='config') ConfigManager.render();
            showSection('view-admin-' + v);
        }
        function showSection(id) { document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo(0,0); }

        function renderAdminEventList() {
            document.getElementById('admin-event-table-body').innerHTML = state.events.map(ev => `<tr><td class="font-bold">${ev['æ´»å‹•åç¨±']}</td><td class="text-xs">${ev['é–‹å§‹æ—¥æœŸ'].substring(5,10)} (${ev['æ¢¯æ¬¡è³‡æ–™']})</td><td class="text-xs font-bold text-blue-600">${ev['å…§å®¹åª’é«”']||0}äºº</td><td class="text-xs font-bold">$${parseInt(ev['å…¨æ—¥åƒ¹'])}</td><td><span class="status-badge badge-green">ä¸Šæ¶ä¸­</span></td><td class="text-right"><button onclick="AdminEventManager.openEditor('${ev['æ´»å‹•ID']}')" class="text-blue-600 underline font-bold text-xs">ç·¨è¼¯</button></td></tr>`).join('');
        }

        function renderActivityList() {
            document.getElementById('activity-list').innerHTML = state.events.filter(e => e['ç‹€æ…‹'] === 'ä¸Šæ¶').map(e => `<div class="card flex p-3 gap-3"><img src="${e['åœ–ç‰‡URL'] || 'https://placehold.co/100'}" class="w-24 h-24 rounded object-cover border"><div class="flex-1 flex flex-col"><h3 class="font-bold text-sm">${e['æ´»å‹•åç¨±']}</h3><p class="text-[10px] text-gray-400 mt-1">${e['é–‹å§‹æ—¥æœŸ'].substring(0,10)} (${e['æ¢¯æ¬¡è³‡æ–™']})</p><div class="mt-auto flex justify-between items-center"><span class="text-blue-600 font-bold text-xs">$${e['å…¨æ—¥åƒ¹']}</span><button onclick="window.location.href='booking.html?id=${e['æ´»å‹•ID']}'" class="btn btn-blue py-1 px-4 text-xs">é ç´„</button></div></div></div>`).join('');
        }

        async function loadUserMembers() {
            const res = await fetch(`${PROXY_URL}?action=getFamily&uid=${state.uid}`);
            const r = await res.json();
            document.getElementById('family-grid').innerHTML = (r.data || []).map(m => `<div class="card p-4 flex items-center justify-between"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-slate-200 text-slate-600 rounded-full flex items-center justify-center font-bold">${m.å§“å[0]}</div><div><h4 class="font-bold text-sm">${m.å§“å}</h4><p class="text-[10px] text-slate-400">${m.å¹´ç´š} | ç­‰ç´šï¼š${m.ç­‰ç´š||'åˆç´š'}</p></div></div><button onclick="safeNavigate('register.html?edit=${m.å­¸å“¡ID}')" class="btn btn-outline text-xs">ç·¨è¼¯</button></div>`).join('');
        }

        async function loadAdminStats() {
            const res = await fetch(`${PROXY_URL}?action=getAdminStats`);
            const r = await res.json();
            document.getElementById('stat-total').innerText = r.totalBookings || '0';
            document.getElementById('stat-today').innerText = r.todayBookings || '0';
        }

        function safeNavigate(t) { window.location.href = t; }
        window.onload = () => App.init();
    </script>
</body>
</html>
