/**
 * 運動島預約系統 - 後端核心 (角色權限配套版)
 * 適用角色：一般成員、教練、學校、機關單位、管理員
 */

const SS_ID = "1Q2pyb7ljtWg3n_R8KSeyHrFLt6Ra4nXUmqhTZhUWZJg";
const SS = SpreadsheetApp.openById(SS_ID);

function doGet(e) {
  const action = e.parameter.action;
  const uid = e.parameter.uid;
  try {
    if (action === 'checkUser') return createJsonResponse(checkUserStatus(uid));
    if (action === 'getFamily') return createJsonResponse(getFamilyMembers(uid));
    if (action === 'getHistory') return createJsonResponse(getHistoryByUid(uid));
    if (action === 'getEvents') return createJsonResponse({ status: 'success', data: getSheetData("Events"), config: getSystemConfig() });
    
    // 店家管理專用接口
    if (action === 'adminGetAllRegs') return createJsonResponse({ status: 'success', data: getSheetData("Registrations") });
    if (action === 'adminGetAllStudents') return createJsonResponse({ status: 'success', data: getSheetData("Students") });
    
    return createJsonResponse({ status: 'online', version: 'Role_Access_v1' });
  } catch (err) {
    return createJsonResponse({ status: 'error', message: err.toString() });
  }
}

function doPost(e) {
  let postData;
  try { postData = JSON.parse(e.postData.contents); } catch (err) { return createJsonResponse({ status: 'error', message: 'JSON Parse Fail' }); }
  const action = postData.action;
  const payload = postData.payload;

  try {
    if (action === 'registerUser') return createJsonResponse(registerUser(payload));
    if (action === 'addStudent') return createJsonResponse(addOrUpdateStudent(payload));
    if (action === 'submitRegistration') return createJsonResponse(submitRegistrationLogic(payload));
    if (action === 'adminVerifyPayment') return createJsonResponse(adminVerifyPayment(payload));
    if (action === 'updateConfig') return createJsonResponse(updateConfig(payload));
    return createJsonResponse({ status: 'error', message: 'Unknown Command' });
  } catch (err) {
    return createJsonResponse({ status: 'error', message: err.toString() });
  }
}

/* --- 會員身分與角色核心邏輯 --- */

/**
 * 檢查用戶是否註冊及其身分角色
 */
function checkUserStatus(uid) {
  const sheet = getSheet("Users", ["UID", "姓名", "電話", "註冊型態", "註冊日期"]);
  const data = sheet.getDataRange().getValues();
  
  // 尋找符合 UID 的列
  const userRow = data.find(r => String(r[0]) === String(uid));
  
  if (userRow) {
    return { 
      status: 'registered', 
      data: { 
        uid: userRow[0], 
        name: userRow[1], 
        type: userRow[3] // 這裡會回傳：一般成員、管理員、教練等
      } 
    };
  } else {
    return { status: 'not_found' };
  }
}

/**
 * 執行註冊 (配合前端選取的 Role)
 */
function registerUser(p) {
  const sheet = getSheet("Users", ["UID", "姓名", "電話", "註冊型態", "註冊日期"]);
  const data = sheet.getDataRange().getValues();
  
  let rowIndex = -1;
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][0]) === String(p.uid)) {
      rowIndex = i + 1;
      break;
    }
  }

  const rowData = [
    p.uid, 
    p.name, 
    p.phone || "LINE", 
    p.type || "一般成員", // 這裡接收前端傳來的：學校、機關單位、管理員、教練
    new Date()
  ];

  if (rowIndex > 0) {
    // 已存在則更新身分
    sheet.getRange(rowIndex, 1, 1, rowData.length).setValues([rowData]);
  } else {
    // 新用戶則新增行
    sheet.appendRow(rowData);
  }
  
  return { status: 'success' };
}

/* --- 通用工具與其他邏輯 --- */

function getSheetData(name) {
  const sheet = SS.getSheetByName(name);
  if (!sheet) return [];
  const values = sheet.getDataRange().getValues();
  if (values.length <= 1) return [];
  const headers = values[0].map(h => String(h).trim());
  return values.slice(1).map(row => {
    let obj = {};
    headers.forEach((h, i) => {
      let val = row[i];
      if (val instanceof Date) val = Utilities.formatDate(val, "GMT+8", "yyyy-MM-dd");
      obj[h] = val;
    });
    return obj;
  });
}

function getSheet(name, headers) {
  let s = SS.getSheetByName(name);
  if (!s) { s = SS.insertSheet(name); if(headers.length) s.appendRow(headers); }
  return s;
}

function getSystemConfig() {
  const sheet = getSheet("SystemConfig", ["Key", "Value", "Date"]);
  const config = { bankInfo: "", sportCategories: "籃球,足球,溜冰,游泳,體操,武術" };
  const data = sheet.getDataRange().getValues();
  data.slice(1).forEach(r => { 
    if (String(r[0]) === "bankInfo") config.bankInfo = r[1]; 
    if (String(r[0]) === "sportCategories") config.sportCategories = r[1]; 
  });
  return config;
}

function createJsonResponse(data) { 
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON); 
}

// 其餘邏輯 (addOrUpdateStudent, submitRegistrationLogic 等) 請維持您原始 Expert 版代碼即可
