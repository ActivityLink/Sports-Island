<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="icon" href="data:,">
    <title>é‹å‹•å³¶ SPORTS ISLAND - ç©©å®šå„ªåŒ–ç‰ˆ</title>
    <!-- LINE SDK & Libraries -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500&display=swap');
        
        /* 1. æ ¸å¿ƒç©©å®šè¨­å®šï¼šé˜²æ­¢è·³å‹•èˆ‡é–ƒçˆ */
        :root {
            --bg-color: #f0f2f5;
            --primary-blue: #1877f2;
        }

        html, body { 
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            height: 100%;
            /* é è¨­éš±è—æ»¾å‹•æ¢ï¼Œåˆå§‹åŒ–å¾Œå†æ‰“é–‹ */
            overflow: hidden; 
            -webkit-tap-highlight-color: transparent;
        }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            color: #1c1e21; 
            font-size: 17px; /* æ”¾å¤§å­—é«” */
            line-height: 1.6;
        }
        
        /* ä¸»å®¹å™¨ï¼šä½¿ç”¨ dvh å–®ä½é©æ‡‰è¡Œå‹•è£ç½®å·¥å…·åˆ— */
        .main-container { 
            max-width: 1080px; 
            margin: 0 auto; 
            padding: 0 16px; 
            min-height: 100dvh;
        }
        
        .content-card { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.08); 
            padding: 28px; 
            margin-bottom: 24px; 
        }

        /* å°è¦½åˆ—ç©©å®šåŒ– */
        .nav-tab { 
            flex: 1; 
            text-align: center; 
            padding: 18px 0; 
            font-size: 16px; 
            color: rgba(255,255,255,0.7); 
            border-bottom: 3px solid transparent; 
            cursor: pointer; 
            transition: all 0.2s ease;
        }
        .nav-tab.active { 
            color: white !important; 
            border-bottom-color: white !important; 
        }

        /* ä»‹é¢æº–å‚™ç‹€æ…‹ï¼šéš±è—ä½†ä½”ä½ï¼Œæ¸›å°‘ Reflow */
        #main-header, #main-content { 
            visibility: hidden;
            opacity: 0;
        }

        /* è¦–åœ–åˆ‡æ›ï¼šç´”é€æ˜åº¦éæ¸¡ */
        .section-view { 
            display: none; 
            opacity: 0; 
        }
        .section-view.active { 
            display: block; 
            animation: fadeInPure 0.4s forwards; 
        }
        @keyframes fadeInPure { 
            from { opacity: 0; } 
            to { opacity: 1; } 
        }
        
        /* è§’è‰²æŒ‰éˆ•å„ªåŒ–ï¼šå¤§ç©ºé–“ï¼Œèˆ’é©å­—é«” */
        .role-option { 
            border: 1px solid #dddfe2; 
            padding: 24px; 
            border-radius: 16px; 
            cursor: pointer; 
            transition: 0.2s; 
            text-align: center; 
            background: white; 
            font-size: 16px;
        }
        .role-option.selected { 
            border-color: var(--primary-blue); 
            background: #e7f3ff; 
            color: var(--primary-blue); 
            box-shadow: 0 0 0 1px var(--primary-blue);
        }

        .input-giant { 
            width: 100%; 
            border: 1px solid #dddfe2; 
            border-radius: 12px; 
            padding: 16px; 
            outline: none; 
            background: #f5f6f7; 
            font-size: 17px; 
            transition: all 0.2s;
        }
        .input-giant:focus { 
            border-color: var(--primary-blue); 
            background: white; 
            box-shadow: 0 0 0 3px rgba(24,119,242,0.1);
        }
        
        .btn-primary { 
            background: var(--primary-blue); 
            color: white; 
            padding: 20px; 
            border-radius: 14px; 
            width: 100%; 
            text-align: center; 
            cursor: pointer; 
            border: none; 
            display: block; 
            font-size: 18px; 
            transition: opacity 0.2s;
        }
        .btn-primary:active { opacity: 0.8; }

        /* å…¨è¢å¹•è¼‰å…¥ç•«é¢ï¼šç©©å®šèƒŒæ™¯è‰² */
        #view-loading {
            position: fixed;
            inset: 0;
            background: var(--bg-color);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #msg-box { 
            position: fixed; 
            top: 24px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 10001; 
            background: rgba(0,0,0,0.85); 
            color: white; 
            padding: 16px 36px; 
            border-radius: 12px; 
            font-size: 16px; 
            display: none; 
            backdrop-filter: blur(8px);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <div id="msg-box"></div>

    <!-- è¼‰å…¥ä¸­ç•«é¢ -->
    <div id="view-loading">
        <div class="w-12 h-12 border-[3px] border-[#1877f2] border-t-transparent rounded-full animate-spin"></div>
        <p id="loading-status" class="mt-8 text-gray-400 text-sm tracking-[0.2em] uppercase">Sport Island Syncing</p>
    </div>

    <!-- é ‚éƒ¨å°è¦½ -->
    <header id="main-header" class="bg-[#1877f2] text-white pt-5 pb-1 sticky top-0 z-50 shadow-sm">
        <div class="main-container flex justify-between items-center">
            <div class="flex items-center gap-5">
                <h1 class="text-2xl cursor-pointer tracking-tight" onclick="location.reload()">SPORTS ISLAND</h1>
                <div class="profile-chip flex items-center gap-3 bg-white/10 p-1 px-4 rounded-full">
                    <div class="avatar-frame w-8 h-8 rounded-full overflow-hidden bg-white shadow-inner">
                        <img id="line-logo-display" src="" class="w-full h-full object-cover">
                    </div>
                    <span id="line-name-display" class="text-sm truncate max-w-[90px]">...</span>
                </div>
            </div>
            <nav id="top-nav" class="flex gap-4">
                <div onclick="switchMainTab('activity')" id="tab-activity" class="nav-tab active">æ´»å‹•åˆ—è¡¨</div>
                <div onclick="switchMainTab('member')" id="tab-member" class="nav-tab">æœƒå“¡ä¸­å¿ƒ</div>
                <div onclick="switchMainTab('admin')" id="tab-admin" class="nav-tab hidden">ç®¡ç†å¾Œå°</div>
            </nav>
        </div>
    </header>

    <main id="main-content" class="main-container py-10">
        
        <!-- [0. è¨»å†Šè¦–åœ–] -->
        <div id="view-register" class="section-view max-w-xl mx-auto">
            <div class="content-card">
                <h2 class="text-2xl mb-4 text-center">æ­¡è¿ä¾†åˆ°é‹å‹•å³¶</h2>
                <p class="text-gray-500 text-center mb-12">è«‹é¸æ“‡æ‚¨çš„ä½¿ç”¨è€…èº«ä»½ä»¥å®Œæˆè¨»å†Š</p>
                
                <div class="space-y-8">
                    <div>
                        <label class="block text-sm text-gray-400 mb-3 ml-1">é¡¯ç¤ºåç¨±</label>
                        <input type="text" id="reg-name" class="input-giant" placeholder="å€‹äººå§“åæˆ–å–®ä½åç¨±">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-400 mb-3 ml-1">å¸³è™Ÿè§’è‰²</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div class="role-option" onclick="selectRole(this, 'ä¸€èˆ¬æˆå“¡')">ä¸€èˆ¬æˆå“¡</div>
                            <div class="role-option" onclick="selectRole(this, 'æ•™ç·´')">æ•™ç·´</div>
                            <div class="role-option" onclick="selectRole(this, 'å­¸æ ¡')">å­¸æ ¡å–®ä½</div>
                            <div class="role-option" onclick="selectRole(this, 'æ©Ÿé—œå–®ä½')">æ©Ÿé—œå–®ä½</div>
                            <div class="role-option col-span-2" onclick="selectRole(this, 'ç®¡ç†å“¡')">ç³»çµ±ç®¡ç†å“¡</div>
                        </div>
                    </div>
                    <button onclick="RegistrationFlow.completeUserRegistration()" class="btn-primary mt-12 shadow-lg">å®Œæˆè¨»å†Šä¸¦ç™»å…¥</button>
                </div>
            </div>
        </div>

        <!-- [1. æ´»å‹•åˆ—è¡¨è¦–åœ–] -->
        <div id="view-activity" class="section-view">
            <div class="rounded-3xl overflow-hidden mb-12 shadow-sm">
                <img src="https://aiwe.cc/wp-content/uploads/2025/12/3486bc19dc6317e16bf4f1449ec52ae4.jpg" class="w-full h-auto max-h-[300px] object-cover">
            </div>
            <div class="flex flex-col gap-6 mb-12">
                <input type="text" id="search-input" oninput="loadCourses()" placeholder="ğŸ” æœå°‹æ„Ÿèˆˆè¶£çš„æ´»å‹•åç¨±..." class="input-giant !bg-white border-none shadow-sm">
                <div id="category-tags" class="flex gap-4 overflow-x-auto no-scrollbar pb-2"></div>
            </div>
            <div id="event-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-10"></div>
        </div>

        <!-- [5. æœƒå“¡ä¸­å¿ƒè¦–åœ–] -->
        <div id="view-member" class="section-view">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
                <div class="lg:col-span-7">
                    <h2 class="text-2xl mb-10">æˆå“¡ç¶­è­·</h2>
                    <div id="family-grid" class="space-y-6"></div>
                    <button onclick="RegistrationFlow.showStudentForm()" class="btn-primary mt-10">ï¼‹ æ–°å¢å­¸å“¡æˆå“¡</button>
                </div>
                <div class="lg:col-span-5">
                    <h2 class="text-2xl mb-10">å ±åæ­·å²</h2>
                    <div id="history-container" class="space-y-6"></div>
                </div>
            </div>
        </div>

        <!-- [6. ç®¡ç†å¾Œå°è¦–åœ–] -->
        <div id="view-admin" class="section-view">
            <div class="flex gap-4 mb-12 bg-white p-3 rounded-2xl shadow-sm overflow-x-auto no-scrollbar">
                <button onclick="AdminService.switchModule('dashboard')" class="px-8 py-3 rounded-xl text-base hover:bg-gray-50 transition-all">ç‡Ÿé‹ç¸½è¦½</button>
                <button onclick="AdminService.switchModule('events')" class="px-8 py-3 rounded-xl text-base hover:bg-gray-50 transition-all">æ´»å‹•åº«ç®¡ç†</button>
            </div>
            <div id="adm-content" class="min-h-[400px]">
                <p class="text-center py-20 text-gray-400">ç®¡ç†æ¨¡çµ„è¼‰å…¥ä¸­...</p>
            </div>
        </div>

    </main>

    <script>
        const LIFF_ID = "2008786875-7COWtgtL";
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        let state = { uid: "DEBUG_USER", name: "", role: "", isRegistered: false, currentView: "" };
        let selectedRoleName = "ä¸€èˆ¬æˆå“¡";

        const RegistrationFlow = {
            async init() {
                try {
                    await liff.init({ liffId: LIFF_ID });
                    if (!liff.isLoggedIn()) { liff.login(); return; }
                    const p = await liff.getProfile();
                    state.uid = p.userId;
                    document.getElementById('line-name-display').innerText = p.displayName;
                    document.getElementById('line-logo-display').src = p.pictureUrl || "";
                    await this.checkStatus();
                } catch (e) { 
                    console.error("LIFF Error", e);
                    this.showApp('activity');
                }
            },
            async checkStatus() {
                try {
                    const res = await fetch(`${PROXY_URL}?action=checkUser&uid=${state.uid}`);
                    const r = await res.json();
                    
                    if (r.status === 'registered') {
                        state.isRegistered = true;
                        state.role = r.data.type;
                        if (state.role === 'ç®¡ç†å“¡') document.getElementById('tab-admin').classList.remove('hidden');
                        this.showApp('activity');
                    } else {
                        this.showApp('register');
                        document.getElementById('reg-name').value = document.getElementById('line-name-display').innerText;
                    }
                } catch (err) {
                    this.showApp('activity');
                }
            },
            showApp(targetView = 'activity') {
                // 1. å…ˆåŸ·è¡Œä½ˆå±€æ¸²æŸ“
                const header = document.getElementById('main-header');
                const content = document.getElementById('main-content');
                
                header.style.visibility = 'visible';
                header.style.opacity = '1';
                content.style.visibility = 'visible';
                content.style.opacity = '1';
                
                switchView(targetView);
                
                // 2. ä½ˆå±€å®Œæˆå¾Œï¼Œæ·¡å‡º Loading ç•«é¢
                const loading = document.getElementById('view-loading');
                loading.style.opacity = '0';
                
                setTimeout(() => {
                    loading.style.visibility = 'hidden';
                    // 3. æœ€å¾Œè§£é–æ»¾å‹•æ¢ï¼Œé¿å…è¼‰å…¥æ™‚ç•«é¢è·³å‹•
                    document.documentElement.style.overflow = 'auto';
                    document.body.style.overflow = 'auto';
                }, 500);
            },
            async completeUserRegistration() {
                const name = document.getElementById('reg-name').value;
                if (!name) return showMsg("è«‹è¼¸å…¥æ­£ç¢ºå§“å");
                showMsg("å»ºç«‹å¸³è™Ÿä¸­...");
                const res = await fetch(PROXY_URL, { 
                    method: 'POST', 
                    body: JSON.stringify({ 
                        action: 'registerUser', 
                        payload: { uid: state.uid, name: name, type: selectedRoleName } 
                    }) 
                });
                if ((await res.json()).status === 'success') {
                    showMsg("ğŸ‰ è¨»å†ŠæˆåŠŸ");
                    location.reload();
                }
            }
        };

        function selectRole(el, role) {
            document.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            selectedRoleName = role;
        }

        function switchMainTab(m) {
            if (state.currentView === m) return;
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + m)?.classList.add('active');
            switchView(m);
            if (m === 'activity') loadCourses();
        }

        function switchView(v) {
            if (state.currentView === v) return;
            const views = document.querySelectorAll('.section-view');
            views.forEach(el => el.classList.remove('active'));
            const target = document.getElementById('view-' + v);
            if (target) {
                target.classList.add('active');
                state.currentView = v;
                // åƒ…åœ¨åˆå§‹åŒ–å®Œæˆä¸”ä¸æ˜¯ç¬¬ä¸€æ¬¡é¡¯ç¤ºæ™‚åŸ·è¡Œæ»¾å‹•ï¼Œå¾¹åº•é˜²æ­¢é–ƒçˆ
                if (document.getElementById('view-loading').style.visibility === 'hidden') {
                    window.scrollTo(0, 0);
                }
            }
        }

        async function loadCourses() {
            try {
                const res = await fetch(`${PROXY_URL}?action=getEvents&_t=${Date.now()}`);
                const r = await res.json();
                const list = document.getElementById('event-list');
                if (!list) return;
                list.innerHTML = (r.data || []).map(ev => `
                    <div class="content-card !p-0 overflow-hidden flex flex-col hover:shadow-lg transition-all duration-300">
                        <img src="${ev['åœ–ç‰‡URL']}" class="h-56 w-full object-cover">
                        <div class="p-8">
                            <p class="text-xs text-[#1877f2] uppercase mb-2 tracking-widest">${ev['åˆ†é¡']}</p>
                            <h3 class="text-xl mb-6 truncate leading-snug">${ev['æ´»å‹•åç¨±']}</h3>
                            <button class="btn-primary !py-3 !text-base shadow-sm">è©³æƒ…èˆ‡å ±å</button>
                        </div>
                    </div>`).join('');
            } catch (e) {}
        }

        const AdminService = {
            switchModule(m) {
                document.getElementById('adm-content').innerHTML = `<p class="text-center py-20 text-gray-400">ç‡Ÿé‹æ¨¡çµ„ ${m} è¼‰å…¥ä¸­...</p>`;
            }
        };

        window.onload = () => RegistrationFlow.init();
        function showMsg(t) { 
            const b = document.getElementById('msg-box'); 
            b.innerText = t; b.style.display='block'; 
            setTimeout(()=>b.style.display='none', 3000); 
        }
    </script>
</body>
</html>
