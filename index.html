/**
 * 運動島後端 API - 2025 價格體系升級版
 * 支援欄位擴充至 18 欄 (A-R)
 */

const SS_ID = "1Q2pyb7ljtWg3n_R8KSeyHrFLt6Ra4nXUmqhTZhUWZJg";
const SS = SpreadsheetApp.openById(SS_ID);

function doGet(e) {
  const action = e.parameter.action;
  try {
    if (action === 'getEvents') {
      return createJsonResponse({ 
        status: 'success', 
        data: getSheetData("Events"), 
        config: getSystemConfig() 
      });
    }
    return createJsonResponse({ status: 'online', message: '系統運行中' });
  } catch (err) {
    return createJsonResponse({ status: 'error', message: err.toString() });
  }
}

function doPost(e) {
  let postData;
  try {
    postData = JSON.parse(e.postData.contents);
  } catch (err) {
    return createJsonResponse({ status: 'error', message: 'JSON 解析失敗' });
  }

  const action = postData.action;
  const payload = postData.payload;

  try {
    if (action === 'updateEvent') {
      return createJsonResponse(updateEvent(payload));
    } else if (action === 'updateConfig') {
      return createJsonResponse(updateConfig(payload));
    } else if (action === 'submitRegistration') {
      return createJsonResponse(handleRegistration(payload));
    }
    return createJsonResponse({ status: 'error', message: '未知動作' });
  } catch (err) {
    return createJsonResponse({ status: 'error', message: err.toString() });
  }
}

function updateEvent(ev) {
  const sheet = SS.getSheetByName("Events");
  if (!sheet) return { status: 'error', message: '找不到 Events 表' };
  
  const targetId = String(ev.活動ID);
  const data = sheet.getDataRange().getValues();
  let rowIndex = -1;
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][0]) === targetId) { rowIndex = i + 1; break; }
  }

  // 18 個欄位完整對位 (A-R)
  const rowData = [
    targetId,          // A
    ev.活動型態,       // B
    ev.分類,           // C
    ev.活動名稱,       // D
    ev.梯次資料,       // E
    ev.開始日期,       // F
    ev.結束日期,       // G
    ev.全日價,         // H
    ev.全日扣除,       // I
    ev.半日扣除,       // J
    ev.總名額,         // K
    ev.描述,           // L
    ev.內容媒體,       // M
    ev.圖片URL,        // N
    ev.狀態,           // O
    ev.半日價,         // P (新增)
    ev.早鳥價,         // Q (新增)
    ev.早鳥截止日期    // R (新增)
  ];

  if (rowIndex > 0) sheet.getRange(rowIndex, 1, 1, rowData.length).setValues([rowData]);
  else sheet.appendRow(rowData);
  return { status: 'success' };
}

// 其餘函數 (handleRegistration, getSheetData, etc.) 保持與之前一致，但確保讀取時包含所有欄位
function getSheetData(name) {
  const sheet = SS.getSheetByName(name);
  if (!sheet) return [];
  const values = sheet.getDataRange().getValues();
  if (values.length <= 1) return [];
  const headers = values[0];
  return values.slice(1).map(row => {
    let obj = {};
    headers.forEach((h, i) => {
      let val = row[i];
      if (val instanceof Date) val = Utilities.formatDate(val, "GMT+8", "yyyy-MM-dd");
      obj[h] = val;
    });
    return obj;
  });
}

function getSystemConfig() {
  const sheet = SS.getSheetByName("SystemConfig");
  const config = { bankInfo: "", sportCategories: "" };
  if (!sheet) return config;
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (data[i][0] === "bankInfo") config.bankInfo = data[i][1];
    if (data[i][0] === "sportCategories") config.sportCategories = data[i][1];
  }
  return config;
}

function updateConfig(p) {
  const sheet = SS.getSheetByName("SystemConfig");
  const update = (key, val) => {
    let data = sheet.getDataRange().getValues();
    let found = false;
    for (let i = 1; i < data.length; i++) {
      if (data[i][0] === key) { sheet.getRange(i + 1, 2).setValue(val); found = true; break; }
    }
    if (!found) sheet.appendRow([key, val, new Date()]);
  };
  update("bankInfo", p.bankInfo);
  update("sportCategories", p.sportCategories);
  return { status: 'success' };
}

function handleRegistration(p) {
  const s = p.student;
  const sheet = SS.getSheetByName("Students");
  const data = sheet.getDataRange().getValues();
  let rowIndex = -1;
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][5]) === String(s.idNumber)) { rowIndex = i + 1; break; }
  }
  const rowData = [s.id, s.parentUid, s.name, s.gender, s.birthday, s.idNumber, s.height, s.weight, s.footSize, s.school, s.grade, s.health, s.diet, s.interests, s.updated];
  if (rowIndex > 0) sheet.getRange(rowIndex, 1, 1, rowData.length).setValues([rowData]);
  else sheet.appendRow(rowData);
  return { status: 'success' };
}

function createJsonResponse(data) {
  return ContentService.createTextOutput(JSON.stringify(data)).setMimeType(ContentService.MimeType.JSON);
}
