<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="icon" href="data:,">
    <title>é‹å‹•å³¶ SPORTS ISLAND</title>
    <!-- LINE SDK & Libraries -->
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500&display=swap');
        
        :root {
            --bg-color: #f0f2f5;
            --primary-blue: #1877f2;
            --header-height: 76px;
        }

        /* ç©©å®šåŸºç¤è¨­å®š */
        html { background-color: var(--bg-color); }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: var(--bg-color);
            color: #1c1e21; 
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden; /* åˆå§‹åŒ–æœŸé–“ç¦æ­¢æ»¾å‹•é˜²æ­¢è·³å‹• */
            font-size: 17px; 
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }
        
        /* ä½ˆå±€é–å®š */
        header {
            height: var(--header-height);
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .main-container { 
            max-width: 1080px; 
            margin: 0 auto; 
            padding: 0 16px; 
            min-height: calc(100dvh - var(--header-height));
        }
        
        .content-card { 
            background: white; 
            border-radius: 16px; 
            box-shadow: 0 1px 4px rgba(0,0,0,0.06); 
            padding: 28px; 
            margin-bottom: 24px; 
        }

        .nav-tab { 
            flex: 1; text-align: center; padding: 14px 0; font-size: 16px; 
            color: rgba(255,255,255,0.7); border-bottom: 3px solid transparent; 
            cursor: pointer; transition: all 0.2s;
        }
        .nav-tab.active { color: white !important; border-bottom-color: white !important; }

        /* è¦–åœ–åˆ‡æ›ï¼šç´”é€æ˜åº¦ï¼Œç„¡ä½ç§» */
        #main-content { visibility: hidden; opacity: 0; transition: opacity 0.5s ease; }
        .section-view { display: none; opacity: 0; }
        .section-view.active { display: block; animation: fadeInPure 0.5s forwards; }
        @keyframes fadeInPure { from { opacity: 0; } to { opacity: 1; } }

        /* å…ƒç´ æ¨£å¼å„ªåŒ– (ä¸åŠ ç²—) */
        .role-option { border: 1px solid #dddfe2; padding: 22px; border-radius: 16px; background: white; text-align: center; cursor: pointer; }
        .role-option.selected { border-color: var(--primary-blue); background: #e7f3ff; color: var(--primary-blue); }
        .input-giant { width: 100%; border: 1px solid #dddfe2; border-radius: 12px; padding: 16px; background: #f5f6f7; font-size: 17px; }
        .btn-primary { background: var(--primary-blue); color: white; padding: 18px; border-radius: 14px; width: 100%; text-align: center; font-size: 17px; cursor: pointer; border: none; }
        .btn-secondary { background: white; color: #606770; border: 1px solid #dddfe2; padding: 12px 24px; border-radius: 12px; font-size: 15px; cursor: pointer; }

        /* è¼‰å…¥ç•«é¢ */
        #view-loading {
            position: fixed; inset: 0; background: var(--bg-color); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #msg-box { 
            position: fixed; top: 24px; left: 50%; transform: translateX(-50%); z-index: 10001; 
            background: rgba(0,0,0,0.85); color: white; padding: 16px 36px; border-radius: 12px; 
            font-size: 16px; display: none; backdrop-filter: blur(8px);
        }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* æ—¥æ›†å°æ¨£å¼ */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; }
        .cal-day { aspect-ratio: 1; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 16px; cursor: pointer; border: 1px solid #eee; }
        .status-attend { background: #e7f3ff; color: #1877f2; border-color: #1877f2; }
    </style>
</head>
<body>

    <div id="msg-box"></div>

    <div id="view-loading">
        <div class="w-10 h-10 border-[3px] border-[#1877f2] border-t-transparent rounded-full animate-spin"></div>
        <p class="mt-6 text-gray-400 text-xs tracking-[0.3em] uppercase">Sport Island Syncing</p>
    </div>

    <header id="main-header" class="bg-[#1877f2] text-white sticky top-0 z-50 shadow-sm flex items-end pb-1">
        <div class="main-container w-full flex justify-between items-center">
            <div class="flex items-center gap-4">
                <h1 class="text-xl cursor-pointer tracking-tighter" onclick="location.reload()">SPORTS ISLAND</h1>
                <div class="profile-chip flex items-center gap-2 bg-white/10 p-1 px-3 rounded-full">
                    <div class="w-7 h-7 rounded-full overflow-hidden bg-white shadow-inner">
                        <img id="line-logo-display" src="" class="w-full h-full object-cover">
                    </div>
                    <span id="line-name-display" class="text-sm truncate max-w-[70px]">...</span>
                </div>
            </div>
            <nav id="top-nav" class="flex gap-4">
                <div onclick="switchMainTab('activity')" id="tab-activity" class="nav-tab active">æ´»å‹•</div>
                <div onclick="switchMainTab('member')" id="tab-member" class="nav-tab">æœƒå“¡</div>
                <div onclick="switchMainTab('admin')" id="tab-admin" class="nav-tab hidden">å¾Œå°</div>
            </nav>
        </div>
    </header>

    <main id="main-content" class="main-container py-8">
        
        <!-- [è¨»å†Šè¦–åœ–] -->
        <div id="view-register" class="section-view max-w-xl mx-auto">
            <div class="content-card">
                <h2 class="text-2xl mb-4 text-center">å¸³è™Ÿåˆå§‹åŒ–</h2>
                <p class="text-gray-500 text-center mb-10 text-sm">è«‹é¸æ“‡æ‚¨çš„èº«ä»½ä»¥é€²å…¥ç³»çµ±</p>
                <div class="space-y-6">
                    <input type="text" id="reg-name" class="input-giant" placeholder="é¡¯ç¤ºåç¨±">
                    <div class="grid grid-cols-2 gap-4">
                        <div class="role-option" onclick="selectRole(this, 'ä¸€èˆ¬æˆå“¡')">ä¸€èˆ¬æˆå“¡</div>
                        <div class="role-option" onclick="selectRole(this, 'æ•™ç·´')">æ•™ç·´</div>
                        <div class="role-option" onclick="selectRole(this, 'å­¸æ ¡')">å­¸æ ¡å–®ä½</div>
                        <div class="role-option" onclick="selectRole(this, 'æ©Ÿé—œå–®ä½')">æ©Ÿé—œå–®ä½</div>
                        <div class="role-option col-span-2" onclick="selectRole(this, 'ç®¡ç†å“¡')">ç³»çµ±ç®¡ç†å“¡</div>
                    </div>
                    <button onclick="RegistrationFlow.completeUserRegistration()" class="btn-primary mt-6">é–‹å•Ÿæˆ‘çš„é‹å‹•å³¶ âœ</button>
                </div>
            </div>
        </div>

        <!-- [æ´»å‹•åˆ—è¡¨] -->
        <div id="view-activity" class="section-view active">
            <div class="rounded-3xl overflow-hidden mb-10 shadow-sm">
                <img src="https://aiwe.cc/wp-content/uploads/2025/12/3486bc19dc6317e16bf4f1449ec52ae4.jpg" class="w-full h-auto max-h-[300px] object-cover">
            </div>
            <div class="flex flex-col gap-6 mb-10">
                <input type="text" id="search-input" oninput="loadCourses()" placeholder="ğŸ” æœå°‹æ´»å‹•åç¨±..." class="input-giant !bg-white border-none shadow-sm">
                <div id="category-tags" class="flex gap-3 overflow-x-auto no-scrollbar pb-1"></div>
            </div>
            <div id="event-list" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8"></div>
        </div>

        <!-- [æ´»å‹•è©³æƒ…] -->
        <div id="view-activity-detail" class="section-view">
            <button onclick="switchMainTab('activity')" class="mb-6 text-gray-500 text-sm flex items-center gap-2">â¬… è¿”å›åˆ—è¡¨</button>
            <div id="detail-content-area" class="content-card !p-0 overflow-hidden"></div>
        </div>

        <!-- [æœƒå“¡ä¸­å¿ƒ] -->
        <div id="view-member" class="section-view">
            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                <div class="lg:col-span-7">
                    <div class="flex justify-between items-center mb-8"><h2 class="text-2xl">æˆå“¡åˆ—è¡¨</h2><button onclick="RegistrationFlow.showStudentForm()" class="btn-secondary">+ æ–°å¢æˆå“¡</button></div>
                    <div id="family-grid" class="space-y-4"></div>
                </div>
                <div class="lg:col-span-5">
                    <h2 class="text-2xl mb-8">å ±åç´€éŒ„</h2>
                    <div id="history-container" class="space-y-4"></div>
                </div>
            </div>
        </div>

        <!-- [å€‹è³‡ç·¨è¼¯] -->
        <div id="view-student-form" class="section-view max-w-2xl mx-auto">
            <div class="content-card">
                <h2 class="text-2xl mb-8 text-[#1877f2]">ç¶­è­·æˆå“¡è³‡æ–™</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="col-span-full"><label class="block text-sm text-gray-400 mb-2">çœŸå¯¦å§“å</label><input type="text" id="stu-name" class="input-giant"></div>
                    <div><label class="block text-sm text-gray-400 mb-2">ç”Ÿæ—¥</label><input type="date" id="stu-birthday" class="input-giant"></div>
                    <div><label class="block text-sm text-gray-400 mb-2">èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" id="stu-id" class="input-giant uppercase"></div>
                </div>
                <button onclick="RegistrationFlow.submitStudent()" class="btn-primary mt-10">å„²å­˜è³‡æ–™ âœ</button>
                <button onclick="switchMainTab('member')" class="w-full mt-4 text-gray-400 text-sm">å–æ¶ˆè¿”å›</button>
            </div>
        </div>

        <!-- [ç®¡ç†å¾Œå°] -->
        <div id="view-admin" class="section-view">
            <div class="flex gap-4 mb-10 overflow-x-auto no-scrollbar">
                <button onclick="AdminService.switchModule('dashboard')" class="bg-white px-8 py-3 rounded-xl shadow-sm text-base">ç‡Ÿé‹ç¸½è¦½</button>
                <button onclick="AdminService.switchModule('events')" class="bg-white px-8 py-3 rounded-xl shadow-sm text-base">æ´»å‹•ç®¡ç†</button>
                <button onclick="AdminService.switchModule('crm')" class="bg-white px-8 py-3 rounded-xl shadow-sm text-base">æœƒå“¡åå–®</button>
            </div>
            <div id="adm-content" class="min-h-[400px]"></div>
        </div>

    </main>

    <script>
        const LIFF_ID = "2008786875-7COWtgtL";
        const PROXY_URL = "https://restless-silence-7212.wetw-net3.workers.dev/"; 
        let state = { uid: "DEBUG_USER", name: "", role: "", isRegistered: false, members: [], events: [], currentView: "" };
        let selectedRoleName = "ä¸€èˆ¬æˆå“¡";

        const RegistrationFlow = {
            async init() {
                try {
                    await liff.init({ liffId: LIFF_ID });
                    if (!liff.isLoggedIn()) { liff.login(); return; }
                    const p = await liff.getProfile();
                    state.uid = p.userId;
                    document.getElementById('line-name-display').innerText = p.displayName;
                    document.getElementById('line-logo-display').src = p.pictureUrl || "";
                    await this.checkStatus();
                } catch (e) { this.showApp('activity'); }
            },
            async checkStatus() {
                const res = await fetch(`${PROXY_URL}?action=checkUser&uid=${state.uid}`);
                const r = await res.json();
                if (r.status === 'registered') {
                    state.isRegistered = true;
                    state.role = r.data.type;
                    if (state.role === 'ç®¡ç†å“¡') document.getElementById('tab-admin').classList.remove('hidden');
                    this.showApp('activity');
                } else {
                    this.showApp('register');
                    document.getElementById('reg-name').value = document.getElementById('line-name-display').innerText;
                }
            },
            showApp(targetView) {
                switchView(targetView);
                document.getElementById('main-header').style.visibility = 'visible';
                document.getElementById('main-header').style.opacity = '1';
                document.getElementById('main-content').style.visibility = 'visible';
                document.getElementById('main-content').style.opacity = '1';
                setTimeout(() => {
                    document.getElementById('view-loading').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('view-loading').style.visibility = 'hidden';
                        document.body.style.overflow = 'auto';
                    }, 500);
                }, 200);
            },
            showStudentForm() { switchView('student-form'); },
            async submitStudent() {
                const p = { 
                    parentUid: state.uid, 
                    name: document.getElementById('stu-name').value, 
                    birthday: document.getElementById('stu-birthday').value,
                    idNumber: document.getElementById('stu-id').value
                };
                showMsg("å„²å­˜ä¸­...");
                await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify({ action: 'addStudent', payload: p }) });
                showMsg("âœ… å„²å­˜æˆåŠŸ");
                switchMainTab('member');
            },
            async completeUserRegistration() {
                const name = document.getElementById('reg-name').value;
                if (!name) return showMsg("è«‹è¼¸å…¥é¡¯ç¤ºåç¨±");
                const res = await fetch(PROXY_URL, { method: 'POST', body: JSON.stringify({ action: 'registerUser', payload: { uid: state.uid, name, type: selectedRoleName } }) });
                if ((await res.json()).status === 'success') location.reload();
            }
        };

        function selectRole(el, role) {
            document.querySelectorAll('.role-option').forEach(opt => opt.classList.remove('selected'));
            el.classList.add('selected');
            selectedRoleName = role;
        }

        function switchMainTab(m) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + m)?.classList.add('active');
            switchView(m);
            if (m === 'activity') loadCourses();
            if (m === 'member') { loadFamilyMembers(); loadHistoryRecords(); }
            if (m === 'admin') AdminService.switchModule('dashboard');
        }

        function switchView(v) {
            if (state.currentView === v) return;
            document.querySelectorAll('.section-view').forEach(el => el.classList.remove('active'));
            const target = document.getElementById('view-' + v);
            if (target) {
                target.classList.add('active');
                state.currentView = v;
                if (document.body.style.overflow === 'auto') window.scrollTo(0, 0);
            }
        }

        async function loadCourses() {
            const res = await fetch(`${PROXY_URL}?action=getEvents&_t=${Date.now()}`);
            const r = await res.json();
            state.events = r.data || [];
            document.getElementById('event-list').innerHTML = state.events.map(ev => `
                <div class="content-card !p-0 overflow-hidden flex flex-col hover:shadow-lg transition-all duration-300">
                    <img src="${ev['åœ–ç‰‡URL']}" class="h-56 w-full object-cover">
                    <div class="p-8">
                        <p class="text-xs text-[#1877f2] uppercase mb-2 tracking-widest">${ev['åˆ†é¡']}</p>
                        <h3 class="text-xl mb-6 truncate">${ev['æ´»å‹•åç¨±']}</h3>
                        <button onclick="showDetail('${ev['æ´»å‹•ID']}')" class="btn-primary !py-3 !text-sm">æŸ¥çœ‹è©³æƒ…</button>
                    </div>
                </div>`).join('');
        }

        function showDetail(id) {
            const ev = state.events.find(e => String(e['æ´»å‹•ID']) === String(id));
            if(!ev) return;
            switchView('activity-detail');
            document.getElementById('detail-content-area').innerHTML = `
                <img src="${ev['åœ–ç‰‡URL']}" class="w-full h-auto max-h-[400px] object-cover">
                <div class="p-10">
                    <h2 class="text-2xl mb-8 tracking-tight">${ev['æ´»å‹•åç¨±']}</h2>
                    <div class="text-gray-700 text-lg leading-loose mb-12 whitespace-pre-wrap">${ev['æè¿°'] || 'è³‡æ–™æº–å‚™ä¸­...'}</div>
                    <button class="btn-primary shadow-xl">ç«‹å³å ±ååƒåŠ  âœ</button>
                </div>`;
        }

        async function loadFamilyMembers() {
            const res = await fetch(`${PROXY_URL}?action=getFamily&uid=${state.uid}`);
            state.members = (await res.json()).data || [];
            document.getElementById('family-grid').innerHTML = state.members.map(m => `
                <div class="content-card flex items-center gap-5 !py-4">
                    <div class="w-12 h-12 bg-[#e7f3ff] text-[#1877f2] rounded-full flex items-center justify-center text-xl italic">${m.å§“å.charAt(0)}</div>
                    <div class="flex-1"><h4 class="text-base">${m.å§“å}</h4><p class="text-sm text-gray-400">${m.ç”Ÿæ—¥}</p></div>
                </div>`).join('');
        }

        async function loadHistoryRecords() {
            const res = await fetch(`${PROXY_URL}?action=getHistory&uid=${state.uid}`);
            const r = await res.json();
            document.getElementById('history-container').innerHTML = (r.data || []).map(h => `
                <div class="content-card !py-6 border-l-4 border-[#1877f2]">
                    <h4 class="text-base truncate">${h.æ´»å‹•åç¨±}</h4>
                    <p class="text-sm text-gray-400 mt-2">å­¸å“¡ï¼š${h.å­¸å“¡å§“å}</p>
                </div>`).join('');
        }

        const AdminService = {
            switchModule(m) {
                document.getElementById('adm-content').innerHTML = `<p class="text-center py-20 text-gray-400">${m} æ¨¡çµ„é–‹ç™¼ä¸­...</p>`;
            }
        };

        window.onload = () => RegistrationFlow.init();
        function showMsg(t) { 
            const b = document.getElementById('msg-box'); b.innerText = t; b.style.display='block'; 
            setTimeout(()=>b.style.display='none', 3000); 
        }
    </script>
</body>
</html>
